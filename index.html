<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Junaid Abid - Portfolio (Maximized & Secure)</title>
    <meta
      name="description"
      content="Portfolio of Muhammad Junaid Abid - Project & Product Manager"
    />

    <!-- External Libraries -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link
      href="https://cdn.quilljs.com/1.3.6/quill.snow.css"
      rel="stylesheet"
    />
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Fira+Code:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              cyan: { 400: "#06b6d4", 500: "#06b6d4", 600: "#0891b2" },
              slate: { 850: "#151f32", 900: "#0f172a" },
              primary: "#06b6d4",
              secondary: "#a855f7",
              accent: "#10b981",
              bg: "#0f172a",
              "bg-secondary": "#1e293b",
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
              mono: ["Fira Code", "monospace"],
              inter: ["Inter", "sans-serif"],
              fira: ["Fira Code", "monospace"],
            },
          },
        },
      };
    </script>

    <style>
      :root {
        --primary-color: #06b6d4;
        --primary-rgb: 6, 182, 212;
        --secondary-color: #a855f7;
        --secondary-rgb: 168, 85, 247;
        --accent-color: #10b981;
        --accent-rgb: 16, 185, 129;
        --bg-color: #0f172a;
        --bg-secondary: #1e293b;
        --glow-intensity: 1;
        --animation-speed: 1;
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      /* PATCH: Safe cursor overrides for Admin/Edit modes & Modals */
      body.admin-mode *,
      body.admin-mode *::before,
      body.admin-mode *::after,
      .modal-content *,
      .modal-content *::before,
      .modal-content *::after,
      .settings-panel *,
      .settings-panel *::before,
      .settings-panel *::after,
      input,
      textarea,
      select,
      .cursor-auto,
      .image-tools-canvas,
      .image-tools-canvas * {
        cursor: auto !important;
      }
      
      /* === OPTIMIZED CURSOR SETTINGS === */
      
      /* 1. VISITOR MODE: Hide system cursor, show custom dots */
      body:not(.admin-mode) {
        cursor: none;
      }
      
      /* 2. ADMIN MODE: FORCE System Cursor, HIDE custom dots */
      body.admin-mode {
        cursor: auto !important;
      }
      body.admin-mode *, 
      body.admin-mode a, 
      body.admin-mode button, 
      body.admin-mode input, 
      body.admin-mode textarea {
        cursor: auto !important;
      }
      
      /* Hide the laggy HTML divs in admin mode */
      body.admin-mode #cursor-dot, 
      body.admin-mode #cursor-outline, 
      body.admin-mode .cursor-trail {
        display: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
      }

      /* 3. TEXT & INPUTS (Always show I-Beam) */
      input, textarea, [contenteditable], .ql-editor {
        cursor: text !important;
      }
      
      /* 4. VIDEO EXCEPTION */
      video { cursor: none !important; }
      .video-container:hover video { cursor: default !important; }
      video:fullscreen { cursor: none !important; }

      /* === AUTO-EXPANDING SKILL CARDS (Final Fix) === */
      .skill-card-3d {
        min-width: 140px;          /* Minimum width */
        max-width: 220px;          /* Maximum width before wrapping */
        width: auto;               /* Allows width to adjust */
        height: auto;              /* ALLOWS HEIGHT TO GROW */
        
        display: inline-flex;      
        margin: 10px;              
        perspective: 1000px;
        cursor: pointer;
        vertical-align: top;
      }

      .skill-inner {
        display: grid;             /* GRID STACK: The magic fix */
        grid-template-areas: "stack"; 
        width: 100%;
        height: 100%;
        transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1);
        transform-style: preserve-3d;
      }

      .skill-card-3d.flipped .skill-inner {
        transform: rotateY(180deg);
      }

      .skill-front, .skill-back {
        grid-area: stack;          /* Stacks both faces on top of each other */
        position: relative;        /* Keeps them in the document flow so size is calculated */
        width: 100%;
        min-height: 110px;         /* Minimum height for consistency */
        
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 15px;             
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      }

      .skill-front {
        background: rgba(30, 41, 59, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--primary-color);
        z-index: 2;
        font-weight: 700;
        font-size: 1.1rem;
        text-align: center;
      }

      .skill-back {
        transform: rotateY(180deg);
        background: var(--bg-secondary);
        border: 1px solid var(--primary-color);
        color: #e2e8f0;
        z-index: 1;
        font-size: 0.85rem;
        line-height: 1.5;
        text-align: center;
        word-wrap: break-word;     /* Ensures long words don't break layout */
      }

      .skill-card-3d:hover {
        transform: translateY(-5px);
        z-index: 10;
      }

      /* Edit Buttons */
      .card-edit-btn {
        position: absolute;
        bottom: 5px;
        right: 5px;
        background: rgba(0, 0, 0, 0.6);
        color: #fff;
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 4px;
        font-size: 9px;
        padding: 2px 6px;
        cursor: pointer !important;
        z-index: 100;
        opacity: 0.6;
      }
      .card-edit-btn:hover {
        opacity: 1;
        background: var(--primary-color);
      }
      .delete-btn-card {
        position: absolute;
        top: -6px;
        right: -6px;
        width: 22px;
        height: 22px;
        background: #ef4444;
        color: white;
        border-radius: 50%;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 101;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        cursor: pointer !important;
      }

      /* 5. VIDEO EXCEPTION: Hide cursor only when watching video */
      video {
        cursor: none !important;
      }
      /* But show it if we hover over the video container to pause/edit */
      .video-container:hover video {
        cursor: default !important;
      }

      /* PATCH: Ensure video fullscreen hides cursor properly */
      video:fullscreen {
        cursor: none !important;
      }

      html {
        scroll-behavior: smooth;
      }

      body {
        background: radial-gradient(
          circle at 50% 50%,
          #0f172a 0%,
          #020617 100%
        );
        background-color: var(--bg-color);
        color: white;
        overflow-x: hidden;
        font-family: "Inter", sans-serif;
        min-height: 100vh;
      }

      /* FLUID LAYER CSS */
      #fluid-layer {
        position: fixed;
        inset: 0;
        z-index: 0; /* Behind content */
        mix-blend-mode: screen;
        opacity: 1;
        pointer-events: none;
      }

      ::selection {
        background: var(--primary-color);
        color: white;
      }

      .glass {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .glass-strong {
        background: rgba(15, 23, 42, 0.95);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(20px);
      }

      /* Custom Cursor - Highest Z-Index Fix */
      #cursor-dot,
      #cursor-outline {
        position: fixed;
        top: 0;
        left: 0;
        transform: translate(-50%, -50%);
        border-radius: 50%;
        z-index: 2147483647; /* Maximum possible z-index */
        pointer-events: none;
        will-change: transform, width, height;
        transition: opacity 0.3s;
      }
      #cursor-dot {
        width: 10px;
        height: 10px;
        background: var(--primary-color);
        box-shadow: 0 0 20px var(--primary-color), 0 0 40px var(--primary-color);
        mix-blend-mode: screen;
      }
      #cursor-outline {
        width: 45px;
        height: 45px;
        border: 2px solid var(--primary-color);
        transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        opacity: 0.6;
      }
      #cursor-outline.hover {
        width: 70px;
        height: 70px;
        background: rgba(var(--primary-rgb), 0.15);
        border-width: 3px;
        opacity: 1;
      }
      #cursor-outline.resize-cursor {
        width: 30px;
        height: 30px;
        border-color: var(--secondary-color);
        border-radius: 5px;
        background: rgba(var(--secondary-rgb), 0.2);
      }
      #cursor-outline.clicking {
        width: 35px;
        height: 35px;
        background: rgba(var(--primary-rgb), 0.4);
      }
      #cursor-outline.text-hover {
        width: 4px;
        height: 35px;
        border-radius: 2px;
        border: none;
        background: var(--primary-color);
      }

      .cursor-trail {
        position: fixed;
        width: 6px;
        height: 6px;
        background: var(--primary-color);
        border-radius: 50%;
        pointer-events: none;
        z-index: 2147483646;
        opacity: 0.5;
        animation: trailFade 0.6s ease-out forwards;
      }

      @keyframes trailFade {
        to {
          opacity: 0;
          transform: scale(0);
        }
      }

      /* Magnetic Effect for Buttons */
      .magnetic-btn {
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }

      /* Editable Styles - Admin Only */
      .editable-highlight {
        position: relative;
        border: 2px dashed rgba(var(--primary-rgb), 0.6);
        padding: 8px;
        border-radius: 10px;
        transition: all 0.3s ease;
        background: rgba(var(--primary-rgb), 0.03);
        z-index: 20;
      }
      .editable-highlight:hover {
        background: rgba(var(--primary-rgb), 0.12);
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(var(--primary-rgb), 0.2);
      }
      .editable-highlight::after {
        content: "✏️ Edit";
        position: absolute;
        top: -25px;
        right: 0;
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        color: white;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 10px;
        font-weight: 700;
        opacity: 0;
        transform: translateY(5px);
        transition: all 0.3s ease;
        pointer-events: none;
        white-space: nowrap;
        box-shadow: 0 4px 15px rgba(var(--primary-rgb), 0.4);
      }
      .editable-highlight:hover::after {
        opacity: 1;
        transform: translateY(0);
      }

      /* Media Editable */
      .media-editable {
        position: relative;
        overflow: visible;
        border-radius: 12px;
      }
      .media-editable:hover .media-overlay {
        opacity: 1;
      }
      .media-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(
          135deg,
          rgba(0, 0, 0, 0.85),
          rgba(0, 0, 0, 0.7)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        opacity: 0;
        transition: opacity 0.3s ease;
        border-radius: inherit;
        z-index: 30;
      }
      .media-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        cursor: pointer !important;
      }
      .media-btn:hover {
        transform: scale(1.2) rotate(5deg);
        box-shadow: 0 0 25px currentColor;
      }

      /* DRAGGABLE RESIZABLE CANVAS ITEMS */
      .draggable-canvas-container {
        position: relative;
        width: 100%;
        min-height: 200px;
        overflow: hidden;
        border: 1px dashed rgba(255, 255, 255, 0.1);
        background: rgba(0, 0, 0, 0.2);
        border-radius: 20px;
      }

      .draggable-item-wrapper {
        position: absolute;
        user-select: none;
        cursor: grab !important;
        z-index: 10;
      }
      .draggable-item-wrapper:active {
        cursor: grabbing !important;
      }
      .draggable-item-wrapper.selected {
        z-index: 20;
        outline: 2px dashed var(--primary-color);
      }

      .resize-handle {
        width: 12px;
        height: 12px;
        background: var(--secondary-color);
        border: 2px solid white;
        position: absolute;
        bottom: -6px;
        right: -6px;
        cursor: se-resize !important;
        border-radius: 50%;
        z-index: 30;
        opacity: 0;
        transition: opacity 0.2s;
      }
      .draggable-item-wrapper:hover .resize-handle,
      .draggable-item-wrapper.selected .resize-handle {
        opacity: 1;
      }

      .custom-tooltip {
        position: absolute;
        bottom: 110%;
        left: 50%;
        transform: translateX(-50%);
        background: var(--bg-secondary);
        color: white;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        transition: all 0.3s;
        pointer-events: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .draggable-item-wrapper:hover .custom-tooltip {
        opacity: 1;
        bottom: 120%;
      }

      /* Text Glow */
      .text-glow {
        text-shadow: 0 0 10px rgba(var(--primary-rgb), 0.3),
          0 0 30px rgba(var(--primary-rgb), 0.2),
          0 0 50px rgba(var(--primary-rgb), 0.1);
      }

      .text-gradient {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      /* Glow Effects */
      .shadow-glow {
        box-shadow: 0 0 20px rgba(var(--primary-rgb), 0.3),
          0 10px 40px rgba(var(--primary-rgb), 0.2);
      }

      .shadow-glow-hover:hover {
        box-shadow: 0 0 30px rgba(var(--primary-rgb), 0.5),
          0 15px 50px rgba(var(--primary-rgb), 0.3);
      }

      /* Stars Background */
      .stars {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 0;
      }

      .star {
        position: absolute;
        background: white;
        border-radius: 50%;
        animation: twinkle calc(2s / var(--animation-speed)) infinite
          ease-in-out;
      }

      @keyframes twinkle {
        0%,
        100% {
          opacity: 0.2;
          transform: scale(0.8);
        }
        50% {
          opacity: 1;
          transform: scale(1.2);
        }
      }

      .nebula {
        position: fixed;
        border-radius: 50%;
        filter: blur(100px);
        opacity: calc(0.12 * var(--glow-intensity));
        pointer-events: none;
        z-index: 0;
        animation: nebulaPulse 8s ease-in-out infinite;
      }

      @keyframes nebulaPulse {
        0%,
        100% {
          transform: scale(1);
          opacity: calc(0.12 * var(--glow-intensity));
        }
        50% {
          transform: scale(1.1);
          opacity: calc(0.18 * var(--glow-intensity));
        }
      }

      .shooting-star {
        position: fixed;
        height: 2px;
        background: linear-gradient(90deg, white, transparent);
        animation: shoot calc(0.8s / var(--animation-speed)) linear forwards;
        z-index: 0;
        pointer-events: none;
        border-radius: 100px;
      }

      @keyframes shoot {
        from {
          transform: translateX(0) translateY(0);
          opacity: 1;
        }
        to {
          transform: translateX(-400px) translateY(400px);
          opacity: 0;
        }
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 10px;
      }
      ::-webkit-scrollbar-track {
        background: var(--bg-color);
      }
      ::-webkit-scrollbar-thumb {
        background: linear-gradient(
          var(--primary-color),
          var(--secondary-color)
        );
        border-radius: 5px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--primary-color);
      }

      /* Projects Grid */
      .projects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
        gap: 2rem;
      }

      /* Settings Panel */
      .settings-wheel {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
      }

      .settings-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          rgba(30, 41, 59, 0.95),
          rgba(15, 23, 42, 0.95)
        );
        border: 2px solid rgba(var(--primary-rgb), 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3),
          0 0 30px rgba(var(--primary-rgb), 0.2);
        cursor: pointer !important;
      }

      .settings-btn:hover {
        transform: rotate(180deg) scale(1.1);
        border-color: var(--primary-color);
        box-shadow: 0 5px 35px rgba(var(--primary-rgb), 0.5);
      }

      .settings-panel {
        position: absolute;
        bottom: 75px;
        right: 0;
        width: 380px;
        max-height: 85vh;
        overflow-y: auto;
        padding: 24px;
        border-radius: 24px;
        transform-origin: bottom right;
        border: 1px solid rgba(var(--primary-rgb), 0.2);
        z-index: 1001;
      }

      /* === DROPDOWN MENU STYLES === */
      .nav-item {
        position: relative;
        height: 100%;
        display: flex;
        align-items: center;
      }
      
      .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%) translateY(10px);
        background: rgba(15, 23, 42, 0.95);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 8px;
        min-width: 180px;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        z-index: 100;
      }

      .nav-item:hover .dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(0);
      }

      .dropdown-item {
        display: block;
        padding: 10px 16px;
        color: #94a3b8;
        font-size: 13px;
        border-radius: 8px;
        transition: all 0.2s;
        text-decoration: none;
        white-space: nowrap;
      }

      .dropdown-item:hover {
        background: rgba(255, 255, 255, 0.05);
        color: white;
        transform: translateX(5px);
      }
      
      /* Mobile Submenu Indentation */
      .mobile-sub-link {
        font-size: 18px !important;
        opacity: 0.7;
        margin-top: -10px;
      }

      /* Mobile Menu */
      @media (max-width: 768px) {
        .mobile-menu {
          position: fixed;
          inset: 0;
          background: rgba(15, 23, 42, 0.98);
          backdrop-filter: blur(20px);
          z-index: 100;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          gap: 2.5rem;
        }
        .projects-grid {
          grid-template-columns: 1fr;
        }
        .floating-admin-panel {
          display: none !important;
        }
      }

      /* Modal */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.92);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
        backdrop-filter: blur(5px);
      }

      .modal-content {
        max-width: 950px;
        width: 100%;
        max-height: 92vh;
        overflow-y: auto;
        border-radius: 28px;
        border: 1px solid rgba(var(--primary-rgb), 0.15);
      }

      /* Image Gallery */
      .image-gallery {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }

      .image-gallery img,
      .image-gallery video {
        width: 100%;
        height: 130px;
        object-fit: cover;
        border-radius: 14px;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        border: 2px solid transparent;
      }

      .image-gallery img:hover,
      .image-gallery video:hover {
        transform: scale(1.08) rotate(1deg);
        border-color: var(--primary-color);
        box-shadow: 0 10px 30px rgba(var(--primary-rgb), 0.3);
      }

      /* Tags */
      .skill-tag {
        background: linear-gradient(
          135deg,
          rgba(var(--primary-rgb), 0.2),
          rgba(var(--primary-rgb), 0.1)
        );
        color: var(--primary-color);
        border: 1px solid rgba(var(--primary-rgb), 0.35);
        transition: all 0.3s ease;
      }
      .skill-tag:hover {
        background: rgba(var(--primary-rgb), 0.3);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(var(--primary-rgb), 0.3);
      }

      .tool-tag {
        background: linear-gradient(
          135deg,
          rgba(var(--secondary-rgb), 0.2),
          rgba(var(--secondary-rgb), 0.1)
        );
        color: var(--secondary-color);
        border: 1px solid rgba(var(--secondary-rgb), 0.35);
      }
      .tool-tag:hover {
        background: rgba(var(--secondary-rgb), 0.3);
        transform: translateY(-2px);
      }

      /* Profile Image */
      .profile-image-container {
        position: relative;
      }
      .profile-image-container:hover .profile-overlay {
        opacity: 1;
      }
      .profile-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 12px;
        opacity: 0;
        transition: all 0.4s ease;
        border-radius: 50%;
      }

      /* Upload Zone */
      .upload-zone {
        border: 3px dashed rgba(var(--primary-rgb), 0.4);
        border-radius: 20px;
        padding: 45px;
        text-align: center;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        background: rgba(var(--primary-rgb), 0.03);
        cursor: pointer !important;
      }
      .upload-zone:hover,
      .upload-zone.dragover {
        border-color: var(--primary-color);
        background: rgba(var(--primary-rgb), 0.1);
        transform: scale(1.02);
        box-shadow: 0 0 40px rgba(var(--primary-rgb), 0.2);
      }

      /* Media Grid */
      .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 18px;
        margin-top: 24px;
      }

      .media-item {
        position: relative;
        border-radius: 16px;
        overflow: hidden;
        aspect-ratio: 16/10;
        border: 2px solid transparent;
        transition: all 0.3s ease;
      }
      .media-item:hover {
        border-color: var(--primary-color);
        transform: translateY(-4px);
      }

      .media-item img,
      .media-item video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* Toast */
      .toast {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%) translateY(120px);
        padding: 18px 36px;
        border-radius: 50px;
        font-weight: 600;
        z-index: 100001;
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
      .toast.success {
        background: linear-gradient(135deg, #10b981, #059669);
      }
      .toast.error {
        background: linear-gradient(135deg, #ef4444, #dc2626);
      }
      .toast.info {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
      }
      .toast.warning {
        background: linear-gradient(135deg, #f59e0b, #d97706);
      }

      /* Buttons */
      .add-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 16px 28px;
        border: 2px dashed rgba(var(--primary-rgb), 0.5);
        border-radius: 16px;
        color: var(--primary-color);
        font-weight: 700;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        background: rgba(var(--primary-rgb), 0.05);
        cursor: pointer !important;
      }
      .add-btn:hover {
        border-style: solid;
        background: rgba(var(--primary-rgb), 0.15);
        transform: scale(1.02);
        box-shadow: 0 10px 30px rgba(var(--primary-rgb), 0.2);
      }

      .delete-btn {
        position: absolute;
        top: -10px;
        right: -10px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        z-index: 50;
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.5);
        cursor: pointer !important;
      }
      .editable-highlight:hover .delete-btn,
      .group:hover .delete-btn {
        opacity: 1;
      }
      .delete-btn:hover {
        transform: scale(1.25) rotate(90deg);
      }

      /* Video Hover Play */
      .video-container {
        position: relative;
        border-radius: 16px;
        overflow: hidden;
        transition: all 0.4s ease;
      }
      .video-container:hover {
        transform: scale(1.01);
        box-shadow: 0 15px 50px rgba(var(--primary-rgb), 0.3);
      }
      .video-play-icon {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.4);
        transition: all 0.3s ease;
      }
      .video-container:hover .video-play-icon {
        background: rgba(0, 0, 0, 0.2);
      }
      .video-play-icon span {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        transition: all 0.3s ease;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
      }
      .video-container:hover .video-play-icon span {
        transform: scale(1.1);
      }

      /* Floating Admin Panel */
      .floating-admin-panel {
        position: fixed;
        left: 24px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 999;
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .fab-btn {
        width: 52px;
        height: 52px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
        cursor: pointer !important;
      }
      .fab-btn::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        opacity: 0;
        transition: opacity 0.3s;
      }
      .fab-btn:hover::before {
        opacity: 1;
      }
      .fab-btn:hover {
        transform: scale(1.15) translateX(5px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
      }
      .fab-btn[data-tooltip]:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        left: 65px;
        background: var(--bg-secondary);
        color: white;
        padding: 8px 14px;
        border-radius: 8px;
        font-size: 12px;
        white-space: nowrap;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }

      /* Particle Effects */
      .particle {
        position: fixed;
        pointer-events: none;
        z-index: 99997;
        border-radius: 50%;
      }

      @keyframes particleFloat {
        0% {
          transform: translate(0, 0) scale(1);
          opacity: 1;
        }
        100% {
          transform: translate(var(--tx), var(--ty)) scale(0);
          opacity: 0;
        }
      }

      /* Color Swatches */
      .color-swatch {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 3px solid transparent;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
        cursor: pointer !important;
      }
      .color-swatch:hover,
      .color-swatch.active {
        transform: scale(1.25);
        border-color: white;
        box-shadow: 0 0 20px currentColor;
      }
      .color-swatch.active::after {
        content: "✓";
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
      }

      /* Typing Animation */
      .typing-animation {
        overflow: hidden;
        border-right: 3px solid var(--primary-color);
        white-space: nowrap;
        animation: typing 3s steps(40) forwards, blink 0.7s step-end infinite;
      }
      @keyframes typing {
        from {
          width: 0;
        }
        to {
          width: 100%;
        }
      }
      @keyframes blink {
        50% {
          border-color: transparent;
        }
      }

      /* Reveal Animation */
      .reveal {
        opacity: 0;
        transform: translateY(30px);
        transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .reveal.active {
        opacity: 1;
        transform: translateY(0);
      }

      /* Hover Card Tilt */
      .tilt-card {
        transform-style: preserve-3d;
        transition: transform 0.3s ease;
      }

      /* Social Links */
      .social-link {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        background: rgba(var(--primary-rgb), 0.1);
        border: 2px solid rgba(var(--primary-rgb), 0.3);
        text-decoration: none;
        color: white;
        position: relative;
        z-index: 10;
        cursor: pointer !important;
      }
      .social-link:hover {
        background: var(--primary-color);
        transform: translateY(-5px) scale(1.1);
        box-shadow: 0 10px 30px rgba(var(--primary-rgb), 0.4);
      }

      /* Progress Bar Animation */
      .progress-bar {
        height: 6px;
        background: linear-gradient(
          90deg,
          var(--primary-color),
          var(--secondary-color)
        );
        border-radius: 3px;
        transform-origin: left;
        animation: progressFill 1.5s ease-out forwards;
      }
      @keyframes progressFill {
        from {
          transform: scaleX(0);
        }
        to {
          transform: scaleX(1);
        }
      }

      /* Surprise Animations */
      @keyframes float {
        0%,
        100% {
          transform: translateY(0) rotate(0deg);
        }
        50% {
          transform: translateY(-15px) rotate(3deg);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      @keyframes shimmer {
        0% {
          background-position: -200% 0;
        }
        100% {
          background-position: 200% 0;
        }
      }

      .shimmer-text {
        background: linear-gradient(
          90deg,
          var(--primary-color),
          var(--secondary-color),
          var(--primary-color)
        );
        background-size: 200% auto;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shimmer 3s linear infinite;
      }

      .float-animation {
        animation: float 4s ease-in-out infinite;
      }

      .pulse-animation {
        animation: pulse 2s ease-in-out infinite;
      }

      /* Electric Button (New Contact Section) */
      .btn-electric {
        background: linear-gradient(
          90deg,
          var(--primary-color),
          var(--secondary-color)
        );
        transition: all 0.3s;
        cursor: pointer !important;
      }
      .btn-electric:hover {
        box-shadow: 0 0 20px var(--primary-color);
        transform: translateY(-2px);
      }

      /* Social Icon Hover (New Contact Section) */
      .social-icon-btn {
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        position: relative;
        z-index: 10;
        cursor: pointer !important;
      }
      .social-icon-btn:hover {
        transform: translateY(-5px) scale(1.1);
        color: var(--primary-color);
        box-shadow: 0 10px 20px -10px var(--primary-color);
      }

      /* Tab Buttons in Settings */
      .tab-btn {
        flex: 1;
        padding: 8px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #94a3b8;
        border-bottom: 2px solid transparent;
        transition: all 0.3s;
        cursor: pointer !important;
      }
      .tab-btn:hover {
        color: white;
      }
      .tab-btn.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
        background: rgba(var(--primary-rgb), 0.1);
      }

      /* Settings Controls */
      .color-picker-wrapper {
        position: relative;
        width: 100%;
        height: 32px;
        border-radius: 6px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .color-picker-wrapper input {
        width: 100%;
        height: 100%;
        border: none;
        background: transparent;
        padding: 0;
        cursor: pointer;
      }

      .slider-container {
        margin: 12px 0;
      }
      .slider-container input[type="range"] {
        width: 100%;
        height: 4px;
        border-radius: 2px;
        background: rgba(255, 255, 255, 0.1);
        outline: none;
        -webkit-appearance: none;
      }
      .slider-container input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: var(--primary-color);
        box-shadow: 0 0 10px var(--primary-color);
        cursor: pointer;
        transition: transform 0.2s;
        margin-top: -5px;
      }
      .slider-container input[type="range"]::-webkit-slider-runnable-track {
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
      }

      /* Edit overlay for icons */
      .icon-edit-overlay {
        position: absolute;
        top: -10px;
        right: -10px;
        background: red;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        cursor: pointer;
        z-index: 20;
      }

      .icon-edit-mode {
        border: 2px dashed var(--primary-color);
      }

      /* Image Tools Modal Styles */
      .image-tools-canvas {
        border: 2px dashed rgba(255, 255, 255, 0.2);
        background: rgba(0, 0, 0, 0.2);
        position: relative;
        overflow: hidden;
        cursor: move;
      }
      .image-tools-controls {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }

      /* Proficiency Bar Animation */
      .proficiency-bar {
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        overflow: hidden;
        position: relative;
      }
      .proficiency-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--primary-color),
          var(--secondary-color)
        );
        width: 0;
        transition: width 1s ease-out;
      }
      .group:hover .proficiency-fill {
        width: var(--percent);
      }

      /* Language Bar Reveal Animation (New) */
      .lang-bar-container .proficiency-fill {
        width: 0 !important;
        opacity: 0;
        transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease;
      }
      .lang-bar-container:hover .proficiency-fill,
      .lang-bar-container:active .proficiency-fill {
        width: var(--percent) !important;
        opacity: 1;
      }

      /* Lightbox */
      .lightbox-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 20000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        animation: fadeIn 0.3s forwards;
      }
      .lightbox-img {
        max-width: 95vw;
        max-height: 95vh;
        border-radius: 8px;
        box-shadow: 0 0 50px rgba(var(--primary-rgb), 0.3);
        transform: scale(0.9);
        animation: scaleUp 0.3s forwards;
      }
      @keyframes fadeIn {
        to {
          opacity: 1;
        }
      }
      @keyframes scaleUp {
        to {
          transform: scale(1);
        }
      }

      /* Hover Pop-out */
      .hover-pop {
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      .hover-pop:hover {
        transform: scale(1.05) translateY(-5px);
        z-index: 10;
      }

      /* PATCH: Ensure cursor is visible during Image Tools */
      .image-tools-canvas,
      .image-tools-canvas * {
        cursor: crosshair !important;
      }
      .admin-mode button,
      .admin-mode .editable-highlight {
        cursor: pointer !important;
      }
      /* === START IMAGE EDITOR CSS === */
      .image-editor-canvas-container {
        overflow: hidden;
        background: #111;
        position: relative;
        cursor: grab;
        display: flex;
        align-items: center;
        justify-content: center;
        touch-action: none; /* Prevents scrolling on mobile while cropping */
      }
      .image-editor-canvas-container:active {
        cursor: grabbing;
      }
      /* === END IMAGE EDITOR CSS === */
      /* === QUILL EDITOR MOBILE FIXES === */
      .ql-toolbar {
        background: #f1f5f9; /* Light gray toolbar */
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
      }
      .ql-container {
        background: #ffffff; /* White writing area */
        color: #000000; /* Black text */
        font-size: 16px; /* Readable on mobile */
        border-bottom-left-radius: 12px;
        border-bottom-right-radius: 12px;
        min-height: 200px;
      }
      /* Fix toolbar wrapping on small phones */
      .ql-toolbar .ql-formats {
        margin-right: 5px !important;
      }
      /* === FIX FOR INVISIBLE FORMATTING & EDITOR Z-INDEX === */
      /* 1. Make formatting visible */
      .ql-editor ul, ul { list-style-type: disc !important; padding-left: 1.5rem !important; }
      .ql-editor ol, ol { list-style-type: decimal !important; padding-left: 1.5rem !important; }
      .ql-editor strong, strong, b { font-weight: 800 !important; }
      
      /* 2. FORCE Edit Window to be on top of EVERYTHING */
      .edit-modal-wrapper {
        position: fixed;
        inset: 0;
        z-index: 2147483647 !important; /* Maximum Z-Index possible */
        background: rgba(0,0,0,0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(8px);
        padding: 20px;
      }
      
      /* 3. Mobile Editor Fixes */
      .ql-toolbar {
        background: #f1f5f9;
        border-radius: 12px 12px 0 0;
        position: sticky;
        top: 0;
        z-index: 10;
      }
      .ql-container {
        background: white;
        color: black;
        font-size: 16px; /* Prevents zooming on iPhone */
        min-height: 200px;
        max-height: 50vh;
        overflow-y: auto;
        border-radius: 0 0 12px 12px;
      }

      /* === FINAL NUCLEAR CURSOR FIX === */
      
      /* 1. VISITOR: Hide mouse so custom dot works */
      body:not(.admin-mode) {
        cursor: none;
      }

      /* 2. ADMIN: FORCE System Mouse everywhere */
      body.admin-mode,
      body.admin-mode *,
      body.admin-mode input,
      body.admin-mode textarea,
      body.admin-mode button,
      body.admin-mode a {
        cursor: auto !important;
        pointer-events: auto !important;
      }

      /* 3. ADMIN: Hide the laggy custom dots */
      body.admin-mode #cursor-dot,
      body.admin-mode #cursor-outline,
      body.admin-mode .cursor-trail {
        display: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
      }

      /* 4. BUTTONS (Force Hand) */
      body.admin-mode button, 
      body.admin-mode a, 
      body.admin-mode .fab-btn, 
      body.admin-mode .clickable {
        cursor: pointer !important;
      }

      /* 5. REMOVE LAGGY ELEMENTS */
      /* Physically hide the custom cursor elements in admin mode */
      body.admin-mode #cursor-dot, 
      body.admin-mode #cursor-outline, 
      body.admin-mode .cursor-trail {
        display: none !important;
      }

      /* 2. SIDE PANEL FIX: Icons visible, Text slides out */
      .floating-admin-panel {
        position: fixed;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 15px;
        pointer-events: none; /* Let clicks pass through the empty space */
      }

      .fab-btn {
        pointer-events: auto; /* Re-enable clicks on buttons */
        width: 50px;          /* Default width (Icon only) */
        height: 50px;
        border-radius: 25px;  /* Circle shape */
        display: flex;
        align-items: center;
        justify-content: flex-start; /* Align icon left */
        padding: 0 16px;      /* Space for icon */
        overflow: hidden;     /* Hides text label by default */
        transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        white-space: nowrap;  /* Prevents text wrapping */
        position: relative;
      }

      /* EXPAND ON HOVER */
      .fab-btn:hover {
        width: 200px;         /* Expands to show text */
        background: var(--bg-secondary);
        border-color: var(--primary-color);
        box-shadow: 0 0 20px rgba(6, 182, 212, 0.4);
      }

      .fab-btn .icon {
        font-size: 20px;
        min-width: 20px;      /* Ensures icon stays fixed size */
        text-align: center;
        margin-right: 15px;
      }

      .fab-label {
        opacity: 0;           /* Hidden by default */
        transform: translateX(20px);
        transition: opacity 0.3s ease, transform 0.3s ease;
        font-weight: 600;
        font-size: 14px;
      }

      /* REVEAL LABEL ON HOVER */
      .fab-btn:hover .fab-label {
        opacity: 1;
        transform: translateX(0);
        transition-delay: 0.1s; /* Slight delay so it appears smoothly */
      }

      /* 3. Project Appreciation Heart */
      .heart-btn {
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      .heart-btn:active {
        transform: scale(1.5);
      }
      .heart-btn.liked {
        color: #ef4444; /* Red */
        text-shadow: 0 0 20px #ef4444;
      }

      /* 4. Visitor Counter (Odometer Style) */
      .counter-wrapper {
        display: inline-flex;
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(255,255,255,0.1);
        padding: 15px 25px;
        border-radius: 16px;
        backdrop-filter: blur(10px);
        margin-bottom: 30px;
        gap: 20px;
      }
      .stat-item {
        text-align: center;
      }
      .stat-label {
        font-size: 12px;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 5px;
      }
      .odometer {
        display: inline-flex;
        font-family: 'Fira Code', monospace;
        font-weight: 900;
        font-size: 28px;
        line-height: 1;
        overflow: hidden;
        height: 28px; 
      }
      .digit-column {
        display: flex;
        flex-direction: column;
        transition: transform 1s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      .digit-column span {
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* === NEW 3D HUD DASHBOARD STYLES === */

      @keyframes beat {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.3); }
      }
      .animate-beat {
        animation: beat 0.6s infinite;
      }

      .hud-container {
        perspective: 1000px;
        padding: 20px;
        width: 100%;
        max-width: 900px;
        margin: 0 auto;
      }

      .hud-panel {
        background: rgba(15, 23, 42, 0.65);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-top: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 
          0 20px 50px rgba(0,0,0,0.5),
          0 0 0 1px rgba(var(--primary-rgb), 0.2),
          inset 0 0 20px rgba(var(--primary-rgb), 0.1);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border-radius: 24px;
        padding: 30px;
        transform: rotateX(5deg) translateY(0);
        transition: all 0.5s ease;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        position: relative;
        overflow: hidden;
      }
      
      /* Mobile adjustment */
      @media (min-width: 768px) {
        .hud-panel {
          grid-template-columns: repeat(4, 1fr);
          transform: rotateX(10deg) translateY(0);
        }
        .hud-panel:hover {
          transform: rotateX(0deg) translateY(-5px) scale(1.02);
          box-shadow: 
            0 30px 60px rgba(0,0,0,0.6),
            0 0 30px rgba(var(--primary-rgb), 0.4);
        }
      }

      .hud-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        padding: 10px;
        border-radius: 12px;
        background: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0) 100%);
        border: 1px solid rgba(255,255,255,0.05);
      }

      .hud-label {
        font-family: 'Fira Code', monospace;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: rgba(255,255,255,0.5);
        margin-bottom: 8px;
        font-weight: 700;
      }

      .hud-value-container {
        font-family: 'Fira Code', monospace;
        font-size: 24px;
        font-weight: 800;
        text-shadow: 0 0 10px currentColor;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      /* Glowing scanline effect */
      .hud-panel::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
        opacity: 0.5;
        animation: scanline 4s linear infinite;
      }

      @keyframes scanline {
        0% { transform: translateY(-100%); opacity: 0; }
        10% { opacity: 1; }
        100% { transform: translateY(500px); opacity: 0; }
      }

      /* === END OF CSS CODE === */

    </style>
  </head>
  <body>
    <div id="cursor-dot"></div>
    <div id="cursor-outline"></div>

    <!-- FLUID CANVAS -->
    <canvas id="fluid-layer"></canvas>

    <div id="stars-container" class="stars"></div>
    <div id="toast-container"></div>
    <div id="particle-container"></div>
    <div id="root"></div>

    <script type="text/babel">
      // --- VAULT SOURCE CODE CONSTANT ---
      const VAULT_SOURCE_CODE = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureVault - Password Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"><\/script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg { background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); }
        .card-glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .password-mask { font-family: 'Courier New', monospace; letter-spacing: 2px; }
        .strength-weak { background: #ef4444; width: 25%; }
        .strength-fair { background: #f59e0b; width: 50%; }
        .strength-good { background: #3b82f6; width: 75%; }
        .strength-strong { background: #10b981; width: 100%; }
        .category-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 9999px; }
        .modal-overlay { background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .pulse-glow { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <!-- Lock Screen -->
    <div id="lockScreen" class="fixed inset-0 flex items-center justify-center z-50 gradient-bg">
        <div class="card-glass rounded-2xl p-8 w-full max-w-md mx-4 slide-in">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4 pulse-glow">
                    <i class="fas fa-shield-alt text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold">SecureVault</h1>
                <p class="text-gray-400 mt-2">Your passwords, safely stored</p>
            </div>
            <div id="lockForm">
                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-2">Master Password</label>
                    <div class="relative">
                        <input type="password" id="masterPassword" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 transition" placeholder="Enter master password">
                        <button onclick="togglePasswordVisibility('masterPassword')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <button onclick="unlock()" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 py-3 rounded-lg font-semibold hover:opacity-90 transition">
                    <i class="fas fa-unlock mr-2"></i>Unlock Vault
                </button>
                <p id="lockError" class="text-red-400 text-sm mt-3 text-center hidden">Incorrect password</p>
                <div class="mt-6 text-center">
                    <button onclick="showRecoveryMode()" class="text-blue-400 hover:text-blue-300 text-sm">Forgot Password?</button>
                </div>
            </div>
            <div id="setupForm" class="hidden">
                <h3 class="text-xl font-bold mb-4 text-center">Setup Vault</h3>
                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-2">Create Master Password</label>
                    <input type="password" id="newMasterPassword" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 transition" placeholder="Create a strong password">
                </div>
                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-2">Confirm Password</label>
                    <input type="password" id="confirmMasterPassword" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 transition" placeholder="Confirm password">
                </div>
                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-2">Security Question (Recovery)</label>
                    <input type="text" id="securityQuestion" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 transition" placeholder="e.g. First pet's name?">
                </div>
                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-2">Security Answer</label>
                    <input type="text" id="securityAnswer" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 transition" placeholder="Your answer">
                </div>
                <button onclick="setupVault()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 py-3 rounded-lg font-semibold hover:opacity-90 transition">
                    <i class="fas fa-key mr-2"></i>Create Vault
                </button>
                <p id="setupError" class="text-red-400 text-sm mt-3 text-center hidden"></p>
                <div class="mt-6 text-center">
                    <button onclick="showLoginMode()" class="text-blue-400 hover:text-blue-300 text-sm">Already have a vault? Login</button>
                </div>
            </div>
            <div id="recoveryForm" class="hidden">
                <h3 class="text-xl font-bold mb-4 text-center">Password Recovery</h3>
                <p id="recoveryQuestionDisplay" class="text-gray-300 mb-4 text-center font-medium"></p>
                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-2">Your Answer</label>
                    <input type="text" id="recoveryAnswerInput" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 transition" placeholder="Enter answer">
                </div>
                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-2">New Master Password</label>
                    <input type="password" id="recoveryNewPass" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 transition" placeholder="New password">
                </div>
                <button onclick="performRecovery()" class="w-full bg-gradient-to-r from-yellow-500 to-orange-600 py-3 rounded-lg font-semibold hover:opacity-90 transition">
                    Reset Password
                </button>
                <p id="recoveryError" class="text-red-400 text-sm mt-3 text-center hidden"></p>
                <div class="mt-6 text-center">
                    <button onclick="showLoginMode()" class="text-blue-400 hover:text-blue-300 text-sm">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-gray-900/50 border-b border-gray-800 sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h1 class="text-xl font-bold">SecureVault</h1>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="openGeneratorModal()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-magic"></i>
                        <span class="hidden sm:inline">Generate</span>
                    </button>
                    <button onclick="openAddModal()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-plus"></i>
                        <span class="hidden sm:inline">Add New</span>
                    </button>
                    <div class="relative">
                        <button onclick="toggleMenu()" class="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center hover:bg-gray-700 transition">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div id="dropdownMenu" class="hidden absolute right-0 mt-2 w-48 bg-gray-800 rounded-lg shadow-xl border border-gray-700 py-2">
                            <button onclick="exportPasswords('json')" class="w-full px-4 py-2 text-left hover:bg-gray-700 flex items-center gap-2">
                                <i class="fas fa-file-code"></i> Export JSON
                            </button>
                            <button onclick="exportPasswords('csv')" class="w-full px-4 py-2 text-left hover:bg-gray-700 flex items-center gap-2">
                                <i class="fas fa-file-csv"></i> Export CSV
                            </button>
                            <hr class="border-gray-700 my-2">
                            <button onclick="adminResetVault()" class="w-full px-4 py-2 text-left hover:bg-gray-700 flex items-center gap-2 text-red-400">
                                <i class="fas fa-bomb"></i> Reset Vault Data
                            </button>
                            <button onclick="lockVault()" class="w-full px-4 py-2 text-left hover:bg-gray-700 flex items-center gap-2 text-red-400">
                                <i class="fas fa-lock"></i> Lock Vault
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-6">
            <!-- Search and Filter Bar -->
            <div class="card-glass rounded-xl p-4 mb-6">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1 relative">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="searchInput" onkeyup="filterPasswords()" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg pl-10 pr-4 py-2 focus:outline-none focus:border-blue-500 transition" placeholder="Search passwords...">
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="filterByCategory('all')" class="category-filter active bg-blue-600 px-4 py-2 rounded-lg text-sm transition" data-category="all">All</button>
                        <button onclick="filterByCategory('social')" class="category-filter bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm transition" data-category="social">
                            <i class="fas fa-users mr-1"></i>Social
                        </button>
                        <button onclick="filterByCategory('finance')" class="category-filter bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm transition" data-category="finance">
                            <i class="fas fa-university mr-1"></i>Finance
                        </button>
                        <button onclick="filterByCategory('work')" class="category-filter bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm transition" data-category="work">
                            <i class="fas fa-briefcase mr-1"></i>Work
                        </button>
                        <button onclick="filterByCategory('shopping')" class="category-filter bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm transition" data-category="shopping">
                            <i class="fas fa-shopping-cart mr-1"></i>Shopping
                        </button>
                        <button onclick="filterByCategory('entertainment')" class="category-filter bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm transition" data-category="entertainment">
                            <i class="fas fa-gamepad mr-1"></i>Entertainment
                        </button>
                        <button onclick="filterByCategory('other')" class="category-filter bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm transition" data-category="other">
                            <i class="fas fa-folder mr-1"></i>Other
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="card-glass rounded-xl p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-600/20 rounded-lg flex items-center justify-center">
                            <i class="fas fa-key text-blue-400"></i>
                        </div>
                        <div>
                            <p class="text-2xl font-bold" id="totalCount">0</p>
                            <p class="text-gray-400 text-sm">Total</p>
                        </div>
                    </div>
                </div>
                <div class="card-glass rounded-xl p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-green-600/20 rounded-lg flex items-center justify-center">
                            <i class="fas fa-shield-alt text-green-400"></i>
                        </div>
                        <div>
                            <p class="text-2xl font-bold" id="strongCount">0</p>
                            <p class="text-gray-400 text-sm">Strong</p>
                        </div>
                    </div>
                </div>
                <div class="card-glass rounded-xl p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-yellow-600/20 rounded-lg flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                        </div>
                        <div>
                            <p class="text-2xl font-bold" id="weakCount">0</p>
                            <p class="text-gray-400 text-sm">Weak</p>
                        </div>
                    </div>
                </div>
                <div class="card-glass rounded-xl p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-purple-600/20 rounded-lg flex items-center justify-center">
                            <i class="fas fa-folder text-purple-400"></i>
                        </div>
                        <div>
                            <p class="text-2xl font-bold" id="categoryCount">0</p>
                            <p class="text-gray-400 text-sm">Categories</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Password List -->
            <div id="passwordList" class="grid gap-4">
                <!-- Passwords will be rendered here -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden text-center py-16">
                <div class="w-24 h-24 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-lock text-4xl text-gray-600"></i>
                </div>
                <h3 class="text-xl font-semibold mb-2">No passwords yet</h3>
                <p class="text-gray-400 mb-6">Start by adding your first password</p>
                <button onclick="openAddModal()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg transition">
                    <i class="fas fa-plus mr-2"></i>Add Password
                </button>
            </div>
        </main>
    </div>

    <!-- Add/Edit Modal -->
    <div id="addModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="card-glass rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto slide-in">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 id="modalTitle" class="text-xl font-bold">Add New Password</h2>
                    <button onclick="closeAddModal()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="passwordForm" onsubmit="savePassword(event)">
                    <input type="hidden" id="editId">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Title *</label>
                            <input type="text" id="entryTitle" required class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500 transition" placeholder="e.g., Gmail Account">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Username / Email</label>
                            <input type="text" id="entryUsername" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500 transition" placeholder="username@example.com">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Password *</label>
                            <div class="relative">
                                <input type="password" id="entryPassword" required class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-2 pr-20 focus:outline-none focus:border-blue-500 transition" placeholder="Enter password">
                                <div class="absolute right-2 top-1/2 -translate-y-1/2 flex gap-1">
                                    <button type="button" onclick="togglePasswordVisibility('entryPassword')" class="p-1 text-gray-400 hover:text-white">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button type="button" onclick="generateForField()" class="p-1 text-purple-400 hover:text-purple-300">
                                        <i class="fas fa-magic"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mt-2">
                                <div class="h-1 bg-gray-700 rounded-full overflow-hidden">
                                    <div id="passwordStrengthBar" class="h-full transition-all duration-300"></div>
                                </div>
                                <p id="passwordStrengthText" class="text-xs mt-1 text-gray-400"></p>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Website URL</label>
                            <input type="url" id="entryUrl" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500 transition" placeholder="https://example.com">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Category</label>
                            <select id="entryCategory" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500 transition">
                                <option value="other">Other</option>
                                <option value="social">Social</option>
                                <option value="finance">Finance</option>
                                <option value="work">Work</option>
                                <option value="shopping">Shopping</option>
                                <option value="entertainment">Entertainment</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Notes</label>
                            <textarea id="entryNotes" rows="3" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500 transition resize-none" placeholder="Additional notes..."></textarea>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button type="button" onclick="closeAddModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded-lg transition">Cancel</button>
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 py-3 rounded-lg transition">
                            <i class="fas fa-save mr-2"></i>Save
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Password Generator Modal -->
    <div id="generatorModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="card-glass rounded-2xl w-full max-w-md slide-in">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold"><i class="fas fa-magic mr-2 text-purple-400"></i>Password Generator</h2>
                    <button onclick="closeGeneratorModal()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-4 mb-6">
                    <div class="flex items-center justify-between">
                        <code id="generatedPassword" class="text-lg font-mono text-green-400 break-all">Click Generate</code>
                        <div class="flex gap-2 ml-4">
                            <button onclick="copyGeneratedPassword()" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition" title="Copy">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button onclick="generatePassword()" class="p-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition" title="Regenerate">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-sm text-gray-400">Length: <span id="lengthValue">16</span></label>
                        </div>
                        <input type="range" id="passwordLength" min="8" max="64" value="16" oninput="updateLength()" class="w-full accent-purple-500">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="includeUpper" checked class="accent-purple-500 w-4 h-4">
                            <span class="text-sm">Uppercase (A-Z)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="includeLower" checked class="accent-purple-500 w-4 h-4">
                            <span class="text-sm">Lowercase (a-z)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="includeNumbers" checked class="accent-purple-500 w-4 h-4">
                            <span class="text-sm">Numbers (0-9)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="includeSymbols" checked class="accent-purple-500 w-4 h-4">
                            <span class="text-sm">Symbols (!@#$)</span>
                        </label>
                    </div>
                </div>
                <button onclick="generatePassword()" class="w-full mt-6 bg-gradient-to-r from-purple-500 to-pink-600 py-3 rounded-lg font-semibold hover:opacity-90 transition">
                    <i class="fas fa-magic mr-2"></i>Generate Password
                </button>
            </div>
        </div>
    </div>

    <!-- View Password Modal -->
    <div id="viewModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="card-glass rounded-2xl w-full max-w-lg slide-in">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 id="viewTitle" class="text-xl font-bold">Password Details</h2>
                    <button onclick="closeViewModal()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="viewContent" class="space-y-4">
                    <!-- Content rendered dynamically -->
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="closeViewModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded-lg transition">Close</button>
                    <button id="viewEditBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 py-3 rounded-lg transition">
                        <i class="fas fa-edit mr-2"></i>Edit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <div class="flex items-center gap-3">
            <i id="toastIcon" class="fas fa-check-circle text-green-400"></i>
            <span id="toastMessage">Password copied!</span>
        </div>
    </div>

    <script>
        // State Management
        let passwords = [];
        let currentFilter = 'all';
        let masterKey = null;

        // Category Colors
        const categoryColors = {
            social: 'bg-blue-500',
            finance: 'bg-green-500',
            work: 'bg-yellow-500',
            shopping: 'bg-pink-500',
            entertainment: 'bg-purple-500',
            other: 'bg-gray-500'
        };

        const categoryIcons = {
            social: 'fa-users',
            finance: 'fa-university',
            work: 'fa-briefcase',
            shopping: 'fa-shopping-cart',
            entertainment: 'fa-gamepad',
            other: 'fa-folder'
        };

        // Simple encryption/decryption (for demo - use proper encryption in production)
        function encrypt(text, key) {
            let result = '';
            for (let i = 0; i < text.length; i++) {
                result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
            }
            return btoa(result);
        }

        function decrypt(text, key) {
            try {
                const decoded = atob(text);
                let result = '';
                for (let i = 0; i < decoded.length; i++) {
                    result += String.fromCharCode(decoded.charCodeAt(i) ^ key.charCodeAt(i % key.length));
                }
                return result;
            } catch {
                return null;
            }
        }

        // Hash function for master password
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Lock Screen Functions
        function showSetupMode() {
            document.getElementById('lockForm').classList.add('hidden');
            document.getElementById('setupForm').classList.remove('hidden');
            document.getElementById('recoveryForm').classList.add('hidden');
        }

        function showLoginMode() {
            document.getElementById('setupForm').classList.add('hidden');
            document.getElementById('recoveryForm').classList.add('hidden');
            document.getElementById('lockForm').classList.remove('hidden');
        }

        function showRecoveryMode() {
            const question = localStorage.getItem('vaultSecurityQuestion');
            if(!question) {
                alert("No security question set. Cannot recover.");
                return;
            }
            document.getElementById('recoveryQuestionDisplay').textContent = question;
            document.getElementById('lockForm').classList.add('hidden');
            document.getElementById('recoveryForm').classList.remove('hidden');
        }

        async function setupVault() {
            const password = document.getElementById('newMasterPassword').value;
            const confirm = document.getElementById('confirmMasterPassword').value;
            const question = document.getElementById('securityQuestion').value;
            const answer = document.getElementById('securityAnswer').value;
            const errorEl = document.getElementById('setupError');

            if (password.length < 8) {
                errorEl.textContent = 'Password must be at least 8 characters';
                errorEl.classList.remove('hidden');
                return;
            }

            if (password !== confirm) {
                errorEl.textContent = 'Passwords do not match';
                errorEl.classList.remove('hidden');
                return;
            }

            if(!question || !answer) {
                 errorEl.textContent = 'Security question/answer required';
                 errorEl.classList.remove('hidden');
                 return;
            }

            const hash = await hashPassword(password);
            const answerHash = await hashPassword(answer.trim().toLowerCase());

            localStorage.setItem('vaultMasterHash', hash);
            localStorage.setItem('vaultSecurityQuestion', question);
            localStorage.setItem('vaultSecurityAnswerHash', answerHash);

            masterKey = password;
            localStorage.setItem('vaultPasswords', encrypt(JSON.stringify([]), masterKey));
            
            document.getElementById('lockScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            loadPasswords();
            showToast('Vault created successfully!', 'success');
        }

        async function performRecovery() {
            const answer = document.getElementById('recoveryAnswerInput').value;
            const newPass = document.getElementById('recoveryNewPass').value;
            const errorEl = document.getElementById('recoveryError');

            const storedAnswerHash = localStorage.getItem('vaultSecurityAnswerHash');
            const attemptHash = await hashPassword(answer.trim().toLowerCase());

            if(attemptHash !== storedAnswerHash) {
                errorEl.textContent = "Incorrect answer.";
                errorEl.classList.remove('hidden');
                return;
            }
            
            if(newPass.length < 8) {
                 errorEl.textContent = "New password must be > 8 chars.";
                 errorEl.classList.remove('hidden');
                 return;
            }

            // In a real app we would need to decrypt the old data with old key, but since we lost it...
            // Standard recovery: Reset vault (data loss) or if we had a backup key.
            // For this demo: We will reset the MASTER KEY but unfortunately this renders old data inaccessible unless we stored a backup key.
            // Since this is a simple demo, we will warn the user or just allow reset of credentials (wiping data) OR 
            // Assume the user wants to reset the credentials. 
            // BETTER: Allow reset but data is lost. 
            // OR: Since encryption is simple XOR here, we can't recover without key. 
            // LET'S ASSUME FOR THIS DEMO: We just allow login with new key and wipe old data (Reset).
            
            const newHash = await hashPassword(newPass);
            localStorage.setItem('vaultMasterHash', newHash);
            masterKey = newPass;
            
            // Wipe data to prevent corrupt decryption
            localStorage.setItem('vaultPasswords', encrypt(JSON.stringify([]), masterKey));
            
            alert("Password reset. Vault data has been cleared for security (decryption impossible without old key).");
            
            document.getElementById('recoveryForm').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            loadPasswords();
        }

        async function unlock() {
            const password = document.getElementById('masterPassword').value;
            const storedHash = localStorage.getItem('vaultMasterHash');
            const errorEl = document.getElementById('lockError');

            if (!storedHash) {
                errorEl.textContent = 'No vault found. Please create one first.';
                errorEl.classList.remove('hidden');
                return;
            }

            const hash = await hashPassword(password);
            if (hash === storedHash) {
                masterKey = password;
                document.getElementById('lockScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                loadPasswords();
            } else {
                errorEl.classList.remove('hidden');
            }
        }

        function lockVault() {
            masterKey = null;
            passwords = [];
            document.getElementById('masterPassword').value = '';
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('lockScreen').classList.remove('hidden');
            document.getElementById('dropdownMenu').classList.add('hidden');
        }
        
        function adminResetVault() {
            if(confirm("DANGER: This will permanently delete all vault data and master password. Continue?")) {
                localStorage.removeItem('vaultPasswords');
                localStorage.removeItem('vaultMasterHash');
                localStorage.removeItem('vaultSecurityQuestion');
                localStorage.removeItem('vaultSecurityAnswerHash');
                location.reload();
            }
        }

        // Password Management
        function loadPasswords() {
            const encrypted = localStorage.getItem('vaultPasswords');
            if (encrypted) {
                const decrypted = decrypt(encrypted, masterKey);
                if (decrypted) {
                    passwords = JSON.parse(decrypted);
                }
            }
            renderPasswords();
            updateStats();
        }

        function savePasswords() {
            const encrypted = encrypt(JSON.stringify(passwords), masterKey);
            localStorage.setItem('vaultPasswords', encrypted);
        }

        function renderPasswords() {
            const container = document.getElementById('passwordList');
            const emptyState = document.getElementById('emptyState');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            let filtered = passwords.filter(p => {
                const matchesSearch = p.title.toLowerCase().includes(searchTerm) || 
                                     p.username.toLowerCase().includes(searchTerm) ||
                                     p.url.toLowerCase().includes(searchTerm);
                const matchesCategory = currentFilter === 'all' || p.category === currentFilter;
                return matchesSearch && matchesCategory;
            });

            if (filtered.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.innerHTML = filtered.map(p => \`
                <div class="card-glass rounded-xl p-4 hover:border-blue-500/50 transition cursor-pointer" onclick="viewPassword('\${p.id}')">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 \${categoryColors[p.category]} rounded-lg flex items-center justify-center flex-shrink-0">
                            <i class="fas \${categoryIcons[p.category]} text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-semibold truncate">\${escapeHtml(p.title)}</h3>
                                <span class="category-badge \${categoryColors[p.category]} text-white">\${p.category}</span>
                            </div>
                            <p class="text-gray-400 text-sm truncate">\${escapeHtml(p.username) || 'No username'}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="event.stopPropagation(); copyToClipboard('\${p.id}', 'username')" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition" title="Copy Username">
                                <i class="fas fa-user text-sm"></i>
                            </button>
                            <button onclick="event.stopPropagation(); copyToClipboard('\${p.id}', 'password')" class="p-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition" title="Copy Password">
                                <i class="fas fa-key text-sm"></i>
                            </button>
                            \${p.url ? \`<a href="\${escapeHtml(p.url)}" target="_blank" onclick="event.stopPropagation()" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition" title="Visit Site"><i class="fas fa-external-link-alt text-sm"></i></a>\` : ''}
                        </div>
                    </div>
                </div>
            \`).join('');
        }

        function updateStats() {
            document.getElementById('totalCount').textContent = passwords.length;
            
            let strongCount = 0;
            let weakCount = 0;
            passwords.forEach(p => {
                const strength = getPasswordStrength(p.password);
                if (strength.level === 'strong') strongCount++;
                else if (strength.level === 'weak') weakCount++;
            });

            document.getElementById('strongCount').textContent = strongCount;
            document.getElementById('weakCount').textContent = weakCount;

            const categories = new Set(passwords.map(p => p.category));
            document.getElementById('categoryCount').textContent = categories.size;
        }

        // Modal Functions
        function openAddModal(editId = null) {
            const modal = document.getElementById('addModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('passwordForm');
            
            form.reset();
            document.getElementById('editId').value = '';
            document.getElementById('passwordStrengthBar').className = 'h-full transition-all duration-300';
            document.getElementById('passwordStrengthText').textContent = '';

            if (editId) {
                const entry = passwords.find(p => p.id === editId);
                if (entry) {
                    title.textContent = 'Edit Password';
                    document.getElementById('editId').value = entry.id;
                    document.getElementById('entryTitle').value = entry.title;
                    document.getElementById('entryUsername').value = entry.username;
                    document.getElementById('entryPassword').value = entry.password;
                    document.getElementById('entryUrl').value = entry.url;
                    document.getElementById('entryCategory').value = entry.category;
                    document.getElementById('entryNotes').value = entry.notes;
                    updatePasswordStrengthUI(entry.password);
                }
            } else {
                title.textContent = 'Add New Password';
            }

            modal.classList.remove('hidden');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.add('hidden');
        }

        function savePassword(event) {
            event.preventDefault();
            
            const editId = document.getElementById('editId').value;
            const entry = {
                id: editId || Date.now().toString(),
                title: document.getElementById('entryTitle').value,
                username: document.getElementById('entryUsername').value,
                password: document.getElementById('entryPassword').value,
                url: document.getElementById('entryUrl').value,
                category: document.getElementById('entryCategory').value,
                notes: document.getElementById('entryNotes').value,
                createdAt: editId ? passwords.find(p => p.id === editId)?.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (editId) {
                const index = passwords.findIndex(p => p.id === editId);
                passwords[index] = entry;
                showToast('Password updated successfully!', 'success');
            } else {
                passwords.push(entry);
                showToast('Password saved successfully!', 'success');
            }

            savePasswords();
            renderPasswords();
            updateStats();
            closeAddModal();
        }

        function viewPassword(id) {
            const entry = passwords.find(p => p.id === id);
            if (!entry) return;

            const modal = document.getElementById('viewModal');
            document.getElementById('viewTitle').textContent = entry.title;
            
            const strength = getPasswordStrength(entry.password);
            
            document.getElementById('viewContent').innerHTML = \`
                <div class="space-y-4">
                    <div class="flex items-center gap-3 p-3 bg-gray-800/50 rounded-lg">
                        <div class="w-10 h-10 \${categoryColors[entry.category]} rounded-lg flex items-center justify-center">
                            <i class="fas \${categoryIcons[entry.category]}"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Category</p>
                            <p class="capitalize">\${entry.category}</p>
                        </div>
                    </div>
                    
                    <div class="p-3 bg-gray-800/50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-400">Username</p>
                                <p>\${escapeHtml(entry.username) || '-'}</p>
                            </div>
                            <button onclick="copyToClipboard('\${entry.id}', 'username')" class="p-2 hover:bg-gray-700 rounded-lg transition">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>

                    <div class="p-3 bg-gray-800/50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-sm text-gray-400">Password</p>
                                <p id="viewPasswordText" class="password-mask">••••••••••••</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="toggleViewPassword('\${entry.id}')" class="p-2 hover:bg-gray-700 rounded-lg transition">
                                    <i class="fas fa-eye" id="viewPasswordIcon"></i>
                                </button>
                                <button onclick="copyToClipboard('\${entry.id}', 'password')" class="p-2 hover:bg-gray-700 rounded-lg transition">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <div class="h-1 bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-full \${strength.class}"></div>
                            </div>
                            <p class="text-xs mt-1 text-gray-400">Strength: \${strength.text}</p>
                        </div>
                    </div>

                    \${entry.url ? \`
                    <div class="p-3 bg-gray-800/50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-gray-400">Website</p>
                                <p class="truncate">\${escapeHtml(entry.url)}</p>
                            </div>
                            <a href="\${escapeHtml(entry.url)}" target="_blank" class="p-2 hover:bg-gray-700 rounded-lg transition">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        </div>
                    </div>
                    \` : ''}

                    \${entry.notes ? \`
                    <div class="p-3 bg-gray-800/50 rounded-lg">
                        <p class="text-sm text-gray-400">Notes</p>
                        <p class="whitespace-pre-wrap">\${escapeHtml(entry.notes)}</p>
                    </div>
                    \` : ''}

                    <div class="flex justify-between text-xs text-gray-500">
                        <span>Created: \${new Date(entry.createdAt).toLocaleDateString()}</span>
                        <span>Updated: \${new Date(entry.updatedAt).toLocaleDateString()}</span>
                    </div>
                </div>
            \`;

            document.getElementById('viewEditBtn').onclick = () => {
                closeViewModal();
                openAddModal(id);
            };

            // Add delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'flex-1 bg-red-600 hover:bg-red-700 py-3 rounded-lg transition';
            deleteBtn.innerHTML = '<i class="fas fa-trash mr-2"></i>Delete';
            deleteBtn.onclick = () => deletePassword(id);
            
            const btnContainer = modal.querySelector('.flex.gap-3.mt-6');
            if (btnContainer.children.length === 2) {
                btnContainer.appendChild(deleteBtn);
            }

            modal.classList.remove('hidden');
        }

        function closeViewModal() {
            document.getElementById('viewModal').classList.add('hidden');
        }

        let viewPasswordVisible = false;
        function toggleViewPassword(id) {
            const entry = passwords.find(p => p.id === id);
            const textEl = document.getElementById('viewPasswordText');
            const iconEl = document.getElementById('viewPasswordIcon');
            
            viewPasswordVisible = !viewPasswordVisible;
            textEl.textContent = viewPasswordVisible ? entry.password : '••••••••••••';
            iconEl.className = viewPasswordVisible ? 'fas fa-eye-slash' : 'fas fa-eye';
        }

        function deletePassword(id) {
            if (confirm('Are you sure you want to delete this password?')) {
                passwords = passwords.filter(p => p.id !== id);
                savePasswords();
                renderPasswords();
                updateStats();
                closeViewModal();
                showToast('Password deleted', 'success');
            }
        }

        // Password Generator
        function openGeneratorModal() {
            document.getElementById('generatorModal').classList.remove('hidden');
            generatePassword();
        }

        function closeGeneratorModal() {
            document.getElementById('generatorModal').classList.add('hidden');
        }

        function updateLength() {
            document.getElementById('lengthValue').textContent = document.getElementById('passwordLength').value;
        }

        function generatePassword() {
            const length = parseInt(document.getElementById('passwordLength').value);
            const useUpper = document.getElementById('includeUpper').checked;
            const useLower = document.getElementById('includeLower').checked;
            const useNumbers = document.getElementById('includeNumbers').checked;
            const useSymbols = document.getElementById('includeSymbols').checked;

            let chars = '';
            if (useUpper) chars += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            if (useLower) chars += 'abcdefghijklmnopqrstuvwxyz';
            if (useNumbers) chars += '0123456789';
            if (useSymbols) chars += '!@#$%^&*()_+-=[]{}|;:,.<>?';

            if (chars === '') {
                document.getElementById('generatedPassword').textContent = 'Select at least one option';
                return;
            }

            let password = '';
            const array = new Uint32Array(length);
            crypto.getRandomValues(array);
            for (let i = 0; i < length; i++) {
                password += chars[array[i] % chars.length];
            }

            document.getElementById('generatedPassword').textContent = password;
        }

        function copyGeneratedPassword() {
            const password = document.getElementById('generatedPassword').textContent;
            if (password && password !== 'Click Generate' && password !== 'Select at least one option') {
                navigator.clipboard.writeText(password);
                showToast('Password copied to clipboard!', 'success');
            }
        }

        function generateForField() {
            const length = 16;
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            let password = '';
            const array = new Uint32Array(length);
            crypto.getRandomValues(array);
            for (let i = 0; i < length; i++) {
                password += chars[array[i] % chars.length];
            }
            document.getElementById('entryPassword').value = password;
            updatePasswordStrengthUI(password);
        }

        // Password Strength
        function getPasswordStrength(password) {
            let score = 0;
            if (password.length >= 8) score++;
            if (password.length >= 12) score++;
            if (/[a-z]/.test(password)) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^a-zA-Z0-9]/.test(password)) score++;

            if (score <= 2) return { level: 'weak', text: 'Weak', class: 'strength-weak' };
            if (score <= 3) return { level: 'fair', text: 'Fair', class: 'strength-fair' };
            if (score <= 4) return { level: 'good', text: 'Good', class: 'strength-good' };
            return { level: 'strong', text: 'Strong', class: 'strength-strong' };
        }

        function updatePasswordStrengthUI(password) {
            const strength = getPasswordStrength(password);
            const bar = document.getElementById('passwordStrengthBar');
            const text = document.getElementById('passwordStrengthText');
            
            bar.className = 'h-full transition-all duration-300 ' + strength.class;
            text.textContent = password ? \`Strength: \${strength.text}\` : '';
        }

        document.getElementById('entryPassword').addEventListener('input', (e) => {
            updatePasswordStrengthUI(e.target.value);
        });

        // Filter Functions
        function filterByCategory(category) {
            currentFilter = category;
            
            document.querySelectorAll('.category-filter').forEach(btn => {
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-gray-700');
            });
            
            document.querySelector(\`[data-category="\${category}"]\`).classList.remove('bg-gray-700');
            document.querySelector(\`[data-category="\${category}"]\`).classList.add('bg-blue-600');
            
            renderPasswords();
        }

        function filterPasswords() {
            renderPasswords();
        }

        // Copy to Clipboard
        function copyToClipboard(id, field) {
            const entry = passwords.find(p => p.id === id);
            if (entry) {
                const text = field === 'password' ? entry.password : entry.username;
                navigator.clipboard.writeText(text);
                showToast(\`\${field.charAt(0).toUpperCase() + field.slice(1)} copied!\`, 'success');
            }
        }

        // Export Functions
        function exportPasswords(format) {
            let content, filename, type;
            
            if (format === 'json') {
                content = JSON.stringify(passwords, null, 2);
                filename = 'passwords_export.json';
                type = 'application/json';
            } else {
                const headers = ['Title', 'Username', 'Password', 'URL', 'Category', 'Notes'];
                const rows = passwords.map(p => [
                    p.title, p.username, p.password, p.url, p.category, p.notes
                ].map(v => \`"\${(v || '').replace(/"/g, '""')}"\`).join(','));
                content = [headers.join(','), ...rows].join('\\n');
                filename = 'passwords_export.csv';
                type = 'text/csv';
            }

            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            document.getElementById('dropdownMenu').classList.add('hidden');
            showToast(\`Exported as \${format.toUpperCase()}\`, 'success');
        }

        // Utility Functions
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function toggleMenu() {
            document.getElementById('dropdownMenu').classList.toggle('hidden');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-[100]';
            toast.innerHTML = \`<div class="flex items-center gap-3"><i class="fas \${type === 'success' ? 'fa-check-circle text-green-400' : 'fa-exclamation-circle text-red-400'}"></i><span>\${message}</span></div>\`;
            document.body.appendChild(toast);
            
            requestAnimationFrame(() => toast.classList.remove('translate-y-20', 'opacity-0'));
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#dropdownMenu') && !e.target.closest('button')) {
                document.getElementById('dropdownMenu').classList.add('hidden');
            }
        });

        // Handle Enter key on lock screen
        document.getElementById('masterPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') unlock();
        });

        // Check if vault exists on load
        document.addEventListener('DOMContentLoaded', () => {
            const hasVault = localStorage.getItem('vaultMasterHash');
            if (!hasVault) {
                showSetupMode();
            } else {
                showLoginMode();
            }
        });

        // Custom function for back to dashboard
        function backToDashboard() {
            window.parent.postMessage({ type: 'CLOSE_VAULT' }, '*');
        }
    <\/script>
    <button onclick="backToDashboard()" class="fixed top-4 left-4 bg-gray-800/80 px-4 py-2 rounded-lg text-white text-sm hover:bg-gray-700 z-50">
        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
    </button>
</body>
</html>`;

      // --- FLUID ENGINE CLASSES ---
      // (Engine classes preserved verbatim to ensure stability of existing visual effects)
      class PointerPrototype {
        constructor() {
          this.id = -1;
          this.texcoordX = 0;
          this.texcoordY = 0;
          this.prevTexcoordX = 0;
          this.prevTexcoordY = 0;
          this.deltaX = 0;
          this.deltaY = 0;
          this.down = false;
          this.moved = false;
          this.color = { r: 0, g: 0, b: 0 };
        }
      }

      class Program {
        constructor(gl, vertexShaderSrc, fragmentShaderSrc) {
          this.gl = gl;
          this.uniforms = {};
          this.program = this.createProgram(vertexShaderSrc, fragmentShaderSrc);
          this.uniforms = this.getUniforms(this.program);
        }
        bind() {
          this.gl.useProgram(this.program);
        }
        createProgram(vSrc, fSrc) {
          let gl = this.gl;
          let vShader = this.compileShader(gl.VERTEX_SHADER, vSrc);
          let fShader = this.compileShader(gl.FRAGMENT_SHADER, fSrc);
          let program = gl.createProgram();
          gl.attachShader(program, vShader);
          gl.attachShader(program, fShader);
          gl.linkProgram(program);
          return program;
        }
        compileShader(type, source) {
          let gl = this.gl;
          let shader = gl.createShader(type);
          gl.shaderSource(shader, source);
          gl.compileShader(shader);
          return shader;
        }
        getUniforms(program) {
          let gl = this.gl;
          let uniforms = [];
          let count = gl.getProgramParameter(program, gl.ACTIVE_UNIFORMS);
          for (let i = 0; i < count; i++) {
            let name = gl.getActiveUniform(program, i).name;
            uniforms[name] = gl.getUniformLocation(program, name);
          }
          return uniforms;
        }
      }

      class Material {
        constructor(gl, vertexShader, fragmentShaderSource) {
          this.gl = gl;
          this.vertexShader = vertexShader;
          this.fragmentShaderSource = fragmentShaderSource;
          this.programs = [];
          this.activeProgram = null;
          this.uniforms = [];
        }
        setKeywords(keywords) {
          let hash = 0;
          for (let i = 0; i < keywords.length; i++) {
            let s = keywords[i];
            for (let j = 0; j < s.length; j++)
              hash = ((hash << 5) - hash + s.charCodeAt(j)) | 0;
          }
          let program = this.programs[hash];
          if (program == null) {
            let kwdStr = "";
            keywords.forEach((k) => (kwdStr += "#define " + k + "\n"));
            let p = new Program(
              this.gl,
              this.vertexShader,
              kwdStr + this.fragmentShaderSource
            );
            program = p.program;
            this.programs[hash] = program;
          }
          if (program === this.activeProgram) return;
          this.activeProgram = program;
          let count = this.gl.getProgramParameter(
            program,
            this.gl.ACTIVE_UNIFORMS
          );
          let uniforms = [];
          for (let i = 0; i < count; i++) {
            let name = this.gl.getActiveUniform(program, i).name;
            uniforms[name] = this.gl.getUniformLocation(program, name);
          }
          this.uniforms = uniforms;
        }
        bind() {
          this.gl.useProgram(this.activeProgram);
        }
      }

      class FluidWebGLEngine {
        constructor(canvas) {
          this.canvas = canvas;
          this.gl = null;
          this.ext = null;
          this.pointers = [];
          this.config = {
            SIM_RESOLUTION: 128,
            DYE_RESOLUTION: 1024,
            DENSITY_DISSIPATION: 1,
            VELOCITY_DISSIPATION: 0.2,
            PRESSURE: 0.8,
            PRESSURE_ITERATIONS: 20,
            CURL: 30,
            SPLAT_RADIUS: 0.25,
            SPLAT_FORCE: 6000,
            SIM_SPEED: 1.0,
            SHADING: true,
            PAUSED: false,
            COLOR_A: { r: 0, g: 240 / 255, b: 255 / 255 },
            COLOR_B: { r: 1, g: 0, b: 0.33 },
          };
          this.init();
        }
        updateConfig(newConfig) {
          Object.assign(this.config, newConfig);
          if (newConfig.shouldReinitFramebuffers) this.initFramebuffers();
        }
        init() {
          const { gl, ext } = this.getWebGLContext(this.canvas);
          this.gl = gl;
          this.ext = ext;
          if (!gl) return;
          if (!ext.supportLinearFiltering) {
            this.config.DYE_RESOLUTION = 512;
            this.config.SHADING = false;
          }
          this.initShaders();
          this.initFramebuffers();
          this.initBlit();
          this.pointers.push(new PointerPrototype());
          this.bindEvents();
          this.animate();
        }
        getWebGLContext(canvas) {
          const params = {
            alpha: true,
            depth: false,
            stencil: false,
            antialias: false,
          };
          let gl = canvas.getContext("webgl2", params);
          const isWebGL2 = !!gl;
          if (!isWebGL2)
            gl =
              canvas.getContext("webgl", params) ||
              canvas.getContext("experimental-webgl", params);
          if (!gl) return { gl: null, ext: null };
          let halfFloat, supportLinearFiltering;
          if (isWebGL2) {
            gl.getExtension("EXT_color_buffer_float");
            supportLinearFiltering = gl.getExtension(
              "OES_texture_float_linear"
            );
          } else {
            halfFloat = gl.getExtension("OES_texture_half_float");
            supportLinearFiltering = gl.getExtension(
              "OES_texture_half_float_linear"
            );
          }
          const halfFloatTexType = isWebGL2
            ? gl.HALF_FLOAT
            : halfFloat && halfFloat.HALF_FLOAT_OES;
          let formatRGBA, formatRG, formatR;
          if (isWebGL2) {
            formatRGBA = this.getSupportedFormat(
              gl,
              gl.RGBA16F,
              gl.RGBA,
              halfFloatTexType
            );
            formatRG = this.getSupportedFormat(
              gl,
              gl.RG16F,
              gl.RG,
              halfFloatTexType
            );
            formatR = this.getSupportedFormat(
              gl,
              gl.R16F,
              gl.RED,
              halfFloatTexType
            );
          } else {
            formatRGBA = this.getSupportedFormat(
              gl,
              gl.RGBA,
              gl.RGBA,
              halfFloatTexType
            );
            formatRG = this.getSupportedFormat(
              gl,
              gl.RGBA,
              gl.RGBA,
              halfFloatTexType
            );
            formatR = this.getSupportedFormat(
              gl,
              gl.RGBA,
              gl.RGBA,
              halfFloatTexType
            );
          }
          return {
            gl,
            ext: {
              formatRGBA,
              formatRG,
              formatR,
              halfFloatTexType,
              supportLinearFiltering,
            },
          };
        }
        getSupportedFormat(gl, internalFormat, format, type) {
          return { internalFormat, format };
        }
        initShaders() {
          const gl = this.gl;
          const s = this.getShaderSources();
          this.material = new Material(gl, s.baseVertex, s.displayShader);
          this.material.setKeywords(this.config.SHADING ? ["SHADING"] : []);
          this.programs = {
            copy: new Program(gl, s.baseVertex, s.copyShader),
            clear: new Program(gl, s.baseVertex, s.clearShader),
            splat: new Program(gl, s.baseVertex, s.splatShader),
            advection: new Program(gl, s.baseVertex, s.advectionShader),
            divergence: new Program(gl, s.baseVertex, s.divergenceShader),
            curl: new Program(gl, s.baseVertex, s.curlShader),
            vorticity: new Program(gl, s.baseVertex, s.vorticityShader),
            pressure: new Program(gl, s.baseVertex, s.pressureShader),
            gradientSubtract: new Program(
              gl,
              s.baseVertex,
              s.gradientSubtractShader
            ),
          };
        }
        initFramebuffers() {
          const gl = this.gl;
          const ext = this.ext;
          let simRes = this.getResolution(this.config.SIM_RESOLUTION);
          let dyeRes = this.getResolution(this.config.DYE_RESOLUTION);
          const texType = ext.halfFloatTexType;
          const filtering = ext.supportLinearFiltering ? gl.LINEAR : gl.NEAREST;
          gl.disable(gl.BLEND);
          this.dye = this.createOrResizeDoubleFBO(
            this.dye,
            dyeRes.width,
            dyeRes.height,
            ext.formatRGBA.internalFormat,
            ext.formatRGBA.format,
            texType,
            filtering
          );
          this.velocity = this.createOrResizeDoubleFBO(
            this.velocity,
            simRes.width,
            simRes.height,
            ext.formatRG.internalFormat,
            ext.formatRG.format,
            texType,
            filtering
          );
          this.divergence = this.createFBO(
            simRes.width,
            simRes.height,
            ext.formatR.internalFormat,
            ext.formatR.format,
            texType,
            gl.NEAREST
          );
          this.curl = this.createFBO(
            simRes.width,
            simRes.height,
            ext.formatR.internalFormat,
            ext.formatR.format,
            texType,
            gl.NEAREST
          );
          this.pressure = this.createOrResizeDoubleFBO(
            this.pressure,
            simRes.width,
            simRes.height,
            ext.formatR.internalFormat,
            ext.formatR.format,
            texType,
            gl.NEAREST
          );
        }
        createOrResizeDoubleFBO(
          target,
          w,
          h,
          internalFormat,
          format,
          type,
          param
        ) {
          if (!target || target.width !== w || target.height !== h)
            return this.createDoubleFBO(
              w,
              h,
              internalFormat,
              format,
              type,
              param
            );
          return target;
        }
        createFBO(w, h, internalFormat, format, type, param) {
          const gl = this.gl;
          gl.activeTexture(gl.TEXTURE0);
          let texture = gl.createTexture();
          gl.bindTexture(gl.TEXTURE_2D, texture);
          gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, param);
          gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, param);
          gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
          gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
          gl.texImage2D(
            gl.TEXTURE_2D,
            0,
            internalFormat,
            w,
            h,
            0,
            format,
            type,
            null
          );
          let fbo = gl.createFramebuffer();
          gl.bindFramebuffer(gl.FRAMEBUFFER, fbo);
          gl.framebufferTexture2D(
            gl.FRAMEBUFFER,
            gl.COLOR_ATTACHMENT0,
            gl.TEXTURE_2D,
            texture,
            0
          );
          gl.viewport(0, 0, w, h);
          gl.clear(gl.COLOR_BUFFER_BIT);
          return {
            texture,
            fbo,
            width: w,
            height: h,
            texelSizeX: 1.0 / w,
            texelSizeY: 1.0 / h,
            attach(id) {
              gl.activeTexture(gl.TEXTURE0 + id);
              gl.bindTexture(gl.TEXTURE_2D, texture);
              return id;
            },
          };
        }
        createDoubleFBO(w, h, internalFormat, format, type, param) {
          let fbo1 = this.createFBO(w, h, internalFormat, format, type, param);
          let fbo2 = this.createFBO(w, h, internalFormat, format, type, param);
          return {
            width: w,
            height: h,
            texelSizeX: fbo1.texelSizeX,
            texelSizeY: fbo1.texelSizeY,
            get read() {
              return fbo1;
            },
            set read(value) {
              fbo1 = value;
            },
            get write() {
              return fbo2;
            },
            set write(value) {
              fbo2 = value;
            },
            swap() {
              let temp = fbo1;
              fbo1 = fbo2;
              fbo2 = temp;
            },
          };
        }
        initBlit() {
          const gl = this.gl;
          gl.bindBuffer(gl.ARRAY_BUFFER, gl.createBuffer());
          gl.bufferData(
            gl.ARRAY_BUFFER,
            new Float32Array([-1, -1, -1, 1, 1, 1, 1, -1]),
            gl.STATIC_DRAW
          );
          gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, gl.createBuffer());
          gl.bufferData(
            gl.ELEMENT_ARRAY_BUFFER,
            new Uint16Array([0, 1, 2, 0, 2, 3]),
            gl.STATIC_DRAW
          );
          gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);
          gl.enableVertexAttribArray(0);
          this.blit = (target, clear = false) => {
            gl.bindFramebuffer(gl.FRAMEBUFFER, target ? target.fbo : null);
            gl.viewport(
              0,
              0,
              target ? target.width : gl.drawingBufferWidth,
              target ? target.height : gl.drawingBufferHeight
            );
            if (clear) {
              gl.clearColor(0.0, 0.0, 0.0, 1.0);
              gl.clear(gl.COLOR_BUFFER_BIT);
            }
            gl.drawElements(gl.TRIANGLES, 6, gl.UNSIGNED_SHORT, 0);
          };
        }

        // PASTE THIS NEW BLOCK INSTEAD
        bindEvents() {
          const mapColor = () => {
            const cA = this.config.COLOR_A;
            const cB = this.config.COLOR_B;
            let t = (Math.sin(Date.now() * 0.005) + 1) * 0.5;
            return {
              r: cA.r * (1 - t) + cB.r * t,
              g: cA.g * (1 - t) + cB.g * t,
              b: cA.b * (1 - t) + cB.b * t,
            };
          };

          const handleMove = (x, y) => {
            // Stop calculations in admin mode to save battery/CPU
            if (document.body.classList.contains('admin-mode')) return;

            let p = this.pointers[0];
            p.moved = p.down;
            p.prevTexcoordX = p.texcoordX;
            p.prevTexcoordY = p.texcoordY;
            p.texcoordX = x / window.innerWidth;
            p.texcoordY = 1.0 - y / window.innerHeight;
            p.deltaX =
              (p.texcoordX - p.prevTexcoordX) *
              (this.canvas.width / this.canvas.height);
            p.deltaY = p.texcoordY - p.prevTexcoordY;
            p.color = mapColor();
            if (Math.abs(p.deltaX) > 0 || Math.abs(p.deltaY) > 0)
              this.splatPointer(p);
          };

          // Mouse is fine on all devices
          window.addEventListener("mousemove", (e) =>
            handleMove(e.clientX, e.clientY)
          );

          // CRITICAL FIX: Only enable fluid touch interaction on Desktop/Large Screens.
          // On mobile, we DISABLE this so your finger scrolls the page instead of moving the liquid.
          if (window.innerWidth > 1024) {
            window.addEventListener(
              "touchmove",
              (e) => {
                if (document.body.classList.contains('admin-mode')) return;
                // No preventDefault() here, allowing the browser to handle scrolling normally
                if (e.touches.length > 0)
                  handleMove(e.touches[0].clientX, e.touches[0].clientY);
              },
              { passive: true } // Passive: true makes scrolling instant
            );
          }
        }
        splatPointer(pointer) {
          let dx = pointer.deltaX * this.config.SPLAT_FORCE;
          let dy = pointer.deltaY * this.config.SPLAT_FORCE;
          this.splat(
            pointer.texcoordX,
            pointer.texcoordY,
            dx,
            dy,
            pointer.color
          );
        }
        splat(x, y, dx, dy, color) {
          const gl = this.gl;
          this.programs.splat.bind();
          gl.uniform1i(
            this.programs.splat.uniforms.uTarget,
            this.velocity.read.attach(0)
          );
          gl.uniform1f(
            this.programs.splat.uniforms.aspectRatio,
            this.canvas.width / this.canvas.height
          );
          gl.uniform2f(this.programs.splat.uniforms.point, x, y);
          gl.uniform3f(this.programs.splat.uniforms.color, dx, dy, 0.0);
          gl.uniform1f(
            this.programs.splat.uniforms.radius,
            this.config.SPLAT_RADIUS / 100.0
          );
          this.blit(this.velocity.write);
          this.velocity.swap();

          gl.uniform1i(
            this.programs.splat.uniforms.uTarget,
            this.dye.read.attach(0)
          );
          gl.uniform3f(
            this.programs.splat.uniforms.color,
            color.r,
            color.g,
            color.b
          );
          this.blit(this.dye.write);
          this.dye.swap();
        }
        animate = () => {
          
          // 1. PERFORMANCE FIX: Completely stop rendering in Admin Mode
          if (document.body.classList.contains('admin-mode')) {
            // Check again in 500ms instead of running loop at 60fps
            setTimeout(() => requestAnimationFrame(this.animate), 500);
            return;
          }

          // 2. Normal Visitor Mode: Run the splash effect
          if (!this.config.PAUSED && this.gl) {
            this.step(0.016 * this.config.SIM_SPEED);
            this.render(null);
          }
          requestAnimationFrame(this.animate);
        };
        step(dt) {
          const gl = this.gl;
          const p = this.programs;
          gl.disable(gl.BLEND);
          p.curl.bind();
          gl.uniform2f(
            p.curl.uniforms.texelSize,
            this.velocity.texelSizeX,
            this.velocity.texelSizeY
          );
          gl.uniform1i(p.curl.uniforms.uVelocity, this.velocity.read.attach(0));
          this.blit(this.curl);
          p.vorticity.bind();
          gl.uniform2f(
            p.vorticity.uniforms.texelSize,
            this.velocity.texelSizeX,
            this.velocity.texelSizeY
          );
          gl.uniform1i(
            p.vorticity.uniforms.uVelocity,
            this.velocity.read.attach(0)
          );
          gl.uniform1i(p.vorticity.uniforms.uCurl, this.curl.attach(1));
          gl.uniform1f(p.vorticity.uniforms.curl, this.config.CURL);
          gl.uniform1f(p.vorticity.uniforms.dt, dt);
          this.blit(this.velocity.write);
          this.velocity.swap();
          p.divergence.bind();
          gl.uniform2f(
            p.divergence.uniforms.texelSize,
            this.velocity.texelSizeX,
            this.velocity.texelSizeY
          );
          gl.uniform1i(
            p.divergence.uniforms.uVelocity,
            this.velocity.read.attach(0)
          );
          this.blit(this.divergence);
          p.clear.bind();
          gl.uniform1i(p.clear.uniforms.uTexture, this.pressure.read.attach(0));
          gl.uniform1f(p.clear.uniforms.value, this.config.PRESSURE);
          this.blit(this.pressure.write);
          this.pressure.swap();
          p.pressure.bind();
          gl.uniform2f(
            p.pressure.uniforms.texelSize,
            this.velocity.texelSizeX,
            this.velocity.texelSizeY
          );
          gl.uniform1i(
            p.pressure.uniforms.uDivergence,
            this.divergence.attach(0)
          );
          for (let i = 0; i < this.config.PRESSURE_ITERATIONS; i++) {
            gl.uniform1i(
              p.pressure.uniforms.uPressure,
              this.pressure.read.attach(1)
            );
            this.blit(this.pressure.write);
            this.pressure.swap();
          }
          p.gradientSubtract.bind();
          gl.uniform2f(
            p.gradientSubtract.uniforms.texelSize,
            this.velocity.texelSizeX,
            this.velocity.texelSizeY
          );
          gl.uniform1i(
            p.gradientSubtract.uniforms.uPressure,
            this.pressure.read.attach(0)
          );
          gl.uniform1i(
            p.gradientSubtract.uniforms.uVelocity,
            this.velocity.read.attach(1)
          );
          this.blit(this.velocity.write);
          this.velocity.swap();
          p.advection.bind();
          gl.uniform2f(
            p.advection.uniforms.texelSize,
            this.velocity.texelSizeX,
            this.velocity.texelSizeY
          );
          if (!this.ext.supportLinearFiltering)
            gl.uniform2f(
              p.advection.uniforms.dyeTexelSize,
              this.velocity.texelSizeX,
              this.velocity.texelSizeY
            );
          let velocityId = this.velocity.read.attach(0);
          gl.uniform1i(p.advection.uniforms.uVelocity, velocityId);
          gl.uniform1i(p.advection.uniforms.uSource, velocityId);
          gl.uniform1f(p.advection.uniforms.dt, dt);
          gl.uniform1f(
            p.advection.uniforms.dissipation,
            this.config.VELOCITY_DISSIPATION
          );
          this.blit(this.velocity.write);
          this.velocity.swap();
          if (!this.ext.supportLinearFiltering)
            gl.uniform2f(
              p.advection.uniforms.dyeTexelSize,
              this.dye.texelSizeX,
              this.dye.texelSizeY
            );
          gl.uniform1i(
            p.advection.uniforms.uVelocity,
            this.velocity.read.attach(0)
          );
          gl.uniform1i(p.advection.uniforms.uSource, this.dye.read.attach(1));
          gl.uniform1f(
            p.advection.uniforms.dissipation,
            this.config.DENSITY_DISSIPATION
          );
          this.blit(this.dye.write);
          this.dye.swap();
        }
        render(target) {
          const gl = this.gl;
          gl.blendFunc(gl.ONE, gl.ONE_MINUS_SRC_ALPHA);
          gl.enable(gl.BLEND);
          let width = target == null ? gl.drawingBufferWidth : target.width;
          let height = target == null ? gl.drawingBufferHeight : target.height;
          this.material.bind();
          if (this.config.SHADING)
            gl.uniform2f(
              this.material.uniforms.texelSize,
              1.0 / width,
              1.0 / height
            );
          gl.uniform1i(
            this.material.uniforms.uTexture,
            this.dye.read.attach(0)
          );
          this.blit(target);
        }
        getResolution(resolution) {
          let aspectRatio =
            this.gl.drawingBufferWidth / this.gl.drawingBufferHeight;
          if (aspectRatio < 1) aspectRatio = 1.0 / aspectRatio;
          const min = Math.round(resolution);
          const max = Math.round(resolution * aspectRatio);
          return this.gl.drawingBufferWidth > this.gl.drawingBufferHeight
            ? { width: max, height: min }
            : { width: min, height: max };
        }
        getShaderSources() {
          return {
            baseVertex: `precision highp float; attribute vec2 aPosition; varying vec2 vUv; varying vec2 vL; varying vec2 vR; varying vec2 vT; varying vec2 vB; uniform vec2 texelSize; void main () { vUv = aPosition * 0.5 + 0.5; vL = vUv - vec2(texelSize.x, 0.0); vR = vUv + vec2(texelSize.x, 0.0); vT = vUv + vec2(0.0, texelSize.y); vB = vUv - vec2(0.0, texelSize.y); gl_Position = vec4(aPosition, 0.0, 1.0); }`,
            copyShader: `precision mediump float; precision mediump sampler2D; varying highp vec2 vUv; uniform sampler2D uTexture; void main () { gl_FragColor = texture2D(uTexture, vUv); }`,
            clearShader: `precision mediump float; precision mediump sampler2D; varying highp vec2 vUv; uniform sampler2D uTexture; uniform float value; void main () { gl_FragColor = value * texture2D(uTexture, vUv); }`,
            displayShader: `precision highp float; precision highp sampler2D; varying vec2 vUv; varying vec2 vL; varying vec2 vR; varying vec2 vT; varying vec2 vB; uniform sampler2D uTexture; uniform vec2 texelSize; void main () { vec3 c = texture2D(uTexture, vUv).rgb; #ifdef SHADING vec3 lc = texture2D(uTexture, vL).rgb; vec3 rc = texture2D(uTexture, vR).rgb; vec3 tc = texture2D(uTexture, vT).rgb; vec3 bc = texture2D(uTexture, vB).rgb; float dx = length(rc) - length(lc); float dy = length(tc) - length(bc); vec3 n = normalize(vec3(dx, dy, length(texelSize))); vec3 l = vec3(0.0, 0.0, 1.0); float diffuse = clamp(dot(n, l) + 0.7, 0.7, 1.0); c *= diffuse; #endif float a = max(c.r, max(c.g, c.b)); gl_FragColor = vec4(c, a); }`,
            splatShader: `precision highp float; precision highp sampler2D; varying vec2 vUv; uniform sampler2D uTarget; uniform float aspectRatio; uniform vec3 color; uniform vec2 point; uniform float radius; void main () { vec2 p = vUv - point.xy; p.x *= aspectRatio; vec3 splat = exp(-dot(p, p) / radius * 0.4) * color; vec3 base = texture2D(uTarget, vUv).xyz; gl_FragColor = vec4(base + splat, 1.0); }`,
            advectionShader: `precision highp float; precision highp sampler2D; varying vec2 vUv; uniform sampler2D uVelocity; uniform sampler2D uSource; uniform vec2 texelSize; uniform vec2 dyeTexelSize; uniform float dt; uniform float dissipation; vec4 bilerp (sampler2D sam, vec2 uv, vec2 tsize) { vec2 st = uv / tsize - 0.5; vec2 iuv = floor(st); vec2 fuv = fract(st); vec4 a = texture2D(sam, (iuv + vec2(0.5, 0.5)) * tsize); vec4 b = texture2D(sam, (iuv + vec2(1.5, 0.5)) * tsize); vec4 c = texture2D(sam, (iuv + vec2(0.5, 1.5)) * tsize); vec4 d = texture2D(sam, (iuv + vec2(1.5, 1.5)) * tsize); return mix(mix(a, b, fuv.x), mix(c, d, fuv.x), fuv.y); } void main () { vec2 coord = vUv - dt * texture2D(uVelocity, vUv).xy * texelSize; vec4 result = texture2D(uSource, coord); float decay = 1.0 + dissipation * dt; gl_FragColor = result / decay; }`,
            divergenceShader: `precision mediump float; precision mediump sampler2D; varying highp vec2 vUv; varying highp vec2 vL; varying highp vec2 vR; varying highp vec2 vT; varying highp vec2 vB; uniform sampler2D uVelocity; void main () { float L = texture2D(uVelocity, vL).x; float R = texture2D(uVelocity, vR).x; float T = texture2D(uVelocity, vT).y; float B = texture2D(uVelocity, vB).y; vec2 C = texture2D(uVelocity, vUv).xy; if (vL.x < 0.0) { L = -C.x; } if (vR.x > 1.0) { R = -C.x; } if (vT.y > 1.0) { T = -C.y; } if (vB.y < 0.0) { B = -C.y; } float div = 0.5 * (R - L + T - B); gl_FragColor = vec4(div, 0.0, 0.0, 1.0); }`,
            curlShader: `precision mediump float; precision mediump sampler2D; varying highp vec2 vUv; varying highp vec2 vL; varying highp vec2 vR; varying highp vec2 vT; varying highp vec2 vB; uniform sampler2D uVelocity; void main () { float L = texture2D(uVelocity, vL).y; float R = texture2D(uVelocity, vR).y; float T = texture2D(uVelocity, vT).x; float B = texture2D(uVelocity, vB).x; float vorticity = R - L - T + B; gl_FragColor = vec4(0.5 * vorticity, 0.0, 0.0, 1.0); }`,
            vorticityShader: `precision highp float; precision highp sampler2D; varying vec2 vUv; varying vec2 vL; varying vec2 vR; varying vec2 vT; varying vec2 vB; uniform sampler2D uVelocity; uniform sampler2D uCurl; uniform float curl; uniform float dt; void main () { float L = texture2D(uCurl, vL).x; float R = texture2D(uCurl, vR).x; float T = texture2D(uCurl, vT).x; float B = texture2D(uCurl, vB).x; float C = texture2D(uCurl, vUv).x; vec2 force = 0.5 * vec2(abs(T) - abs(B), abs(R) - abs(L)); force /= length(force) + 0.0001; force *= curl * C; force.y *= -1.0; vec2 velocity = texture2D(uVelocity, vUv).xy; velocity += force * dt; velocity = min(max(velocity, -1000.0), 1000.0); gl_FragColor = vec4(velocity, 0.0, 1.0); }`,
            pressureShader: `precision mediump float; precision mediump sampler2D; varying highp vec2 vUv; varying highp vec2 vL; varying highp vec2 vR; varying highp vec2 vT; varying highp vec2 vB; uniform sampler2D uPressure; uniform sampler2D uDivergence; void main () { float L = texture2D(uPressure, vL).x; float R = texture2D(uPressure, vR).x; float T = texture2D(uPressure, vT).x; float B = texture2D(uPressure, vB).x; float C = texture2D(uPressure, vUv).x; float divergence = texture2D(uDivergence, vUv).x; float pressure = (L + R + B + T - divergence) * 0.25; gl_FragColor = vec4(pressure, 0.0, 0.0, 1.0); }`,
            gradientSubtractShader: `precision mediump float; precision mediump sampler2D; varying highp vec2 vUv; varying highp vec2 vL; varying highp vec2 vR; varying highp vec2 vT; varying highp vec2 vB; uniform sampler2D uPressure; uniform sampler2D uVelocity; void main () { float L = texture2D(uPressure, vL).x; float R = texture2D(uPressure, vR).x; float T = texture2D(uPressure, vT).x; float B = texture2D(uPressure, vB).x; vec2 velocity = texture2D(uVelocity, vUv).xy; velocity.xy -= vec2(R - L, T - B); gl_FragColor = vec4(velocity, 0.0, 1.0); }`,
          };
        }
      }

      const {
        useState,
        useEffect,
        useRef,
        createContext,
        useContext,
        useCallback,
        useMemo,
      } = React;
      // === NEW COMPONENT: ODOMETER COUNTER ===
      const OdometerDigit = ({ value }) => {
        return (
          <div className="odometer">
            <div 
              className="digit-column" 
              style={{ transform: `translateY(-${value * 28}px)` }} // 28px matches CSS height
            >
              {[0,1,2,3,4,5,6,7,8,9].map(n => (
                <span key={n}>{n}</span>
              ))}
            </div>
          </div>
        );
      };

      const RollingNumber = ({ n }) => {
        const digits = n.toString().split('').map(Number);
        return (
          <div className="flex gap-1">
            {digits.map((d, i) => <OdometerDigit key={i} value={d} />)}
          </div>
        );
      };

    // === UPDATED 3D HUD STATS DISPLAY ===
      const StatsDisplay = ({ visitors, views, active, appreciations }) => {
        // We use the theme variables dynamically here
        return (
          <div className="hud-container" data-aos="fade-up">
            {/* Decorative Label above the dashboard */}
            <div className="text-center mb-4 opacity-70">
              <span className="text-[10px] font-mono tracking-[0.3em] uppercase text-cyan-400">
                  // Live System Metrics
              </span>
            </div>

            <div className="hud-panel">
              {/* 1. VISITORS */}
              <div className="hud-item group">
                <div className="hud-label">Unique Visitors</div>
                <div className="hud-value-container" style={{ color: 'var(--primary-color)' }}>
                  <i className="fas fa-user-astronaut text-lg opacity-80 group-hover:animate-bounce"></i>
                  <RollingNumber n={visitors} />
                </div>
              </div>

              {/* 2. VIEWS */}
              <div className="hud-item group">
                <div className="hud-label">Total Views</div>
                <div className="hud-value-container" style={{ color: 'var(--secondary-color)' }}>
                  <i className="fas fa-eye text-lg opacity-80 group-hover:animate-pulse"></i>
                  <RollingNumber n={views} />
                </div>
              </div>

              {/* 3. ACTIVE */}
              <div className="hud-item group">
                <div className="hud-label">Active Signals</div>
                <div className="hud-value-container text-green-400">
                  <span className="relative flex h-3 w-3 mr-1">
                    <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                    <span className="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                  </span>
                  <RollingNumber n={active} />
                </div>
              </div>

              {/* 4. APPRECIATIONS */}
              <div className="hud-item group">
                <div className="hud-label">Global Hearts</div>
                <div className="hud-value-container text-red-500">
                  <i className="fas fa-heart text-lg group-hover:animate-beat"></i>
                  <RollingNumber n={appreciations || 0} />
                </div>
              </div>
            </div>

            {/* Reflective shine under the board */}
            <div className="w-3/4 mx-auto h-4 bg-gradient-to-b from-[rgba(var(--primary-rgb),0.2)] to-transparent blur-md rounded-full mt-2"></div>
          </div>
        );
      };

      // === CONTEXT ===
      const ThemeContext = createContext();
      const AdminContext = createContext();

      // === UTILITIES ===
      const showToast = (message, type = "success") => {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        const icon =
          { success: "✨", error: "❌", info: "ℹ️", warning: "⚠️" }[type] ||
          "✨";
        toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
        container.appendChild(toast);

        requestAnimationFrame(() => toast.classList.add("show"));
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 400);
        }, 3500);

        if (type === "success" && window.confetti) {
          confetti({
            particleCount: 80,
            spread: 70,
            origin: { y: 0.8 },
            colors: ["#06b6d4", "#a855f7", "#10b981", "#f59e0b"],
          });
        }
      };

      const createClickParticles = (x, y, colors) => {
        const container = document.getElementById("particle-container");
        for (let i = 0; i < 12; i++) {
          const particle = document.createElement("div");
          particle.className = "particle";
          const angle = (i / 12) * Math.PI * 2;
          const velocity = 60 + Math.random() * 40;
          const tx = Math.cos(angle) * velocity;
          const ty = Math.sin(angle) * velocity - 30;
          particle.style.cssText = `
                    left: ${x}px; top: ${y}px;
                    width: ${6 + Math.random() * 6}px; height: ${
            6 + Math.random() * 6
          }px;
                    background: ${
                      colors[Math.floor(Math.random() * colors.length)]
                    };
                    --tx: ${tx}px; --ty: ${ty}px;
                    animation: particleFloat 0.8s ease-out forwards;
                `;
          container.appendChild(particle);
          setTimeout(() => particle.remove(), 800);
        }
      };

      const hexToRgb = (hex) => {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result
          ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(
              result[3],
              16
            )}`
          : "6, 182, 212";
      };

      const hexToRgbObj = (hex) => {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result
          ? {
              r: parseInt(result[1], 16) / 255,
              g: parseInt(result[2], 16) / 255,
              b: parseInt(result[3], 16) / 255,
            }
          : { r: 0, g: 0, b: 0 };
      };

      // === INITIAL DATA ===
      const initialData = {
        portfolioDataVersion: 4,
        siteTitle: "Junaid Abid - Portfolio",
        navBrand: { first: "Junaid", second: "Abid" },
        heroGreeting: "Hello, I am",
        name: "Junaid Abid",
        role: "AI Project & Product Manager",
        tagline: "Growth Strategy | SaaS Scaling | AI Automation",
        summary:
          "Agile-savvy Product & Project Manager with 6+ years of experience driving SaaS innovation and business growth. I specialize in automating workflows using AI, managing complex engineering projects, and launching digital products. Proven track record of securing funding, leading cross-functional teams, and delivering scalable solutions.",
        email: "mj.abid@outlook.com",
        phone: "(+49) 163-2560561",
        location: "Munich, Germany",
        linkedin: "https://www.linkedin.com/in/chaudhrymj/",
        github: "https://github.com/J-Abid",
        profileImage: "image.png",
        cvUrl: "CV.pdf",
        cvFileName: "CV.pdf",
        footerText: "Built with creativity and passion ✨",
        stats: { visitors: 12403, views: 45201, active: 12, appreciations: 0 },
        sectionHeaders: {
          experience: "Professional Experience",
          experienceSubtitle: "A journey through innovation and impact",
          education: "Education",
          educationSubtitle: "Academic Background",
          skills: "Technical Skills",
          skillsSubtitle: "Tools & technologies I work with",
          projects: "Key Innovation Projects",
          projectsSubtitle: "Explore my portfolio of innovative projects spanning AI Agents, SaaS development, and engineering.",
          contact: "Connect Globally",
          contactTitle: "Connect Globally",
          contactSubtitle: "Reach out from anywhere in the world",
          contactQuote: "If you need someone who can debug a circuit, manage a product roadmap, and craft a business strategy, all before lunch - let's talk.",
          publications: "Publications",
          certifications: "Certifications",
          volunteer: "Volunteer Work",
          licenses: "Licenses & Registrations",
          languages: "Languages",
          internships: "Internships",
        },
        experience: [
          {
            id: 1,
            role: "Project Manager",
            company: "EMIRAT AG",
            location: "Munich, Germany",
            period: "2023 - 2024",
            desc: "<ul><li>Led a 4-member agile team, accelerating delivery by 25%.</li><li>Built automation systems with Notion, ChatGPT, Zapier, and Excel.</li><li>Accelerated project delivery by 25% using agile sprint optimizations.</li><li>Secured new clients, expanding market footprint during probation.</li><li>Achieved 100% invoice accuracy and streamlined project management workflows.</li></ul>",
            highlights: ["25% Faster Delivery", "Automation Systems", "Agile Optimization"],
            gallery: [],
          },
          {
            id: 2,
            role: "Business Dev Manager",
            company: "NAOTILUS GmbH",
            location: "Munich, Germany",
            period: "2022 - 2023",
            desc: "<ul><li>Owned end-to-end strategy for a new B2B SaaS platform.</li><li>Created business case, securing €500K+ funding and 5 pilots.</li><li>Managed product lifecycle from ideation to market validation.</li><li>Led IoT data strategies for operational synergy and workflows.</li></ul>",
            highlights: ["€500K+ Funding", "5 Pilots Secured", "SaaS Strategy"],
            gallery: [],
          },
          {
            id: 3,
            role: "Business Analyst",
            company: "MBI Business Innovation",
            location: "Munich, Germany",
            period: "2019 - 2020",
            desc: "<ul><li>Co-founded and launched a new B2B HR Tech platform.</li><li>Led 50+ customer interviews for product discovery and validation.</li><li>Developed go-to-market strategy, securing key industry partnerships.</li><li>Steered product adoption by pitching at 10+ industry events.</li></ul>",
            highlights: ["HR Tech Launch", "50+ Interviews", "Go-to-Market"],
            gallery: [],
          },
          {
            id: 4,
            role: "QA/QC Engineer / Site Manager",
            company: "Advance Vision",
            location: "Jeddah, KSA",
            period: "2014 - 2016",
            desc: "<i>(Projects: King Abdullah Holy Haram Expansion & King Abdulaziz International Airport - $31Bn)</i><br><br><ul><li>Conducted 350+ weekly inspections strictly adherent to ISO compliance.</li><li>Managed supplier coordination with major brands like ABB & Schneider.</li><li>Managed 75+ technicians on mega-construction projects, reducing rework costs by 20%.</li><li>Drove ISO 9001 compliance and automated QA/QC workflows.</li><li>Accelerated timelines by 30% through supplier coordination (ABB, Schneider).</li><li>Averted operational risks, preventing a two-month project outage.</li></ul>",
            highlights: ["75+ Team Lead", "ISO 9001", "Mega Projects"],
            gallery: [],
          },
          {
            id: 5,
            role: "Requirements Engineer (Work Student)",
            company: "Infineon Technologies",
            location: "Munich, GE",
            period: "2018 - 2019",
            desc: "<ul><li>Reduced documentation release time by 30% for 100+ users.</li><li>Managed Requirements Driven Dev Flow Process documentation using MS Word, Confluence & JIRA.</li><li>Streamlined content management systems to improve team efficiency.</li></ul>",
            highlights: ["30% Time Reduction", "Process Documentation"],
            gallery: [],
          },
          {
            id: 6,
            role: "Content Specialist Automotive (Work Student)",
            company: "Consline AG",
            location: "Munich, GE",
            period: "2017 - 2018",
            desc: "<ul><li>Transformed raw customer voices into strategic market insights.</li><li>Led CIMS data refinement for UK & Germany automotive segments.</li><li>Secured Aston Martin as long-term client through data excellence.</li></ul>",
            highlights: ["Strategic Insights", "Aston Martin Client"],
            gallery: [],
          }
        ],
        education: [
          {
            id: 1,
            role: "M.A. Entrepreneurship & Digital Transformation",
            company: "Hochschule Munich (HM)",
            location: "Germany",
            period: "2020 - 2022",
            desc: "<ul><li>Grade: 2.2</li><li>Thesis: IoT & Asset Management in Energy Systems</li></ul>",
            highlights: [],
            gallery: [],
            media: []
          },
          {
            id: 2,
            role: "B.Sc. Electrical Engineering",
            company: "University of Lahore (UOL)",
            location: "Pakistan",
            period: "2009 - 2013",
            desc: "<ul><li>CGPA: 3.01</li><li>Thesis: Automated Control for Gas-Driven Devices</li></ul>",
            highlights: [],
            gallery: [],
            media: []
          }
        ],
        volunteer: [
          {
            id: 1,
            event: "Events and Concert Management",
            org: "Werksviertel-Mitte Foundation Projects GmbH",
            year: "March 2024",
            desc: "<ul><li>Primarily took on the setup and teardown of the entire concert seating.</li><li>Assisted with admission, electronics, sound system, wiring and complete stage set-up.</li></ul><br><b>Details:</b> Employed from May 1 to June 20, 2024 as a volunteer/mini-jobber. Avg 38h/month.<br><b>Location:</b> Munich.",
            media: []
          },
          {
            id: 2,
            event: "Intercultural Workshop",
            org: "Student Union Munich & LMU",
            year: "November 2019",
            desc: "<b>Topics Covered:</b><ul><li>Influence of culture & Cultural awareness</li><li>Values & Communication styles</li><li>Cultural standards and differences</li><li>Conflict Management</li></ul><br><b>Aim:</b> To sensitize participants to cultural differences and help them handle conflicts.",
            media: []
          },
          {
            id: 3,
            event: "Certificate of Appreciation (Best Volunteer)",
            org: "STARTUP SAFARI MUNICH",
            year: "October 2019",
            desc: "In appreciation for dedication and devotion for STARTUP SAFARI Munich 2019. The contribution and dedication to the event was highly valued. <br><b>Award:</b> Awarded as the Best volunteer in the event.",
            media: []
          },
          {
            id: 4,
            event: "Tutor at Hall of Residence",
            org: "Munich Student Union (Studentenwerk München)",
            year: "May 2019",
            desc: "<ul><li>Elected as a tutor by 150 dorm residents (Felsennelkenanger) with 100% commitment.</li><li>Actively contributed to the student self-administration committee.</li><li>Facilitated communal living and integration among diverse residents.</li><li>Organized sports and events for 550 residents.</li></ul>",
            media: []
          },
          {
            id: 5,
            event: "Buddy for Refugees",
            org: "Technical University of Munich (TUM)",
            year: "June 2018",
            desc: "Part of the emergency response initiative for asylum seekers at TUM.<br><b>Responsibilities:</b><ul><li>Personal contact and academic advice</li><li>Integration into the university environment</li><li>Promotion of language skills & Bridge to society</li></ul><br><b>Recognition:</b> Deeply appreciated by Executive Vice President Prof. Dr. Gerhard Müller for significant contribution to the program's success.",
            media: []
          },
          {
            id: 6,
            event: "Certificate of Recognition",
            org: "Year of the X",
            year: "April 2018",
            desc: "For significant contribution and dedication at the Innovation and Startup festival 'Year of the Dog'.",
            media: []
          }
        ],
        projects: [
          {
            id: 1,
            title: "AI-Driven Expense Agent",
            shortDesc: "Autonomous AI agent for travel cost tracking and OCR parsing.",
            longDesc: "Designed and deployed an autonomous agent for travel cost tracking. Implemented OCR parsing for automated bill/receipt intelligence and integrated Google Workspace for real-time compliance.",
            company: "Independent",
            year: "2024",
            link: "",
            skills: ["AI Agents", "OCR Parsing", "Automation", "Python"],
            tools: ["Zapier", "OpenAI API", "Google Workspace"],
            images: ["https://images.unsplash.com/photo-1554224155-8d04cb21cd6c?w=600","https://images.unsplash.com/photo-1620712943543-bcc4688e7485?w=600"],
            videos: [],
            pdfs: [],
          },
          {
            id: 2,
            title: "SaaS Lean Business Plan",
            shortDesc: "Concept for no-code digital twin SaaS platform.",
            longDesc: "Conceptualized lean business plan for no-code digital twin SaaS platform (Naotilus GmbH). Combined market analysis and stakeholder interviews for go-to-market strategy and validated EU energy sector scaling.",
            company: "Naotilus GmbH",
            year: "2023",
            link: "",
            skills: ["Product Strategy", "Market Analysis", "Business Modeling"],
            tools: ["Lean Canvas", "Excel", "PowerBI"],
            images: ["https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=600","https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=600"],
            videos: [],
            pdfs: [],
          },
          {
            id: 3,
            title: "Gamified Learning Platform",
            shortDesc: "3D training platform scalable to 293K employees.",
            longDesc: "Led design of gamified training platform for Siemens AG. Achieved 90% user satisfaction in prototype testing and implemented Agile workflows to manage project milestones.",
            company: "Siemens AG",
            year: "2022",
            link: "",
            skills: ["Gamification", "Agile", "UX Research"],
            tools: ["JIRA", "Unity", "Figma"],
            images: ["https://images.unsplash.com/photo-1556761175-5973dc0f32e7?w=600","https://images.unsplash.com/photo-1519389950473-47ba0277781c?w=600"],
            videos: [],
            pdfs: [],
          },
          {
            id: 4,
            title: "IoT Gas Flow Controller",
            shortDesc: "Automated control for gas-driven devices using microcontrollers.",
            longDesc: "Designed IoT gas flow controller using PIC16F877A. Enabled automated, electricity-free gas control for off-grid applications with integrated RF remote input.",
            company: "Academic",
            year: "2013",
            link: "",
            skills: ["IoT", "Embedded Systems", "Hardware Design"],
            tools: ["C++", "Microcontrollers", "AutoCAD"],
            images: ["https://images.unsplash.com/photo-1518770660439-4636190af475?w=600","https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?w=600"],
            videos: [],
            pdfs: [],
          },
          {
            id: 5,
            title: "Portfolio Development",
            shortDesc: "Personal portfolio with 3D assets and dynamic content.",
            longDesc: "Developed multiple portfolio iterations (V1, V2, V3) showcasing structure. Created interactive web assets like Saturn Gyroscope and cursor effects using Javascript/CSS/HTML.",
            company: "Personal",
            year: "2024",
            link: "https://mjabid.work.gd/",
            skills: ["Web Dev", "UI/UX", "3D Rendering"],
            tools: ["React", "Three.js", "Tailwind"],
            images: [],
            videos: [],
            pdfs: [],
          }
        ],
        skills: [
          // Project Management & Collaboration
          { name: "JIRA", back: "Issue tracking and agile project management." },
          { name: "Confluence", back: "Team workspace and documentation." },
          { name: "Asana", back: "Work management and project tracking." },
          { name: "Trello", back: "Kanban-style project organization." },
          { name: "ClickUp", back: "All-in-one productivity platform." },
          { name: "Zoho", back: "Suite of online productivity tools and SaaS applications." },
          { name: "Notion", back: "All-in-one workspace for notes, tasks, and wikis." },
          { name: "Monday.com", back: "Cloud-based platform for work management." },
          { name: "MS Teams", back: "Business communication and collaboration." },
          { name: "Slack", back: "Channel-based messaging platform." },
          { name: "Discord", back: "VoIP and instant messaging social platform." },
          { name: "Skype", back: "Telecommunications application for video calls." },
          { name: "Zoom", back: "Video conferencing and virtual meeting platform." },
          { name: "Google Meet", back: "Video-communication service by Google." },
          { name: "MS Outlook", back: "Personal information manager and email client." },

          // Design & Whiteboarding
          { name: "Miro", back: "Online collaborative whiteboard platform." },
          { name: "Mural", back: "Digital workspace for visual collaboration." },
          { name: "Figma", back: "Vector graphics editor and prototyping tool." },
          { name: "Canva", back: "Graphic design platform for visual content." },

          // Engineering & Development
          { name: "AutoCAD", back: "Computer-aided design (CAD) and drafting software." },
          { name: "MATLAB", back: "Numeric computing environment and programming." },
          { name: "Python", back: "Programming language for automation and AI." },
          { name: "HTML/CSS", back: "Standard markup and style sheet languages for web." },
          { name: "GitHub", back: "Version control and source code management." },
          { name: "Formspree.io", back: "Form backend service for handling submissions." },
          { name: "Web3forms", back: "Contact forms for static websites." },

          // Business & CRM
          { name: "HubSpot", back: "CRM platform for inbound marketing and sales." },
          { name: "Microsoft Office Suite", back: "Productivity software (Word, Excel, PowerPoint)." },

          // AI & Automation Tools
          { name: "ChatGPT", back: "Conversational AI model by OpenAI." },
          { name: "Claude", back: "Next-generation AI assistant by Anthropic." },
          { name: "Gemini 3 Pro", back: "Google's most capable multimodal AI model." },
          { name: "MS365 Co-Pilot", back: "AI assistant integrated into Microsoft 365 apps." },
          { name: "DeepSeek", back: "Advanced open-source LLM for coding and logic." },
          { name: "Grok", back: "AI chatbot developed by xAI." },
          { name: "Google AI Studio", back: "Prototyping environment for generative models." },
          { name: "Zapier", back: "Workflow automation between web applications." },
          { name: "n8n", back: "Workflow automation tool for technical users." },
          { name: "SORA", back: "Text-to-video model by OpenAI." },
          { name: "Gamma AI", back: "AI-powered medium for presenting ideas." },
          { name: "Dreamina AI", back: "AI art and image generation tool." },
          { name: "WanAI", back: "AI platform for advanced digital solutions." },
          { name: "Twain GPT", back: "AI communication assistant for sales." },
          { name: "Nano Banana Pro", back: "Specialized AI model for niche tasks." },
          { name: "RoboNeo", back: "AI robotics simulation and control." },
          { name: "Fish.audio", back: "AI text-to-speech and audio generation." },
          { name: "String.com", back: "AI-driven messaging and analytics." },
          { name: "Google Whisk", back: "AI-powered recipe and food ecosystem." },
          { name: "LMarena AI", back: "Benchmarking platform for Large Language Models." },
          { name: "AI-Virtual Agents", back: "Development of autonomous digital support agents." }
        ],
        socialLinks: [
          {
            id: 1,
            icon: "fa-brands fa-linkedin-in",
            url: "https://www.linkedin.com/in/chaudhrymj/",
            label: "LinkedIn",
            x: 20,
            y: 30,
            scale: 1,
            color: "#ffffff",
          },
          {
            id: 2,
            icon: "fa-brands fa-github",
            url: "https://github.com/J-Abid",
            label: "GitHub",
            x: 40,
            y: 30,
            scale: 1,
            color: "#ffffff",
          },
          {
            id: 3,
            icon: "fa-brands fa-xing",
            url: "https://www.xing.com/profile/Junaid_Abid/web_profiles?nwt_nav=profile&expandNeffi=true",
            label: "Xing",
            x: 60,
            y: 30,
            scale: 1,
            color: "#ffffff",
          },
          {
            id: 4,
            icon: "fa-solid fa-globe",
            url: "https://mjabid.work.gd/",
            label: "Portfolio",
            x: 80,
            y: 30,
            scale: 1,
            color: "#06b6d4",
          }
        ],
        publications: [
           {
            id: 1,
            title: "Omics Approaches in Marine Biotechnology",
            abstract: "Contributed to research on marine biotechnology approaches.",
            desc: "Published in Elsevier (2018). DOI: 10.1016/B978-0-12-804659-3.00003-8",
            authors: "Abid, Fatima, Zahid, et al.",
            conference: "Elsevier",
            year: "2018",
            url: "https://doi.org/10.1016/B978-0-12-804659-3.00003-8",
            media: []
           }
        ],
        certifications: [
          {
            id: 1,
            name: "Certified AI Fluent Leadership Professional",
            org: "Calyptus",
            year: "November 2025",
            url: "https://certificate.calyptus.co/ai-fluency/1501-junaid-abid",
            desc: "<ul><li>I am now an AI Fluency Leadership Professional Certified by Calyptus! 🎉</li><li>Proud to be in the top 5% of talent!</li><li>Credential ID: 1501</li></ul>",
            media: []
          },
          {
            id: 2,
            name: "Plant Materials and Clinical Validation in Diabetes Management",
            org: "OIC-COMSTECH",
            year: "November 2025",
            url: "",
            desc: "<ul><li>Virtual Participation in the 8th ANRAP & OIC-COMSTECH Regional Seminar 2025.</li><li>Topic: “Plant Materials and Their Clinical Validation in the Management of Diabetes and Metabolic Disorders: Challenges and Scope.”</li><li>Organized by OIC-COMSTECH.</li><li>Held on 18th & 19th November, 2025.</li></ul>",
            media: []
          },
          {
            id: 3,
            name: "Optical Forces on Atoms",
            org: "OIC-COMSTECH",
            year: "October 2025",
            url: "",
            desc: "<ul><li>Virtual Participation in the COMSTECH-Lecture Series on “Optical Forces on Atoms.”</li><li>Organized by OIC-COMSTECH.</li><li>Held on 20-24th October, 2025.</li></ul>",
            media: []
          },
          {
            id: 4,
            name: "Applied Biomedical AI",
            org: "OIC-COMSTECH & Ningbo University (China)",
            year: "August 2025",
            url: "",
            desc: "<ul><li>Virtual participation in the Certificate Course on Applied Biomedical AI.</li><li>Organized by OIC-COMSTECH.</li><li>Held on 23rd - 31st July & 11th - 27th August, 2025.</li></ul>",
            media: []
          },
          {
            id: 5,
            name: "Hackathon Enablement Session",
            org: "IBM",
            year: "July 2025",
            url: "https://www.virtualbadge.io/certificate-validator?credential=46116cdf-ab44-4615-9a68-6aa5687033db",
            desc: "<ul><li>Prepared for the AI and Automation Unpacked Hackathon.</li><li>Received Certificate of Completion in virtual Conference and Webinar series.</li><li>Credential ID: 46116cdf-ab44-4615-9a68-6aa5687033db</li></ul>",
            media: []
          },
          {
            id: 6,
            name: "AI & Automation Unpacked",
            org: "IBM",
            year: "July 2025",
            url: "https://www.virtualbadge.io/certificate-validator?credential=40fca765-948a-42d9-ba70-3c949f85ad26",
            desc: "<ul><li>Participated at IBM TechXchange Dev Day: AI & Automation Unpacked.</li><li>Received Certificate of Participation.</li><li>Credential ID: 40fca765-948a-42d9-ba70-3c949f85ad26</li></ul>",
            media: []
          },
          {
            id: 7,
            name: "Cooking with Granite: Hands-on with IBM's Open Source LLMs",
            org: "IBM",
            year: "April 2025",
            url: "https://www.virtualbadge.io/certificate-validator?credential=417249b0-b72f-4e08-a963-c0c77c4344ac",
            desc: "<ul><li>Gained hands-on experience with IBM's Open Source LLMs.</li><li>Received Certificate of Completion.</li><li>Credential ID: 417249b0-b72f-4e08-a963-c0c77c4344ac</li></ul>",
            media: []
          },
          {
            id: 8,
            name: "IBM TechXchange Dev Day: Open Source LLMs",
            org: "IBM",
            year: "April 2025",
            url: "https://www.virtualbadge.io/certificate-validator?credential=12cee73c-6122-4383-954a-d8d5e2a51e6d",
            desc: "<ul><li>Participated at IBM TechXchange Dev Day: Open Source LLMs.</li><li>Received Certificate of Participation.</li><li>Credential ID: 12cee73c-6122-4383-954a-d8d5e2a51e6d</li></ul>",
            media: []
          },
          {
            id: 9,
            name: "Built a Virtual Agent (Certificate of Completion)",
            org: "IBM",
            year: "January 2025",
            url: "https://www.virtualbadge.io/certificate-validator?credential=22bc729c-2e41-46d8-b673-861905091714",
            desc: "<ul><li>Built a virtual agent at IBM TechXchange Dev Day: Virtual Agents.</li><li>Received Certificate of Completion.</li><li>Credential ID: 22bc729c-2e41-46d8-b673-861905091714</li></ul>",
            media: []
          },
          {
            id: 10,
            name: "IBM TechXchange Dev Day: Virtual Agents (Participation)",
            org: "IBM",
            year: "January 2025",
            url: "https://www.virtualbadge.io/certificate-validator?credential=4ea2e7c6-6b4f-4411-bb12-d77822c5a2d5",
            desc: "<ul><li>Certificate of Participation for IBM TechXchange Dev Day: Virtual Agents.</li><li>Credential ID: 4ea2e7c6-6b4f-4411-bb12-d77822c5a2d5</li></ul>",
            media: []
          },
          {
            id: 11,
            name: "Certified Product/Project Manager",
            org: "Micro1",
            year: "December 2024",
            url: "https://www.talent.micro1.ai/",
            desc: "<ul><li>Successfully passed Micro1's AI Interview.</li><li>Validated skills in Product and Project Management.</li></ul>",
            media: []
          },
          {
            id: 12,
            name: "ISO 9001:2015: Auditor/Lead Auditor",
            org: "International Accreditation Services (USA)",
            year: "October 2020",
            url: "",
            desc: "<ul><li>Certified in ISO Quality Management Systems.</li><li>Role: Auditor/Lead Auditor.</li></ul>",
            media: []
          },
          {
            id: 13,
            name: "Data Protection",
            org: "Infineon Technologies",
            year: "August 2019",
            url: "",
            desc: "<ul><li>Certificate of Participation in training: Managing Careers for the Future.</li></ul>",
            media: []
          },
          {
            id: 14,
            name: "Occupation Health and Safety Training (Am-Campeon)",
            org: "Infineon Technologies",
            year: "March 2019",
            url: "",
            desc: "<ul><li>Certificate of Participation in training: Managing Careers for the Future.</li></ul>",
            media: []
          },
          {
            id: 15,
            name: "Business Conduct Guidelines - English",
            org: "Infineon Technologies",
            year: "October 2018",
            url: "",
            desc: "<ul><li>Certificate of Participation in training: Managing Careers for the Future.</li></ul>",
            media: []
          },
          {
            id: 16,
            name: "Occupation Health and Safety Training (Am-Campeon)",
            org: "Infineon Technologies",
            year: "October 2018",
            url: "",
            desc: "<ul><li>Certificate of Participation in training: Managing Careers for the Future.</li></ul>",
            media: []
          },
          {
            id: 17,
            name: "Information Security - English",
            org: "Infineon Technologies",
            year: "October 2018",
            url: "",
            desc: "<ul><li>Certificate of Participation in training: Managing Careers for the Future.</li></ul>",
            media: []
          }
        ],
        licenses: [
          {
            id: 1,
            name: "Registered Engineer",
            authority: "Saudi Council of Engineers (SCE)",
            year: "2014",
            url: "",
            media: []
          },
          {
            id: 2,
            name: "Professional Engineer",
            authority: "Pakistan Engineering Council (PEC)",
            year: "2013",
            url: "",
            media: []
          },
          {
            id: 3,
            name: "Production/Plant Engineer",
            authority: "Engineers Australia",
            year: "2016",
            url: "",
            media: []
          }
        ],
        internships: [
          {
            id: 1,
            org: "Pakistan Television Corporation Limited",
            role: "Internee Electrical Engineer",
            duration: "15 September 2013 - 01 November 2013",
            desc: "<ul><li><b>R&D:</b> Study and understanding of the entire working and operation of the Main Control Room(MCR), broadcasting of live shows & the whole transmission process of PTV Home, PTV Global, and PTV Sports.</li><li><b>Operations:</b> Electrical equipment maintenance and operation.</li></ul>",
            media: []
          },
          {
            id: 2,
            org: "MKN Constructing Engineer",
            role: "Trainee Electrical Engineer",
            duration: "01 August 2011 - 31 October 2013",
            desc: "<ul><li><b>Site Supervision:</b> Supervise & install all electrical works and components in and outside the building during construction.</li><li><b>Construction Drawing:</b> Understand and review as-built drawings, design drawings, shop drawings, building schedules, engineering plans, and specifications.</li></ul>",
            media: []
          },
          {
            id: 3,
            org: "Pakistan Telecommunication Company Limited. (PTCL.Official)",
            role: "Internee Electrical Engineer",
            duration: "30 July 2012 - 10 September 2012",
            desc: "<b>RESPONSIBILITIES:</b><ul><li><b>Customer Service:</b> Provide services to the customers of the company.</li><li><b>Complaint Management:</b> Resolve different customer complaints on NMS and understand the working of CLI and NMS software of Huawei, Alcatel, and ZTE.</li></ul>",
            media: []
          },
          {
            id: 4,
            org: "Attock Refinery Limited (ARL)",
            role: "Internee Electrical Engineer",
            duration: "16 July 2012 - 15 August 2012",
            desc: "<ul><li><b>R&D:</b> Learn the usage & working of industrial hardware and electronic devices at a large scale.</li><li><b>SCADA System:</b> Study in detail the work of the SCADA system in the Central Control Room (CCR) and Central Control Management (CCM).</li><li><b>Power Plant Survey:</b> Understand the layout and working of the Attock Generation Limited (AGL) plant.</li></ul>",
            media: []
          }
        ],
        languages: [
          {
            id: 1,
            name: "English",
            level: "C1/C2 (Fluent)",
            percentage: 95,
            certificate: null,
          },
          {
            id: 2,
            name: "German",
            level: "A2/B1",
            percentage: 40,
            certificate: null,
          },
          {
            id: 3,
            name: "Urdu/Punjabi",
            level: "Native",
            percentage: 100,
            certificate: null,
          },
        ],
        securityQuestion: {
          question: "What was the name of your first pet?",
          answer: "admin",
        },
      };

      // --- SECURITY UPDATE START ---
      const ADMIN_CONFIG = {
        // PASTE YOUR LONG SCRAMBLED EMAIL CODE INSIDE THE QUOTES BELOW:
        emailHash:
          "477c173b9538dd856e035a311507d7d642c3f6e969d47985acfd9db094242671",

        // PASTE YOUR LONG SCRAMBLED PASSWORD CODE INSIDE THE QUOTES BELOW:
        passHash:
          "4283972414a30194d4950bcbc9428f110c93b4f2fa1a51baecf5d0854db66462",
      };

      // Helper function to scramble input for comparison
      async function hashInput(string) {
        const encoder = new TextEncoder();
        const data = encoder.encode(string);
        const hashBuffer = await crypto.subtle.digest("SHA-256", data);
        return Array.from(new Uint8Array(hashBuffer))
          .map((b) => b.toString(16).padStart(2, "0"))
          .join("");
      }
      // --- SECURITY UPDATE END ---
      const CONTACT_FORM_URL = "https://formspree.io/f/xzzngoqy"; // Change this if needed
      const presetColors = [
        "#06b6d4",
        "#a855f7",
        "#10b981",
        "#f59e0b",
        "#ef4444",
        "#ec4899",
        "#6366f1",
        "#14b8a6",
        "#8b5cf6",
        "#f97316",
      ];

      // === DRAG AND RESIZE HOOK & COMPONENT ===
      const useDraggable = (
        initialX,
        initialY,
        initialScale,
        onUpdate,
        isEnabled
      ) => {
        const [pos, setPos] = useState({ x: initialX || 0, y: initialY || 0 });
        const [scale, setScale] = useState(initialScale || 1);
        const [isDragging, setIsDragging] = useState(false);
        const [isResizing, setIsResizing] = useState(false);

        const ref = useRef(null);
        const startRef = useRef({ x: 0, y: 0, w: 0, h: 0 });

        useEffect(() => {
          if (!isEnabled) return;

          const handleMouseMove = (e) => {
            if (isDragging) {
              // Calculate percentage based on parent container
              const parent = ref.current.parentElement.getBoundingClientRect();
              const dx = e.clientX - startRef.current.mx;
              const dy = e.clientY - startRef.current.my;

              const percentX = Math.min(
                Math.max(0, startRef.current.x + (dx / parent.width) * 100),
                100
              );
              const percentY = Math.min(
                Math.max(0, startRef.current.y + (dy / parent.height) * 100),
                100
              );

              setPos({ x: percentX, y: percentY });
            } else if (isResizing) {
              const dx = e.clientX - startRef.current.mx;
              // Simple uniform scaling based on drag distance
              const newScale = Math.max(
                0.5,
                Math.min(3, startRef.current.s + dx * 0.01)
              );
              setScale(newScale);
            }
          };

          const handleMouseUp = () => {
            if (isDragging || isResizing) {
              setIsDragging(false);
              setIsResizing(false);
              onUpdate(pos.x, pos.y, scale);
            }
          };

          window.addEventListener("mousemove", handleMouseMove);
          window.addEventListener("mouseup", handleMouseUp);
          return () => {
            window.removeEventListener("mousemove", handleMouseMove);
            window.removeEventListener("mouseup", handleMouseUp);
          };
        }, [isDragging, isResizing, pos, scale, isEnabled]);

        const startDrag = (e) => {
          if (!isEnabled) return;
          e.preventDefault();
          e.stopPropagation();
          setIsDragging(true);
          startRef.current = {
            mx: e.clientX,
            my: e.clientY,
            x: pos.x,
            y: pos.y,
          };
        };

        const startResize = (e) => {
          if (!isEnabled) return;
          e.preventDefault();
          e.stopPropagation();
          setIsResizing(true);
          startRef.current = { mx: e.clientX, my: e.clientY, s: scale };
        };

        return {
          ref,
          pos,
          scale,
          startDrag,
          startResize,
          isDragging,
          isResizing,
        };
      };

      const DraggableItem = ({
        children,
        x,
        y,
        s,
        onUpdate,
        isAdmin,
        tooltip,
        className,
      }) => {
        const {
          ref,
          pos,
          scale,
          startDrag,
          startResize,
          isDragging,
          isResizing,
        } = useDraggable(x, y, s, onUpdate, isAdmin);

        const style = {
          left: `${pos.x}%`,
          top: `${pos.y}%`,
          transform: `translate(-50%, -50%) scale(${scale})`,
        };

        return (
          <div
            ref={ref}
            className={`draggable-item-wrapper ${isAdmin ? "admin-mode" : ""} ${
              isDragging ? "grabbing" : ""
            } ${className || ""}`}
            style={style}
            onMouseDown={isAdmin ? startDrag : undefined}
          >
            {children}
            {!isAdmin && tooltip && (
              <div className="custom-tooltip">{tooltip}</div>
            )}
            {isAdmin && (
              <div
                className="resize-handle"
                onMouseDown={startResize}
                title="Drag to scale"
              />
            )}
          </div>
        );
      };

      // === ADVANCED SATURN SCENE ===
      const AdvancedSaturn = ({ theme }) => {
        const mountRef = useRef(null);
        const themeRef = useRef(theme);
        const state = useRef({
          drag: false,
          prev: { x: 0, y: 0 },
          vel: { x: 0, y: 0 },
        });
        const objs = useRef({
          scene: null,
          renderer: null,
          planet: null,
          rGroup: null,
          neutronGroup: null,
          neptuneGroup: null,
          lGroup: null,
        });

        useEffect(() => {
          themeRef.current = theme;
        }, [theme]);

        const getRandVec = () => {
          const v = new THREE.Vector3(
            Math.random() - 0.5,
            Math.random() - 0.5,
            Math.random() - 0.5
          );
          return v.normalize();
        };

        const createBolt = (
          start,
          end,
          segmentCount,
          offsetAmount,
          colHex,
          thick
        ) => {
          const points = [];
          points.push(start);
          for (let i = 1; i < segmentCount; i++) {
            const t = i / segmentCount;
            const base = new THREE.Vector3().lerpVectors(start, end, t);
            if (base.length() < 4.0) base.normalize().multiplyScalar(4.0);
            const jitter = getRandVec().multiplyScalar(offsetAmount);
            points.push(base.add(jitter));
          }
          points.push(end);

          const curve = new THREE.CatmullRomCurve3(points);
          const geom = new THREE.TubeGeometry(curve, 8, thick * 0.15, 3, false);
          const mat = new THREE.MeshBasicMaterial({
            color: new THREE.Color(colHex),
            transparent: true,
            opacity: 1.0,
            side: THREE.DoubleSide,
            blending: THREE.AdditiveBlending,
            depthTest: false,
          });

          const mesh = new THREE.Mesh(geom, mat);
          mesh.renderOrder = 9999;
          mesh.frustumCulled = false;
          return mesh;
        };

        useEffect(() => {
          if (!mountRef.current || !window.THREE) return;
          const mount = mountRef.current;
          const width = mount.clientWidth;
          const height = 600;

          const scene = new THREE.Scene();
          const camera = new THREE.PerspectiveCamera(
            45,
            width / height,
            0.1,
            1000
          );
          camera.position.z = 25;

          const renderer = new THREE.WebGLRenderer({
            alpha: true,
            antialias: true,
          });
          renderer.setSize(width, height);
          renderer.setPixelRatio(window.devicePixelRatio);
          renderer.toneMapping = THREE.ACESFilmicToneMapping;
          renderer.toneMappingExposure = 1.2;
          mount.appendChild(renderer.domElement);

          const planetMat = new THREE.MeshStandardMaterial({
            color: theme.pBase,
            emissive: theme.pGlow,
            emissiveIntensity: 0.8,
            roughness: theme.pRough,
            metalness: theme.pMetal,
          });
          const planet = new THREE.Mesh(
            new THREE.SphereGeometry(3.5, 64, 64),
            planetMat
          );
          const pGroup = new THREE.Group();
          pGroup.add(planet);
          const rGroup = new THREE.Group();
          pGroup.add(rGroup);
          scene.add(pGroup);

          const neutronGroup = new THREE.Group();
          neutronGroup.add(
            new THREE.Mesh(
              new THREE.SphereGeometry(1.2, 32, 32),
              new THREE.MeshBasicMaterial({
                color: 0xffffff,
                toneMapped: false,
              })
            )
          );
          neutronGroup.add(
            new THREE.Mesh(
              new THREE.SphereGeometry(2.0, 32, 32),
              new THREE.MeshBasicMaterial({
                color: 0x00f0ff,
                transparent: true,
                opacity: 0.3,
                blending: THREE.AdditiveBlending,
                side: THREE.BackSide,
              })
            )
          );
          const beamGeo = new THREE.ConeGeometry(0.8, 40, 32, 1, true);
          const beamMat = new THREE.MeshBasicMaterial({
            color: 0x00f0ff,
            transparent: true,
            opacity: 0.4,
            blending: THREE.AdditiveBlending,
            side: THREE.DoubleSide,
            depthWrite: false,
          });
          const topBeam = new THREE.Mesh(beamGeo, beamMat);
          topBeam.position.y = 20;
          neutronGroup.add(topBeam);
          const botBeam = new THREE.Mesh(beamGeo, beamMat);
          botBeam.rotation.x = Math.PI;
          botBeam.position.y = -20;
          neutronGroup.add(botBeam);
          scene.add(neutronGroup);

          const neptuneGroup = new THREE.Group();
          neptuneGroup.add(
            new THREE.Mesh(
              new THREE.SphereGeometry(3.5, 64, 64),
              new THREE.MeshLambertMaterial({ color: theme.neptuneColA })
            )
          );
          neptuneGroup.add(
            new THREE.Mesh(
              new THREE.SphereGeometry(3.6, 64, 64),
              new THREE.MeshLambertMaterial({
                color: theme.neptuneColB,
                transparent: true,
                opacity: 0.4,
                blending: THREE.AdditiveBlending,
                side: THREE.DoubleSide,
              })
            )
          );
          scene.add(neptuneGroup);

          const lGroup = new THREE.Group();
          scene.add(lGroup);

          const createParticles = (count, size, col, spread) => {
            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(count * 3);
            for (let i = 0; i < count * 3; i++)
              pos[i] = (Math.random() - 0.5) * spread;
            geo.setAttribute("position", new THREE.BufferAttribute(pos, 3));
            return new THREE.Points(
              geo,
              new THREE.PointsMaterial({
                size,
                color: col,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending,
              })
            );
          };
          // Optimize particle count for mobile
          const isMobile = window.innerWidth < 768;
          const starCount = isMobile ? 500 : 2000;
          const asteroidCount = isMobile ? 100 : 500;
          const nebulaCount = isMobile ? 50 : 200;

          const stars = createParticles(starCount, 0.1, 0xffffff, 100);
          scene.add(stars);
          const asteroids = createParticles(asteroidCount, 0.08, 0x888888, 40);
          scene.add(asteroids);
          const nebula = createParticles(nebulaCount, 4.0, theme.nebColor, 80);
          scene.add(nebula);
          const sGroup = new THREE.Group();
          scene.add(sGroup);

          const dirLight = new THREE.DirectionalLight(0xffffff, 2.0);
          dirLight.position.set(10, 10, 20);
          scene.add(dirLight);
          const blueLight = new THREE.PointLight(0x00f0ff, 1, 50);
          blueLight.position.set(-10, -5, 10);
          scene.add(blueLight);
          scene.add(new THREE.AmbientLight(0x404040, 0.5));

          objs.current = {
            scene,
            camera,
            renderer,
            planet,
            rGroup,
            stars,
            asteroids,
            nebula,
            sGroup,
            neutronGroup,
            neptuneGroup,
            lGroup,
            pGroup,
          };

          // PASTE THIS NEW BLOCK INSTEAD
          const handleDown = (x, y, target) => {
            if (mount.contains(target)) {
              state.current.drag = true;
              state.current.prev = { x, y };
            }
          };
          const handleMove = (x, y) => {
            if (state.current.drag) {
              state.current.vel.y += (x - state.current.prev.x) * 0.0005;
              state.current.vel.x += (y - state.current.prev.y) * 0.0005;
              state.current.prev = { x, y };
            }
          };
          const onUp = () => (state.current.drag = false);

          const onMouseDown = (e) => handleDown(e.clientX, e.clientY, e.target);
          const onMouseMove = (e) => handleMove(e.clientX, e.clientY);
          const onTouchStart = (e) => {
            if (e.touches.length > 0)
              handleDown(e.touches[0].clientX, e.touches[0].clientY, e.target);
          };
          const onTouchMove = (e) => {
            if (e.touches.length > 0)
              handleMove(e.touches[0].clientX, e.touches[0].clientY);
          };

          window.addEventListener("mousedown", onMouseDown);
          window.addEventListener("mouseup", onUp);
          window.addEventListener("mousemove", onMouseMove);
          window.addEventListener("touchstart", onTouchStart, {
            passive: true,
          });
          window.addEventListener("touchend", onUp, { passive: true });
          window.addEventListener("touchmove", onTouchMove, { passive: true });

          let animationId;
          const animate = () => {
            animationId = requestAnimationFrame(animate);
            
            // FIX: Pause 3D Engine in Admin Mode
            if (document.body.classList.contains('admin-mode')) {
              animationId = requestAnimationFrame(animate);
              return;
            }
            
            const currentTheme = themeRef.current;
            const spd = currentTheme.rotSpeed || 1;

            if (!state.current.drag) {
              state.current.vel.x *= 0.95;
              state.current.vel.y *= 0.95;
              pGroup.rotation.y += 0.002 * spd;
            }
            pGroup.rotation.y += state.current.vel.y;
            pGroup.rotation.x += state.current.vel.x;

            if (rGroup.children.length === 3) {
              if (currentTheme.gyroPattern) {
                rGroup.children[0].rotation.z += 0.01 * spd;
                rGroup.children[1].rotation.z -= 0.008 * spd;
                rGroup.children[2].rotation.z += 0.012 * spd;
              } else {
                rGroup.children.forEach((r, i) => {
                  r.rotation.z += (i % 2 === 0 ? 0.01 : -0.008) * spd;
                  r.rotation.x =
                    Math.PI / 2 + Math.sin(Date.now() * 0.001 * (i + 1)) * 0.1;
                });
              }
            }

            stars.rotation.y -= 0.0001;
            asteroids.rotation.y -= 0.0005 * spd;
            nebula.rotation.y += 0.0002;

            if (currentTheme.neutron) {
              neutronGroup.rotation.y += 0.2;
              const s = 1 + Math.sin(Date.now() * 0.05) * 0.05;
              neutronGroup.scale.set(s, s, s);
            } else if (currentTheme.neptune) {
              neptuneGroup.children[0].rotation.y += 0.001 * spd;
              neptuneGroup.children[1].rotation.y -= 0.003 * spd;
            }

            if (currentTheme.shoot && Math.random() < 0.02) {
              const star = new THREE.Line(
                new THREE.BufferGeometry().setFromPoints([
                  new THREE.Vector3(0, 0, 0),
                  new THREE.Vector3(0, 0, 4),
                ]),
                new THREE.LineBasicMaterial({
                  color: 0xffffff,
                  transparent: true,
                  opacity: 1,
                })
              );
              star.position.set(
                (Math.random() - 0.5) * 80,
                (Math.random() - 0.5) * 80,
                -30
              );
              star.lookAt(0, 0, 0);
              sGroup.add(star);
            }
            sGroup.children.forEach((c) => {
              c.translateZ(2);
              c.material.opacity -= 0.05;
              if (c.material.opacity <= 0) {
                sGroup.remove(c);
                c.geometry.dispose();
                c.material.dispose();
              }
            });

            if (currentTheme.lightning) {
              const cA = new THREE.Color(currentTheme.lightningColA);
              const cB = new THREE.Color(currentTheme.lightningColB);
              const mixColor = cA.clone().lerp(cB, Math.random());

              if (Math.random() < 0.15) {
                const start = getRandVec().multiplyScalar(3.8);
                const end = getRandVec().multiplyScalar(3.8);
                if (start.distanceTo(end) < 6)
                  lGroup.add(
                    createBolt(
                      start,
                      end,
                      6,
                      0.4,
                      mixColor,
                      currentTheme.lightningIntensity
                    )
                  );
              }
              if (Math.random() < 0.1) {
                const center = new THREE.Vector3(
                  (Math.random() - 0.5) * 40,
                  (Math.random() - 0.5) * 40,
                  -10
                );
                const start = center
                  .clone()
                  .add(getRandVec().multiplyScalar(5));
                const end = center.clone().add(getRandVec().multiplyScalar(5));
                lGroup.add(
                  createBolt(
                    start,
                    end,
                    5,
                    0.8,
                    mixColor,
                    currentTheme.lightningIntensity
                  )
                );
              }
            }

            for (let i = lGroup.children.length - 1; i >= 0; i--) {
              const b = lGroup.children[i];
              b.material.opacity -= 0.02;
              if (b.material.opacity <= 0) {
                lGroup.remove(b);
                if (b.geometry) b.geometry.dispose();
                if (b.material) b.material.dispose();
              }
            }

            renderer.render(scene, camera);
          };
          animate();

          return () => {
            cancelAnimationFrame(animationId);
            // REPLACE WITH THIS
            window.removeEventListener("mousedown", onMouseDown);
            window.removeEventListener("mouseup", onUp);
            window.removeEventListener("mousemove", onMouseMove);
            window.removeEventListener("touchstart", onTouchStart);
            window.removeEventListener("touchend", onUp);
            window.removeEventListener("touchmove", onTouchMove);
            if (mount.contains(renderer.domElement))
              mount.removeChild(renderer.domElement);
            renderer.dispose();
          };
        }, []);

        useEffect(() => {
          const {
            planet,
            rGroup,
            stars,
            asteroids,
            nebula,
            sGroup,
            neutronGroup,
            neptuneGroup,
            lGroup,
          } = objs.current;
          if (!planet) return;

          planet.material.color.set(theme.pBase);
          planet.material.emissive.set(theme.pGlow);
          planet.material.roughness = theme.pRough;
          planet.material.metalness = theme.pMetal;
          if (neptuneGroup) {
            neptuneGroup.children[0].material.color.set(theme.neptuneColA);
            neptuneGroup.children[1].material.color.set(theme.neptuneColB);
          }

          stars.visible = theme.stars;
          asteroids.visible = theme.ast;
          nebula.visible = theme.nebula;
          nebula.material.color.set(theme.nebColor);
          sGroup.visible = theme.shoot;

          if (theme.neutron) {
            planet.visible = false;
            neutronGroup.visible = true;
            neptuneGroup.visible = false;
          } else if (theme.neptune) {
            planet.visible = false;
            neutronGroup.visible = false;
            neptuneGroup.visible = true;
          } else {
            planet.visible = true;
            neutronGroup.visible = false;
            neptuneGroup.visible = false;
          }

          if (!theme.lightning) {
            while (lGroup.children.length) {
              const c = lGroup.children[0];
              lGroup.remove(c);
              if (c.geometry) c.geometry.dispose();
              if (c.material) c.material.dispose();
            }
          }

          while (rGroup.children.length) {
            const m = rGroup.children[0];
            m.geometry.dispose();
            m.material.dispose();
            rGroup.remove(m);
          }
          const mkRing = (r, t, c) => {
            const m = new THREE.Mesh(
              new THREE.TorusGeometry(r, theme.rThick, 4, 120),
              new THREE.MeshStandardMaterial({
                color: c,
                emissive: c,
                emissiveIntensity: 0.5,
                roughness: theme.rRough,
                metalness: theme.rMetal,
                transparent: true,
                opacity: 0.9,
                side: THREE.DoubleSide,
              })
            );
            m.rotation.x = t;
            rGroup.add(m);
          };
          if (theme.gyroPattern) {
            mkRing(5.0, Math.PI / 2.1, theme.r1Col);
            mkRing(6.5, Math.PI / 6, theme.r2Col);
            mkRing(8.0, -Math.PI / 4, theme.r3Col);
          } else {
            mkRing(5.0, Math.PI / 2, theme.r1Col);
            mkRing(6.5, Math.PI / 2, theme.r2Col);
            mkRing(8.0, Math.PI / 2, theme.r3Col);
          }
        }, [theme]);

        return (
          <div
            ref={mountRef}
            className="w-full h-[600px] cursor-move"
            title="Drag to rotate planet"
          />
        );
      };

      // === FLUID LAYER COMPONENT ===
      // === FLUID LAYER COMPONENT (Optimized for Mobile) ===
      const FluidLayer = ({ theme }) => {
        const engineRef = useRef(null);
        // Check if device is mobile (width less than 768px)
        const isMobile = window.innerWidth < 768;

        useEffect(() => {
          // If mobile, do not initialize the heavy engine
          if (isMobile) return;

          const canvas = document.getElementById("fluid-layer");
          if (!canvas) return;
          const resize = () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if (engineRef.current) engineRef.current.initFramebuffers();
          };
          window.addEventListener("resize", resize);
          resize();
          try {
            engineRef.current = new FluidWebGLEngine(canvas);
          } catch (e) {
            console.error("WebGL init failed", e);
          }
          return () => window.removeEventListener("resize", resize);
        }, [isMobile]);

        useEffect(() => {
          // If mobile, keep hidden
          if (isMobile) {
             const canvas = document.getElementById("fluid-layer");
             if(canvas) canvas.style.display = 'none';
             return;
          }

          if (engineRef.current) {
            document.getElementById("fluid-layer").style.display =
              theme.fluidEnabled ? "block" : "none";
            engineRef.current.updateConfig({
              SIM_RESOLUTION: theme.fluidRes,
              DENSITY_DISSIPATION: 4.0 - theme.fluidDissipation * 0.03,
              SPLAT_FORCE: theme.fluidForce,
              SPLAT_RADIUS: theme.fluidRadius / 1000.0,
              SIM_SPEED: theme.fluidSpeed,
              COLOR_A: hexToRgbObj(theme.fluidColorA),
              COLOR_B: hexToRgbObj(theme.fluidColorB),
            });
          }
        }, [theme, isMobile]);

        return null;
      };

      // === STAR FIELD ===
      const StarField = ({ theme }) => {
        useEffect(() => {
          const container = document.getElementById("stars-container");
          container.innerHTML = "";

          for (let i = 0; i < 180; i++) {
            const star = document.createElement("div");
            star.className = "star";
            star.style.cssText = `
                        left: ${Math.random() * 100}%; 
                        top: ${Math.random() * 100}%;
                        width: ${Math.random() * 2.5 + 0.5}px;
                        animation-delay: ${Math.random() * 3}s;
                    `;
            star.style.height = star.style.width;
            container.appendChild(star);
          }

          if (!theme.spaceEffects) return;

          const createShootingStar = () => {
            const star = document.createElement("div");
            star.className = "shooting-star";
            star.style.cssText = `
                        left: ${Math.random() * 100}%;
                        top: ${Math.random() * 40}%;
                        width: ${Math.random() * 150 + 80}px;
                    `;
            document.body.appendChild(star);
            setTimeout(() => star.remove(), 1000);
          };

          const interval = setInterval(
            createShootingStar,
            4000 / theme.animationSpeed
          );
          return () => clearInterval(interval);
        }, [theme.spaceEffects, theme.animationSpeed]);

        return null;
      };

      // === NEBULA ===
      const NebulaBackground = ({ theme }) => {
        if (!theme.spaceEffects) return null;
        return (
          <>
            <div
              className="nebula"
              style={{
                top: "5%",
                left: "15%",
                width: "600px",
                height: "600px",
                background: `radial-gradient(circle, ${theme.primaryColor}50, transparent 70%)`,
              }}
            />
            <div
              className="nebula"
              style={{
                bottom: "10%",
                right: "5%",
                width: "500px",
                height: "500px",
                background: `radial-gradient(circle, ${theme.secondaryColor}40, transparent 70%)`,
              }}
            />
            <div
              className="nebula"
              style={{
                top: "50%",
                left: "50%",
                width: "800px",
                height: "800px",
                transform: "translate(-50%, -50%)",
                background: `radial-gradient(circle, ${
                  theme.accentColor || "#10b981"
                }20, transparent 70%)`,
              }}
            />
          </>
        );
      };

      // === VIDEO HOVER PLAYER ===
      const VideoHoverPlayer = ({ src, className, isAdmin, onRemove }) => {
        const videoRef = useRef(null);
        const [isPlaying, setIsPlaying] = useState(false);

        const isEmbed = src?.includes("youtube") || src?.includes("vimeo");

        const handleMouseEnter = () => {
          if (videoRef.current && !isEmbed) {
            videoRef.current.play().catch(() => {});
            setIsPlaying(true);
          }
        };

        const handleMouseLeave = () => {
          if (videoRef.current && !isEmbed) {
            videoRef.current.pause();
            videoRef.current.currentTime = 0;
            setIsPlaying(false);
          }
        };

        return (
          <div
            className={`video-container ${
              isAdmin ? "media-editable" : ""
            } ${className}`}
            onMouseEnter={handleMouseEnter}
            onMouseLeave={handleMouseLeave}
          >
            {isEmbed ? (
              <iframe
                src={src}
                className="w-full h-full rounded-lg"
                allowFullScreen
                allow="autoplay"
              />
            ) : (
              <>
                <video
                  ref={videoRef}
                  src={src}
                  className="w-full h-full object-cover rounded-lg"
                  muted
                  loop
                  playsInline
                />
                {!isPlaying && (
                  <div className="video-play-icon">
                    <span>▶</span>
                  </div>
                )}
              </>
            )}
            {isAdmin && (
              <div className="media-overlay">
                <button
                  className="media-btn bg-red-600 text-white"
                  onClick={onRemove}
                >
                  🗑️
                </button>
              </div>
            )}
          </div>
        );
      };

      // === NEW COMPONENT: LIGHTBOX MODAL ===
      const LightboxModal = ({ isOpen, onClose, src }) => {
        if (!isOpen || !src) return null;
        return (
          <div className="lightbox-overlay" onClick={onClose}>
            <img
              src={src}
              className="lightbox-img"
              alt="Fullscreen"
              onClick={(e) => e.stopPropagation()}
            />
            <button
              className="absolute top-4 right-4 text-white text-3xl"
              onClick={onClose}
            >
              ×
            </button>
          </div>
        );
      };
      // === IMAGE EDITOR COMPONENT (New Feature) ===
      const ImageEditorModal = ({
        isOpen,
        onClose,
        imageSrc,
        onSave,
        theme,
      }) => {
        const canvasRef = useRef(null);
        const [scale, setScale] = useState(1);
        const [offset, setOffset] = useState({ x: 0, y: 0 });
        const [isDragging, setIsDragging] = useState(false);
        const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
        const [imageObj, setImageObj] = useState(null);

        // Load Image
        useEffect(() => {
          if (!imageSrc) return;
          const img = new Image();
          img.src = imageSrc;
          img.onload = () => {
            setImageObj(img);
            setOffset({ x: 0, y: 0 });
            setScale(1);
          };
        }, [imageSrc]);

        // Draw Canvas
        useEffect(() => {
          if (!imageObj || !canvasRef.current) return;
          const canvas = canvasRef.current;
          const ctx = canvas.getContext("2d");

          // Clear
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          // Background
          ctx.fillStyle = "#111";
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          // Draw Image Transformed
          ctx.save();
          ctx.translate(
            canvas.width / 2 + offset.x,
            canvas.height / 2 + offset.y
          );
          ctx.scale(scale, scale);
          ctx.drawImage(imageObj, -imageObj.width / 2, -imageObj.height / 2);
          ctx.restore();

          // Draw Crop Overlay (Fixed 400x400 center)
          ctx.strokeStyle = theme.primaryColor;
          ctx.lineWidth = 2;
          ctx.setLineDash([10, 5]);
          ctx.strokeRect(
            canvas.width / 2 - 200,
            canvas.height / 2 - 200,
            400,
            400
          );
        }, [imageObj, scale, offset, theme]);

        const handleMouseDown = (e) => {
          setIsDragging(true);
          setDragStart({ x: e.clientX - offset.x, y: e.clientY - offset.y });
        };

        const handleMouseMove = (e) => {
          if (!isDragging) return;
          setOffset({ x: e.clientX - dragStart.x, y: e.clientY - dragStart.y });
        };

        const handleMouseUp = () => setIsDragging(false);

        const handleWheel = (e) => {
          e.preventDefault();
          const newScale = Math.max(0.1, scale - e.deltaY * 0.001);
          setScale(newScale);
        };

        const handleSave = () => {
          if (!imageObj || !canvasRef.current) return;
          // Create temporary canvas for the crop
          const tempCanvas = document.createElement("canvas");
          tempCanvas.width = 400;
          tempCanvas.height = 400;
          const tCtx = tempCanvas.getContext("2d");

          // We need to map the 400x400 center of the main canvas to the new canvas
          // The main canvas center is at (canvas.width/2, canvas.height/2)
          const mainCanvas = canvasRef.current;

          tCtx.fillStyle = "#000";
          tCtx.fillRect(0, 0, 400, 400);

          tCtx.save();
          // Translate to center of temp canvas
          tCtx.translate(200, 200);
          // Apply same transformations
          tCtx.translate(offset.x, offset.y);
          tCtx.scale(scale, scale);
          tCtx.drawImage(imageObj, -imageObj.width / 2, -imageObj.height / 2);
          tCtx.restore();

          const dataUrl = tempCanvas.toDataURL("image/jpeg", 0.9);
          onSave(dataUrl);
        };

        if (!isOpen) return null;

        return (
          <div className="modal-overlay" onClick={onClose}>
            <div
              className="modal-content glass-strong p-6 max-w-2xl"
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold text-gradient">
                  🖼️ Image Editor
                </h2>
                <div className="text-xs text-slate-400">
                  Scroll to Zoom • Drag to Move
                </div>
                <button
                  onClick={onClose}
                  className="text-2xl hover:text-red-400"
                >
                  ×
                </button>
              </div>

              {/* REPLACE WITH THIS BLOCK */}
              <div
                className="image-editor-canvas-container rounded-xl border border-slate-700 h-[500px] w-full flex items-center justify-center bg-black"
                onMouseDown={handleMouseDown}
                onMouseMove={handleMouseMove}
                onMouseUp={handleMouseUp}
                onMouseLeave={handleMouseUp}
                onWheel={handleWheel}
                onTouchStart={(e) => {
                  if (e.touches.length === 1) {
                    e.preventDefault();
                    handleMouseDown(e.touches[0]);
                  }
                }}
                onTouchMove={(e) => {
                  if (e.touches.length === 1) {
                    e.preventDefault();
                    handleMouseMove(e.touches[0]);
                  }
                }}
                onTouchEnd={handleMouseUp}
              >
                <canvas
                  ref={canvasRef}
                  width={800}
                  height={600}
                  className="max-w-full max-h-full"
                />
              </div>

              <div className="flex justify-between items-center mt-6">
                <div className="flex gap-4">
                  <button
                    onClick={() => setScale(scale + 0.1)}
                    className="px-3 py-1 bg-slate-700 rounded hover:bg-slate-600"
                  >
                    +
                  </button>
                  <span className="text-sm self-center">
                    Zoom: {Math.round(scale * 100)}%
                  </span>
                  <button
                    onClick={() => setScale(Math.max(0.1, scale - 0.1))}
                    className="px-3 py-1 bg-slate-700 rounded hover:bg-slate-600"
                  >
                    -
                  </button>
                </div>
                <div className="flex gap-3">
                  <button
                    onClick={onClose}
                    className="px-6 py-2 rounded-lg font-bold bg-slate-700 hover:bg-slate-600"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={handleSave}
                    className="px-6 py-2 rounded-lg font-bold text-white shadow-glow hover:scale-105 transition-transform"
                    style={{ background: theme.primaryColor }}
                  >
                    Save Crop
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // === NEW COMPONENT: VAULT WRAPPER WITH ADMIN CONTROLS ===
      const VaultWrapper = ({ onClose, onResetVault, isAdmin }) => {
        useEffect(() => {
          const handler = (event) => {
            if (event.data?.type === "CLOSE_VAULT") onClose();
          };
          window.addEventListener("message", handler);
          return () => window.removeEventListener("message", handler);
        }, [onClose]);

        return (
          <div className="fixed inset-0 z-[5000] bg-gray-900 flex flex-col">
            {isAdmin && (
              <div className="bg-gray-800 p-2 flex justify-between items-center border-b border-gray-700">
                <div className="flex gap-2">
                  <span className="text-white font-bold text-sm px-4">
                    Vault Admin
                  </span>
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={onResetVault}
                    className="px-3 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700"
                  >
                    Master Vault Reset
                  </button>
                  <button
                    onClick={onClose}
                    className="px-3 py-1 bg-gray-700 text-white text-xs rounded hover:bg-gray-600"
                  >
                    Close Vault
                  </button>
                </div>
              </div>
            )}
            <iframe
              srcDoc={VAULT_SOURCE_CODE}
              className="w-full h-full border-0"
              title="Secure Vault"
              sandbox="allow-scripts allow-same-origin allow-modals allow-forms allow-popups"
            />
          </div>
        );
      };

      // === NEW HELPER: PDF PERMISSION HANDLER ===
      const handlePdfAccess = (isAdmin, url, name) => {
        if (isAdmin) {
          window.open(url, "_blank");
        } else {
          if (
            confirm(
              `Restricted Access: "${
                name || "Document"
              }".\n\nWould you like to request access via the contact form?`
            )
          ) {
            const contactSection = document.getElementById("contact");
            if (contactSection) {
              contactSection.scrollIntoView({ behavior: "smooth" });
              setTimeout(() => {
                const msgArea = document.querySelector(
                  'textarea[name="message"]'
                );
                if (msgArea)
                  msgArea.value = `Requesting access to document: ${name}`;
              }, 500);
            }
          }
        }
      };

      // === MODALS (Preserved & Extended) ===
      // === UPDATED MEDIA MANAGER WITH CROP FEATURE ===
      const MediaManagerModal = ({
        isOpen,
        onClose,
        targetId,
        targetType,
        mediaType,
        data,
        setData,
        theme,
      }) => {
        const [urlInput, setUrlInput] = useState("");
        const [dragOver, setDragOver] = useState(false);
        const [editImage, setEditImage] = useState(null); // STATE FOR IMAGE EDITOR
        const fileInputRef = useRef(null);

        if (!isOpen) return null;

        // Determine correct collection and item based on targetType
        let collectionKey = "projects";
        if (targetType === "experience") collectionKey = "experience";
        if (targetType === "education") collectionKey = "education";
        if (targetType === "internships") collectionKey = "internships";
        if (targetType === "publications") collectionKey = "publications";
        if (targetType === "certifications") collectionKey = "certifications";
        if (targetType === "volunteer") collectionKey = "volunteer";
        if (targetType === "licenses") collectionKey = "licenses";
        if (targetType === "languages") collectionKey = "languages";

        const collection = data[collectionKey];
        const item = collection.find((p) => p.id === targetId);
        if (!item) return null;

        let arrayKey = mediaType;
        if ((collectionKey === "experience" || collectionKey === "education" || collectionKey === "internships") && mediaType === "images")
          arrayKey = "gallery";
          arrayKey = "gallery";
        if (
          [
            "publications",
            "certifications",
            "volunteer",
            "licenses",
            "languages",
          ].includes(collectionKey)
        )
          arrayKey = "media";

        const mediaArray = item[arrayKey] || [];

        const handleFileUpload = (files) => {
          Array.from(files).forEach((file) => {
            const reader = new FileReader();
            reader.onload = (e) => addMedia(e.target.result, file.name);
            if (
              (mediaType === "images" && file.type.startsWith("image/")) ||
              (mediaType === "videos" && file.type.startsWith("video/")) ||
              (mediaType === "pdfs" && file.type === "application/pdf")
            ) {
              reader.readAsDataURL(file);
            }
          });
          if (fileInputRef.current) fileInputRef.current.value = "";
        };

        const addMedia = (url, fileName = "") => {
          if (!url?.trim()) return;
          const newData = { ...data };
          const idx = collection.findIndex((p) => p.id === targetId);
          const targetCollection = newData[collectionKey];
          const entry = { url, name: fileName || "Media File" };

          if (
            mediaType === "pdfs" ||
            [
              "publications",
              "certifications",
              "volunteer",
              "licenses",
              "languages",
            ].includes(collectionKey)
          ) {
            if (!targetCollection[idx][arrayKey])
              targetCollection[idx][arrayKey] = [];
            targetCollection[idx][arrayKey].push(entry);
          } else {
            if (mediaType === "images" || mediaType === "videos") {
              targetCollection[idx][arrayKey] = [
                ...(targetCollection[idx][arrayKey] || []),
                url,
              ];
            } else if (mediaType === "pdfs") {
              targetCollection[idx].pdfs = [
                ...(targetCollection[idx].pdfs || []),
                { url, name: fileName || "Document.pdf" },
              ];
            }
          }

          setData(newData);
          localStorage.setItem("portfolioData", JSON.stringify(newData));
          setUrlInput("");
          showToast(`${mediaType.slice(0, -1)} added! 🎉`);
        };

        // NEW: Function to save cropped image
        const updateMedia = (index, newUrl) => {
          const newData = { ...data };
          const idx = collection.findIndex((p) => p.id === targetId);
          const targetCollection = newData[collectionKey];
          targetCollection[idx][arrayKey][index] = newUrl;
          setData(newData);
          localStorage.setItem("portfolioData", JSON.stringify(newData));
          showToast("Image Updated! 🎨");
        };

        const removeMedia = (index) => {
          const newData = { ...data };
          const idx = collection.findIndex((p) => p.id === targetId);
          const targetCollection = newData[collectionKey];
          targetCollection[idx][arrayKey] = targetCollection[idx][
            arrayKey
          ].filter((_, i) => i !== index);
          setData(newData);
          localStorage.setItem("portfolioData", JSON.stringify(newData));
          showToast("Removed!", "info");
        };

        const icons = { images: "🖼️", videos: "🎬", pdfs: "📄" };
        const accepts = { images: "image/*", videos: "video/*", pdfs: ".pdf" };

        return (
          <div className="modal-overlay" onClick={onClose}>
            <div
              className="modal-content glass-strong p-8"
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex justify-between items-center mb-8">
                <h2 className="text-2xl font-bold text-gradient">
                  {icons[mediaType]} Manage{" "}
                  {mediaType.charAt(0).toUpperCase() + mediaType.slice(1)}
                </h2>
                <button
                  onClick={onClose}
                  className="text-slate-400 hover:text-white text-3xl transition-all hover:rotate-90"
                >
                  ×
                </button>
              </div>

              <div
                className={`upload-zone mb-8 ${dragOver ? "dragover" : ""}`}
                onDragOver={(e) => {
                  e.preventDefault();
                  setDragOver(true);
                }}
                onDragLeave={() => setDragOver(false)}
                onDrop={(e) => {
                  e.preventDefault();
                  setDragOver(false);
                  handleFileUpload(e.dataTransfer.files);
                }}
                onClick={() => fileInputRef.current?.click()}
              >
                <input
                  ref={fileInputRef}
                  type="file"
                  multiple
                  accept={accepts[mediaType]}
                  className="hidden"
                  onChange={(e) => handleFileUpload(e.target.files)}
                />
                <div className="text-6xl mb-4">{icons[mediaType]}</div>
                <p className="text-slate-300 font-semibold text-lg">
                  Drag & drop {mediaType} here
                </p>
                <p className="text-slate-500 text-sm mt-2">
                  or click to browse
                </p>
              </div>

              <div className="flex gap-3 mb-8">
                <input
                  type="text"
                  placeholder={`Enter ${mediaType} URL...`}
                  value={urlInput}
                  onChange={(e) => setUrlInput(e.target.value)}
                  className="flex-1 bg-slate-800/80 border-2 border-slate-600 rounded-xl p-4 text-white outline-none focus:border-cyan-400 transition-colors"
                />
                <button
                  onClick={() => addMedia(urlInput)}
                  className="px-8 py-4 rounded-xl font-bold transition-all hover:scale-105 shadow-glow"
                  style={{
                    background: `linear-gradient(135deg, ${theme.primaryColor}, ${theme.secondaryColor})`,
                  }}
                >
                  Add
                </button>
              </div>

              <div className="media-grid">
                {mediaArray.map((item, index) => {
                  const src = typeof item === "string" ? item : item.url;
                  const name = typeof item === "object" ? item.name : "";
                  return (
                    <DraggableItem
                      key={index}
                      x={50}
                      y={50}
                      s={1}
                      onUpdate={() => {}}
                      isAdmin={true}
                      className="relative aspect-[16/10]"
                    >
                      <div className="media-item group h-full w-full">
                        {mediaType === "images" && (
                          <img
                            src={src}
                            alt=""
                            className="w-full h-full object-cover"
                          />
                        )}
                        {mediaType === "videos" &&
                          (src.includes("youtube") || src.includes("vimeo") ? (
                            <iframe src={src} className="w-full h-full" />
                          ) : (
                            <video src={src} />
                          ))}
                        {mediaType === "pdfs" && (
                          <div className="w-full h-full bg-slate-700 flex flex-col items-center justify-center">
                            <span className="text-4xl">📄</span>
                            <span className="text-xs text-slate-300 mt-2 px-2 truncate w-full text-center">
                              {name || "PDF"}
                            </span>
                          </div>
                        )}
                        <div className="media-overlay">
                          {/* NEW: Edit Button for Images */}
                          {mediaType === "images" && (
                            <button
                              className="media-btn bg-blue-600 text-white mr-2"
                              onClick={() => setEditImage({ index, src })}
                            >
                              ✏️
                            </button>
                          )}
                          <button
                            className="media-btn bg-red-600 text-white"
                            onClick={() => removeMedia(index)}
                          >
                            🗑️
                          </button>
                        </div>
                      </div>
                    </DraggableItem>
                  );
                })}
              </div>
              {mediaArray.length === 0 && (
                <p className="text-center text-slate-500 py-10">
                  No {mediaType} yet. Add some above!
                </p>
              )}
            </div>

            {/* Nested Image Editor */}
            {editImage && (
              <ImageEditorModal
                isOpen
                onClose={() => setEditImage(null)}
                imageSrc={editImage.src}
                theme={theme}
                onSave={(newUrl) => {
                  updateMedia(editImage.index, newUrl);
                  setEditImage(null);
                }}
              />
            )}
          </div>
        );
      };

      const ProfileImageModal = ({ isOpen, onClose, data, setData, theme }) => {
        const [urlInput, setUrlInput] = useState(data.profileImage || "");
        const fileInputRef = useRef(null);

        if (!isOpen) return null;

        const updateImage = (url) => {
          const newData = { ...data, profileImage: url };
          setData(newData);
          localStorage.setItem("portfolioData", JSON.stringify(newData));
          showToast("Profile updated! 📸");
        };

        return (
          <div className="modal-overlay" onClick={onClose}>
            <div
              className="modal-content glass-strong p-8 max-w-md"
              onClick={(e) => e.stopPropagation()}
            >
              <h2 className="text-2xl font-bold text-center mb-6 text-gradient">
                📷 Profile Image
              </h2>

              <div className="flex justify-center mb-6">
                <div
                  className="w-40 h-40 rounded-full overflow-hidden ring-4"
                  style={{ ringColor: theme.primaryColor }}
                >
                  <img
                    src={
                      data.profileImage ||
                      `https://ui-avatars.com/api/?name=${
                        data.name?.replace(" ", "+") || "User"
                      }&background=0f172a&color=06b6d4&size=400`
                    }
                    alt=""
                    className="w-full h-full object-cover"
                  />
                </div>
              </div>

              <div
                className="upload-zone mb-4 py-8"
                onClick={() => fileInputRef.current?.click()}
              >
                <input
                  ref={fileInputRef}
                  type="file"
                  accept="image/*"
                  className="hidden"
                  onChange={(e) => {
                    if (e.target.files[0]) {
                      const reader = new FileReader();
                      reader.onload = (ev) => updateImage(ev.target.result);
                      reader.readAsDataURL(e.target.files[0]);
                    }
                  }}
                />
                <div className="text-4xl mb-2">📁</div>
                <p className="text-slate-400 text-sm">Click to upload</p>
              </div>

              <div className="flex gap-2 mb-4">
                <input
                  type="text"
                  placeholder="Or paste image URL..."
                  value={urlInput}
                  onChange={(e) => setUrlInput(e.target.value)}
                  className="flex-1 bg-slate-800 border border-slate-600 rounded-lg p-3 text-white text-sm outline-none"
                />
                <button
                  onClick={() => updateImage(urlInput)}
                  className="px-4 rounded-lg font-bold"
                  style={{ background: theme.primaryColor }}
                >
                  Set
                </button>
              </div>

              <div className="grid grid-cols-2 gap-2">
                <button
                  onClick={() => {
                    updateImage("");
                    setUrlInput("");
                  }}
                  className="py-3 rounded-lg font-bold bg-red-600/20 text-red-400 hover:bg-red-600/30"
                >
                  Remove
                </button>
                <button
                  onClick={onClose}
                  className="py-3 rounded-lg font-bold bg-slate-700 hover:bg-slate-600"
                >
                  Done
                </button>
              </div>
            </div>
          </div>
        );
      };

      const CVModal = ({ isOpen, onClose, data, setData, theme }) => {
        const fileInputRef = useRef(null);
        if (!isOpen) return null;

        return (
          <div className="modal-overlay" onClick={onClose}>
            <div
              className="modal-content glass-strong p-8 max-w-md"
              onClick={(e) => e.stopPropagation()}
            >
              <h2 className="text-2xl font-bold text-center mb-6 text-gradient">
                📄 Upload CV
              </h2>

              {data.cvFileName && (
                <div className="mb-4 p-4 bg-slate-800 rounded-xl flex items-center gap-4">
                  <span className="text-4xl">📎</span>
                  <div className="flex-1">
                    <p className="font-semibold">{data.cvFileName}</p>
                    <p className="text-slate-400 text-sm">Current CV</p>
                  </div>
                </div>
              )}

              <div
                className="upload-zone"
                onClick={() => fileInputRef.current?.click()}
              >
                <input
                  ref={fileInputRef}
                  type="file"
                  accept=".pdf,.doc,.docx"
                  className="hidden"
                  onChange={(e) => {
                    if (e.target.files[0]) {
                      const file = e.target.files[0];
                      const reader = new FileReader();
                      reader.onload = (ev) => {
                        const newData = {
                          ...data,
                          cvUrl: ev.target.result,
                          cvFileName: file.name,
                        };
                        setData(newData);
                        localStorage.setItem(
                          "portfolioData",
                          JSON.stringify(newData)
                        );
                        showToast("CV uploaded! 📄");
                      };
                      reader.readAsDataURL(file);
                    }
                  }}
                />
                <div className="text-5xl mb-3">📤</div>
                <p className="text-slate-300 font-semibold">
                  Click to upload CV
                </p>
                <p className="text-slate-500 text-sm mt-1">PDF, DOC, DOCX</p>
              </div>

              <button
                onClick={onClose}
                className="w-full py-3 mt-6 rounded-xl font-bold bg-slate-700 hover:bg-slate-600 transition-colors"
              >
                Done
              </button>
            </div>
          </div>
        );
      };

      // === FIXED QUILL EDIT MODAL  ===
      // === FIXED EDIT MODAL (Always on Top & No <p> tags in titles) ===
      const EditModal = ({ editModal, setEditModal, data, setData, theme }) => {
        const editorRef = useRef(null);
        const quillInstance = useRef(null);

        useEffect(() => {
          if (editModal.open && editModal.type === "textarea" && editorRef.current) {
            if (editorRef.current.innerHTML) editorRef.current.innerHTML = "";
            const quill = new Quill(editorRef.current, {
              theme: "snow",
              modules: {
                toolbar: [
                  ["bold", "italic", "underline", "strike"],
                  [{ list: "ordered" }, { list: "bullet" }],
                  [{ header: [2, 3, false] }],
                  ["link", "clean"],
                ],
              },
            });
            if (editModal.value) {
              quill.clipboard.dangerouslyPasteHTML(0, editModal.value);
            }
            quillInstance.current = quill;
          }
        }, [editModal.open, editModal.type]);

        const save = () => {
          let newValue = editModal.value;

          if (editModal.type === "textarea" && quillInstance.current) {
            // If it's the Big Editor, keep HTML
            newValue = quillInstance.current.root.innerHTML;
          } else {
             // If it's a Title/Input, STRIP <p> tags automatically
             newValue = newValue.replace(/<[^>]*>?/gm, '');
          }

          let newData = { ...data };
          if (editModal.path) {
            const keys = editModal.path.split(".");
            let obj = newData;
            for (let i = 0; i < keys.length - 1; i++) {
              obj = obj[keys[i]];
            }
            // Handle Tags (comma separated)
            if (editModal.isArray && editModal.type !== "textarea") {
                newValue = newValue.split(",").map((s) => s.trim()).filter(Boolean);
            }
            obj[keys[keys.length - 1]] = newValue;
          } else if (editModal.field) {
            newData[editModal.field] = newValue;
          }

          setData(newData);
          localStorage.setItem("portfolioData", JSON.stringify(newData));
          setEditModal({ open: false });
          if (window.showToast) window.showToast("Saved! ✨");
        };

        if (!editModal.open) return null;

        return (
          <div className="edit-modal-wrapper" onClick={() => setEditModal({ open: false })}>
            <div className="glass-strong p-6 rounded-3xl w-full max-w-2xl relative" onClick={(e) => e.stopPropagation()}>
              <h2 className="text-xl font-bold mb-4 text-white">Edit {editModal.label || "Content"}</h2>
              
              <div className="mb-6 rounded-xl overflow-hidden border-4 border-slate-600 bg-white">
                {editModal.type === "textarea" ? (
                  <div ref={editorRef} style={{ height: "auto", minHeight:"200px", color: "black" }}></div>
                ) : (
                  <input
                    type="text"
                    className="w-full bg-white p-4 text-black outline-none font-bold text-lg"
                    value={editModal.value}
                    onChange={(e) => setEditModal({ ...editModal, value: e.target.value })}
                    placeholder="Type here..."
                  />
                )}
              </div>
              
              <div className="flex gap-4">
                <button onClick={() => setEditModal({ open: false })} className="flex-1 py-3 bg-slate-700 rounded-xl font-bold text-white">Cancel</button>
                <button onClick={save} className="flex-1 py-3 rounded-xl font-bold text-white shadow-lg" style={{ background: theme.primaryColor }}>
                  Save Changes
                </button>
              </div>
            </div>
          </div>
        );
      };

      const SocialLinkModal = ({
        isOpen,
        onClose,
        data,
        setData,
        theme,
        editingLink,
      }) => {
        const [form, setForm] = useState({
          label: "",
          url: "",
          icon: "fa-brands fa-github",
          imageSrc: "",
          x: 50,
          y: 50,
          scale: 1,
          color: "#ffffff",
        });
        const fileInputRef = useRef(null);

        useEffect(() => {
          if (editingLink) {
            setForm({ ...editingLink });
          } else {
            setForm({
              label: "",
              url: "",
              icon: "fa-brands fa-github",
              imageSrc: "",
              x: 50,
              y: 50,
              scale: 1,
              color: "#ffffff",
            });
          }
        }, [editingLink]);

        if (!isOpen) return null;

        const handleImageUpload = (e) => {
          if (e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = (ev) =>
              setForm({ ...form, imageSrc: ev.target.result });
            reader.readAsDataURL(e.target.files[0]);
          }
        };

        const handleSave = () => {
          if (!form.url) return showToast("URL required!", "error");

          let newLinks = [...(data.socialLinks || [])];
          if (editingLink) {
            newLinks = newLinks.map((l) =>
              l.id === editingLink.id ? { ...l, ...form } : l
            );
          } else {
            newLinks.push({ id: Date.now(), ...form });
          }

          const newData = { ...data, socialLinks: newLinks };
          setData(newData);
          localStorage.setItem("portfolioData", JSON.stringify(newData));
          showToast("Saved! 💾");
          onClose();
        };

        return (
          <div className="modal-overlay" onClick={onClose}>
            <div
              className="glass-strong p-8 rounded-3xl w-full max-w-md"
              onClick={(e) => e.stopPropagation()}
            >
              <h2 className="text-xl font-bold mb-6 text-gradient">
                {editingLink ? "Edit" : "Add"} Social Link
              </h2>
              <div className="space-y-4">
                <div>
                  <label className="text-xs text-slate-400 mb-1 block">
                    Platform Name
                  </label>
                  <input
                    placeholder="e.g. LinkedIn"
                    className="w-full bg-slate-800 border border-slate-600 rounded-xl p-3 text-white outline-none"
                    value={form.label}
                    onChange={(e) =>
                      setForm({ ...form, label: e.target.value })
                    }
                  />
                </div>
                <div>
                  <label className="text-xs text-slate-400 mb-1 block">
                    URL
                  </label>
                  <input
                    placeholder="https://..."
                    className="w-full bg-slate-800 border border-slate-600 rounded-xl p-3 text-white outline-none"
                    value={form.url}
                    onChange={(e) => setForm({ ...form, url: e.target.value })}
                  />
                </div>

                {/* Icon Choice */}
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-xs text-slate-400 mb-1 block">
                      Custom Image (Optional)
                    </label>
                    <div
                      className="upload-zone p-2 h-20 flex items-center justify-center cursor-pointer"
                      onClick={() => fileInputRef.current?.click()}
                    >
                      <input
                        ref={fileInputRef}
                        type="file"
                        accept="image/*"
                        className="hidden"
                        onChange={handleImageUpload}
                      />
                      {form.imageSrc ? (
                        <img
                          src={form.imageSrc}
                          className="h-full w-auto object-contain"
                        />
                      ) : (
                        <span className="text-xs text-slate-500">
                          Upload Icon
                        </span>
                      )}
                    </div>
                    {form.imageSrc && (
                      <button
                        onClick={() => setForm({ ...form, imageSrc: "" })}
                        className="text-xs text-red-400 mt-1"
                      >
                        Remove Image
                      </button>
                    )}
                  </div>
                  <label className="text-xs text-slate-400 mb-1 block">
                    Icon Color
                  </label>
                  <div className="flex items-center gap-2">
                    <input
                      type="color"
                      className="w-10 h-10 border-none bg-transparent cursor-pointer"
                      value={form.color}
                      onChange={(e) =>
                        setForm({ ...form, color: e.target.value })
                      }
                    />
                    <span className="text-xs text-slate-500">{form.color}</span>
                  </div>
                </div>
                <div>
                  <label className="text-xs text-slate-400 mb-1 block">
                    FontAwesome Class
                  </label>
                  <div className="flex gap-2">
                    <input
                      placeholder="fa-brands fa-github"
                      className="flex-1 bg-slate-800 border border-slate-600 rounded-xl p-3 text-white outline-none"
                      value={form.icon}
                      onChange={(e) =>
                        setForm({ ...form, icon: e.target.value })
                      }
                    />
                    <div className="w-12 flex items-center justify-center bg-slate-700 rounded-xl text-xl">
                      <i
                        className={form.icon}
                        style={{ color: form.color }}
                      ></i>
                    </div>
                  </div>
                  <p className="text-[10px] text-slate-500 mt-1">
                    Use 'fa-brands fa-...' for brands, 'fa-solid fa-...' for
                    icons.
                  </p>
                </div>
              </div>
              <div className="flex gap-4 mt-6">
                <button
                  onClick={onClose}
                  className="flex-1 py-3 bg-slate-700 rounded-xl font-bold"
                >
                  Cancel
                </button>
                <button
                  onClick={handleSave}
                  className="flex-1 py-3 rounded-xl font-bold"
                  style={{
                    background: `linear-gradient(135deg, ${theme.primaryColor}, ${theme.secondaryColor})`,
                  }}
                >
                  Save
                </button>
              </div>
            </div>
          </div>
        );
      };

      const AddItemModal = ({
        type,
        isOpen,
        onClose,
        data,
        setData,
        theme,
      }) => {
        const [form, setForm] = useState({});
        if (!isOpen) return null;

        const fieldsMap = {
          experience: [
            { key: "role", label: "Role *", required: true },
            { key: "company", label: "Company *", required: true },
            { key: "location", label: "Location" },
            { key: "period", label: "Period" },
            { key: "desc", label: "Description", type: "textarea" },
          ],
          education: [
            { key: "role", label: "Degree *", required: true },
            { key: "company", label: "University/Institution *", required: true },
            { key: "location", label: "Location" },
            { key: "period", label: "Period" },
            { key: "desc", label: "Description (Grade/Thesis)", type: "textarea" },
          ],
          internships: [
            { key: "org", label: "Organization Name *", required: true },
            { key: "role", label: "Your Role *", required: true },
            { key: "duration", label: "Duration (dd/mm/yyyy) *" },
            { key: "desc", label: "Work Description", type: "textarea" },
          ],
          project: [
            { key: "title", label: "Title *", required: true },
            { key: "shortDesc", label: "Short Description *", required: true },
            { key: "longDesc", label: "Full Description", type: "textarea" },
            { key: "company", label: "Company" },
            { key: "year", label: "Year" },
            { key: "skills", label: "Skills (comma-separated)" },
            { key: "tools", label: "Tools (comma-separated)" },
          ],
          publications: [
            { key: "title", label: "Publication Title *", required: true },
            { key: "abstract", label: "Abstract", type: "textarea" },
            { key: "desc", label: "Description", type: "textarea" },
            { key: "authors", label: "Authors" },
            { key: "conference", label: "Conference / Journal Name" },
            { key: "year", label: "Year" },
            { key: "url", label: "Read Online URL" },
          ],
          certifications: [
            { key: "name", label: "Certification Name *", required: true },
            { key: "org", label: "Organization" },
            { key: "year", label: "Year" },
            { key: "url", label: "Verification Link (URL)" },
            { key: "desc", label: "Description", type: "textarea" },
          ],
          volunteer: [
            { key: "event", label: "Event Name *", required: true },
            { key: "org", label: "Organization" },
            { key: "year", label: "Year" },
            { key: "desc", label: "Description", type: "textarea" },
          ],
          licenses: [
            { key: "name", label: "License Name *", required: true },
            { key: "authority", label: "Issuing Authority" },
            { key: "year", label: "Year" },
          ],
          languages: [
            { key: "name", label: "Language Name *", required: true },
            { key: "level", label: "Level (A1-C2)" },
            { key: "percentage", label: "Proficiency % (0-100)" },
          ],
        };

        const fields = fieldsMap[type] || [];

        const handleAdd = () => {
          let newItem = { id: Date.now(), ...form };

          // Validate required
          const required = fields.filter((f) => f.required).map((f) => f.key);
          for (let r of required) {
            if (!form[r]) return showToast(`Fill ${r}!`, "error");
          }

          // Process specific fields
          if (type === "project") {
            newItem.skills = (form.skills || "").split(",").map((s) => s.trim()).filter(Boolean);
            newItem.tools = (form.tools || "").split(",").map((s) => s.trim()).filter(Boolean);
            newItem.images = [];
            newItem.videos = [];
            newItem.pdfs = [];
          } else if (type === "experience") {
            newItem.highlights = [];
            newItem.gallery = [];
          } else if (type === "education" || type === "internships") {
            newItem.highlights = [];
            newItem.gallery = [];
            newItem.media = []; // PDFs
          } else {
            newItem.media = []; // Generic media for other sections
          }

          let key = type === "project" ? "projects" : type;
          const newData = { ...data, [key]: [...(data[key] || []), newItem] };
          setData(newData);
          localStorage.setItem("portfolioData", JSON.stringify(newData));
          showToast(`${type} added! 🎉`);
          onClose();
          setForm({});
        };

        return (
          <div className="modal-overlay" onClick={onClose}>
            <div
              className="glass-strong p-8 rounded-3xl w-full max-w-lg max-h-[85vh] overflow-y-auto"
              onClick={(e) => e.stopPropagation()}
            >
              <h2 className="text-xl font-bold mb-6 text-gradient">
                ➕ Add {type.charAt(0).toUpperCase() + type.slice(1)}
              </h2>
              <div className="space-y-4">
                {fields.map((f) =>
                  f.type === "textarea" ? (
                    <textarea
                      key={f.key}
                      placeholder={f.label}
                      rows="3"
                      className="w-full bg-slate-800 border border-slate-600 rounded-xl p-3 text-white outline-none resize-none"
                      value={form[f.key] || ""}
                      onChange={(e) =>
                        setForm({ ...form, [f.key]: e.target.value })
                      }
                    />
                  ) : (
                    <input
                      key={f.key}
                      placeholder={f.label}
                      className="w-full bg-slate-800 border border-slate-600 rounded-xl p-3 text-white outline-none"
                      value={form[f.key] || ""}
                      onChange={(e) =>
                        setForm({ ...form, [f.key]: e.target.value })
                      }
                    />
                  )
                )}
              </div>
              <div className="flex gap-4 mt-6">
                <button
                  onClick={onClose}
                  className="flex-1 py-3 bg-slate-700 rounded-xl font-bold"
                >
                  Cancel
                </button>
                <button
                  onClick={handleAdd}
                  className="flex-1 py-3 rounded-xl font-bold"
                  style={{
                    background: `linear-gradient(135deg, ${theme.primaryColor}, ${theme.secondaryColor})`,
                  }}
                >
                  Add
                </button>
              </div>
            </div>
          </div>
        );
      };

      // === FIXED PROJECT CARD (Subtitle Fix + Move Buttons) ===
      // === UPDATED PROJECT CARD WITH HEART ===
      const ProjectCard = ({ project, onClick, isAdmin, theme, onManageImages, onDelete, onImageClick, onMoveUp, onMoveDown, onLike }) => {
        
        // Handle heart click
        const handleHeartClick = (e) => {
          e.stopPropagation(); // Stop card from opening details
          if (onLike) onLike(project.id);
        };

        return (
          <div
            className={`glass rounded-3xl overflow-hidden group transition-all duration-500 hover:shadow-glow-hover hover:-translate-y-2 ${isAdmin ? "relative" : ""}`}
            data-aos="fade-up"
          >
            {isAdmin && (
              <div className="absolute top-2 right-2 flex gap-1 z-50">
                 <button onClick={(e) => { e.stopPropagation(); onMoveUp(); }} className="w-8 h-8 bg-slate-700 text-white rounded-md hover:bg-slate-600 flex items-center justify-center">↑</button>
                 <button onClick={(e) => { e.stopPropagation(); onMoveDown(); }} className="w-8 h-8 bg-slate-700 text-white rounded-md hover:bg-slate-600 flex items-center justify-center">↓</button>
                 <button className="w-8 h-8 bg-red-600 text-white rounded-md hover:bg-red-700 flex items-center justify-center" onClick={(e) => { e.stopPropagation(); onDelete(); }}>×</button>
              </div>
            )}

            {/* === HEART BUTTON (Top Left) === */}
            <div className="absolute top-3 left-3 z-40">
              <button 
                className={`heart-btn w-10 h-10 rounded-full glass flex items-center justify-center text-xl shadow-lg border border-white/10 ${project.liked ? 'liked' : 'text-white/50'}`}
                onClick={handleHeartClick}
                title={isAdmin ? "Click to Reset Likes" : "Click to Appreciate"}
              >
                <i className={`${project.liked ? "fas" : "far"} fa-heart`}></i>
              </button>
              {isAdmin && (
                 <span className="absolute -bottom-4 left-1/2 -translate-x-1/2 text-[10px] font-bold text-white bg-black/50 px-1 rounded">
                   {project.likes || 0}
                 </span>
              )}
            </div>

            <div className="image-gallery p-4 bg-slate-800/40">
              {project.images?.slice(0, 3).map((img, idx) => (
                <div key={idx} className={isAdmin ? "media-editable" : ""}>
                  <img src={img} alt="" className="rounded-xl hover-pop" onClick={(e) => { e.stopPropagation(); onImageClick(img); }} />
                  {isAdmin && (
                    <div className="media-overlay rounded-xl">
                      <button className="media-btn bg-blue-600 text-white text-sm" onClick={(e) => { e.stopPropagation(); onManageImages(); }}>✏️</button>
                    </div>
                  )}
                </div>
              ))}
              {(!project.images || project.images.length === 0) && (
                <div className="col-span-3 h-28 flex items-center justify-center text-slate-500">
                   {isAdmin ? <button onClick={(e)=>{e.stopPropagation(); onManageImages()}} className="hover:text-cyan-400">+ Add Images</button> : "No images"}
                </div>
              )}
            </div>

            <div className="p-6" onClick={onClick}>
              <div className="flex justify-between items-start mb-3">
                <h3 className="text-xl font-bold text-white group-hover:text-gradient transition-all">{project.title}</h3>
                <span className="text-xs px-3 py-1 rounded-full bg-slate-800 text-slate-400">{project.year}</span>
              </div>
              <p className="text-sm font-medium mb-3" style={{ color: theme.primaryColor }}>{project.company}</p>
              
              <div 
                className="text-slate-400 text-sm mb-5 line-clamp-2"
                dangerouslySetInnerHTML={{ __html: project.shortDesc }}
              ></div>

              <button className="w-full py-3 rounded-xl font-semibold text-sm transition-all hover:scale-[1.02]"
                style={{ background: `linear-gradient(135deg, ${theme.primaryColor}30, ${theme.secondaryColor}20)`, color: theme.primaryColor, border: `1px solid ${theme.primaryColor}40` }}>
                View Details →
              </button>
            </div>
          </div>
        );
      };

      // === PROJECT MODAL ===
      const ProjectModal = ({
        project,
        onClose,
        isAdmin,
        theme,
        data,
        setData,
        openEdit,
        onImageClick,
      }) => {
        const [mediaManager, setMediaManager] = useState({
          open: false,
          type: null,
        });
        if (!project) return null;

        const p = data.projects.find((x) => x.id === project.id) || project;
        const idx = data.projects.findIndex((x) => x.id === project.id);

        return (
          <div className="modal-overlay" onClick={onClose}>
            <div
              className="modal-content glass-strong"
              onClick={(e) => e.stopPropagation()}
            >
              <div className="p-8">
                <div className="flex justify-between items-start mb-8">
                  <div>
                    <h2
                      className={`text-3xl font-bold text-white mb-2 ${
                        isAdmin ? "editable-highlight" : ""
                      }`}
                      onClick={() =>
                        isAdmin &&
                        openEdit(
                          `projects.${idx}.title`,
                          p.title,
                          "text",
                          "Project Title"
                        )
                      }
                    >
                      {p.title}
                    </h2>
                    <div className="flex gap-4 text-sm">
                      <span
                        className={isAdmin ? "editable-highlight" : ""}
                        style={{ color: theme.primaryColor }}
                        onClick={() =>
                          isAdmin &&
                          openEdit(
                            `projects.${idx}.company`,
                            p.company,
                            "text",
                            "Company"
                          )
                        }
                      >
                        {p.company}
                      </span>
                      <span
                        className={`text-slate-400 ${
                          isAdmin ? "editable-highlight" : ""
                        }`}
                        onClick={() =>
                          isAdmin &&
                          openEdit(
                            `projects.${idx}.year`,
                            p.year,
                            "text",
                            "Year"
                          )
                        }
                      >
                        {p.year}
                      </span>
                    </div>
                  </div>
                  <button
                    onClick={onClose}
                    className="text-slate-400 hover:text-white text-3xl transition-all hover:rotate-90"
                  >
                    ×
                  </button>
                </div>

                {/* Images */}
                <div className="mb-8">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-lg font-bold">📸 Images</h3>
                    {isAdmin && (
                      <button
                        onClick={() =>
                          setMediaManager({ open: true, type: "images" })
                        }
                        className="text-sm px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700"
                        style={{ color: theme.primaryColor }}
                      >
                        Manage
                      </button>
                    )}
                  </div>
                  {p.images?.length > 0 ? (
                    <div className="image-gallery">
                      {p.images.map((img, i) => (
                        <img
                          key={i}
                          src={img}
                          alt=""
                          className="hover-pop"
                          onClick={(e) => {
                            e.stopPropagation();
                            onImageClick(img);
                          }}
                        />
                      ))}
                    </div>
                  ) : (
                    <p className="text-slate-500 text-center py-6">No images</p>
                  )}
                </div>

                {/* Videos */}
                <div className="mb-8">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-lg font-bold">
                      🎬 Videos{" "}
                      <span className="text-sm font-normal text-slate-400">
                        (hover to play)
                      </span>
                    </h3>
                    {isAdmin && (
                      <button
                        onClick={() =>
                          setMediaManager({ open: true, type: "videos" })
                        }
                        className="text-sm px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700"
                        style={{ color: theme.primaryColor }}
                      >
                        Manage
                      </button>
                    )}
                  </div>
                  {p.videos?.length > 0 ? (
                    <div className="space-y-4">
                      {p.videos.map((v, i) => (
                        <VideoHoverPlayer
                          key={i}
                          src={v}
                          className="aspect-video"
                          isAdmin={false}
                        />
                      ))}
                    </div>
                  ) : (
                    <p className="text-slate-500 text-center py-6">
                      No videos yet
                    </p>
                  )}
                </div>

                {/* Description */}
                {/* Description - Fixed (Single Entry) */}
                <div className="mb-8">
                  <h3 className="text-lg font-bold mb-3">📝 Description</h3>
                  <div
                    className={`text-slate-300 leading-relaxed ${isAdmin ? "editable-highlight" : ""}`}
                    onClick={() => isAdmin && openEdit(
                      `projects.${idx}.longDesc`,
                      p.longDesc,
                      "textarea", // This enables the Big Editor
                      "Description"
                    )
                    }
                    dangerouslySetInnerHTML={{ __html: p.longDesc }}
                  ></div>
                </div>

                {/* Skills & Tools */}
                <div className="grid md:grid-cols-2 gap-8 mb-8">
                  <div>
                    <h3 className="text-lg font-bold mb-4">🎯 Skills</h3>
                    <div
                      className={`flex flex-wrap gap-2 ${
                        isAdmin ? "editable-highlight" : ""
                      }`}
                      onClick={() =>
                        isAdmin &&
                        openEdit(
                          `projects.${idx}.skills`,
                          p.skills?.join(", "),
                          "text",
                          "Skills",
                          true
                        )
                      }
                    >
                      {p.skills?.map((s) => (
                        <span
                          key={s}
                          className="skill-tag px-4 py-2 rounded-full text-sm"
                        >
                          {s}
                        </span>
                      ))}
                    </div>
                  </div>
                  <div>
                    <h3 className="text-lg font-bold mb-4">🛠️ Tools</h3>
                    <div
                      className={`flex flex-wrap gap-2 ${
                        isAdmin ? "editable-highlight" : ""
                      }`}
                      onClick={() =>
                        isAdmin &&
                        openEdit(
                          `projects.${idx}.tools`,
                          p.tools?.join(", "),
                          "text",
                          "Tools",
                          true
                        )
                      }
                    >
                      {p.tools?.map((t) => (
                        <span
                          key={t}
                          className="tool-tag px-4 py-2 rounded-full text-sm"
                        >
                          {t}
                        </span>
                      ))}
                    </div>
                  </div>
                </div>

                {/* PDFs */}
                <div>
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-lg font-bold">📄 Documents</h3>
                    {isAdmin && (
                      <button
                        onClick={() =>
                          setMediaManager({ open: true, type: "pdfs" })
                        }
                        className="text-sm px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700"
                        style={{ color: theme.primaryColor }}
                      >
                        Manage
                      </button>
                    )}
                  </div>
                  {p.pdfs?.length > 0 ? (
                    <div className="flex flex-wrap gap-3">
                      {p.pdfs.map((pdf, i) => (
                        <button
                          key={i}
                          onClick={() =>
                            handlePdfAccess(isAdmin, pdf.url || pdf, pdf.name)
                          }
                          className="flex items-center gap-2 px-5 py-3 rounded-xl bg-slate-800 hover:bg-slate-700 transition-colors"
                        >
                          <span>📄 {pdf.name || "Document"}</span>
                          {!isAdmin && (
                            <span className="text-xs text-slate-500">🔒</span>
                          )}
                        </button>
                      ))}
                    </div>
                  ) : (
                    <p className="text-slate-500">No documents</p>
                  )}
                </div>
              </div>
            </div>
            {mediaManager.open && (
              <MediaManagerModal
                isOpen
                onClose={() => setMediaManager({ open: false })}
                targetId={p.id}
                targetType="project"
                mediaType={mediaManager.type}
                data={data}
                setData={setData}
                theme={theme}
              />
            )}
          </div>
        );
      };

      // === SETTINGS PANEL ===
      const SettingsPanel = ({ isOpen, theme, setTheme }) => {
        const [tab, setTab] = useState("MAIN");
        if (!isOpen) return null;

        const updateColor = (color, type) => {
          const newTheme = { ...theme, [type]: color };
          setTheme(newTheme);
          document.documentElement.style.setProperty(
            `--${type.replace("Color", "-color")}`,
            color
          );
          document.documentElement.style.setProperty(
            `--${type.replace("Color", "-rgb")}`,
            hexToRgb(color)
          );
        };

        const ColorControl = ({ label, value, onChange }) => (
          <div className="mb-3">
            <label className="text-[10px] text-slate-400 mb-1 block uppercase font-bold">
              {label}
            </label>
            <div className="flex items-center gap-2">
              <div
                className="relative w-8 h-8 rounded border border-slate-600 overflow-hidden flex-shrink-0"
                onClick={(e) => e.stopPropagation()}
              >
                <input
                  type="color"
                  value={value}
                  onChange={(e) => onChange(e.target.value)}
                  className="absolute -top-2 -left-2 w-16 h-16 p-0 border-0 cursor-pointer"
                />
              </div>
              <input
                type="text"
                value={value}
                onChange={(e) => onChange(e.target.value)}
                className="flex-1 bg-slate-800 border border-slate-700 text-xs px-2 py-1 rounded text-white font-mono uppercase"
                maxLength={7}
              />
            </div>
          </div>
        );

        const RangeControl = ({ label, min, max, step, value, onChange }) => (
          <div className="slider-container">
            <label className="text-[10px] text-slate-400 block mb-2 flex justify-between uppercase font-bold">
              <span>{label}</span>
              <span style={{ color: theme.primaryColor }}>{value}</span>
            </label>
            <input
              type="range"
              min={min}
              max={max}
              step={step}
              value={value}
              onChange={onChange}
            />
          </div>
        );

        const ToggleControl = ({ label, checked, onChange }) => (
          <label className="flex items-center justify-between cursor-pointer group mb-2 p-2 rounded hover:bg-white/5 transition">
            <span className="text-[10px] text-slate-300 group-hover:text-white transition uppercase font-bold">
              {label}
            </span>
            <div className="relative">
              <input
                type="checkbox"
                checked={checked}
                onChange={onChange}
                className="sr-only peer"
              />
              <div className="w-9 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-cyan-500"></div>
            </div>
          </label>
        );

        return (
          <div
            className="settings-panel glass-strong"
            data-aos="zoom-in"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-xl font-bold text-gradient">
                ✨ Theme Settings
              </h3>
            </div>

            <div className="flex gap-1 mb-6 border-b border-slate-700 pb-2">
              <button
                onClick={() => setTab("MAIN")}
                className={`tab-btn ${tab === "MAIN" ? "active" : ""}`}
              >
                General
              </button>
              <button
                onClick={() => setTab("SATURN")}
                className={`tab-btn ${tab === "SATURN" ? "active" : ""}`}
              >
                Saturn
              </button>
              <button
                onClick={() => setTab("COSMOS")}
                className={`tab-btn ${tab === "COSMOS" ? "active" : ""}`}
              >
                Cosmos
              </button>
              <button
                onClick={() => setTab("FLUID")}
                className={`tab-btn ${tab === "FLUID" ? "active" : ""}`}
              >
                Fluid
              </button>
            </div>

            {tab === "MAIN" && (
              <>
                {["primaryColor", "secondaryColor"].map((colorType) => (
                  <div key={colorType} className="mb-6">
                    <label className="text-sm text-slate-300 block mb-3 uppercase font-bold">
                      {colorType
                        .replace("Color", " Color")
                        .replace(/([A-Z])/g, " $1")
                        .trim()}
                    </label>
                    <div className="flex gap-2 flex-wrap mb-3">
                      {presetColors.map((c) => (
                        <button
                          key={c}
                          className={`color-swatch ${
                            theme[colorType] === c ? "active" : ""
                          }`}
                          style={{ background: c, color: c }}
                          onClick={() => updateColor(c, colorType)}
                        />
                      ))}
                    </div>
                    <div
                      className="color-picker-wrapper"
                      onClick={(e) => e.stopPropagation()}
                    >
                      <input
                        type="color"
                        value={theme[colorType]}
                        onChange={(e) => updateColor(e.target.value, colorType)}
                        className="cursor-pointer"
                      />
                    </div>
                  </div>
                ))}
                <div className="p-3 bg-slate-800/50 rounded-lg space-y-2">
                  <RangeControl
                    label="Animation Speed"
                    min="0.1"
                    max="3"
                    step="0.1"
                    value={theme.animationSpeed || 1}
                    onChange={(e) => {
                      const val = parseFloat(e.target.value);
                      setTheme({ ...theme, animationSpeed: val });
                      document.documentElement.style.setProperty(
                        "--animation-speed",
                        val
                      );
                    }}
                  />
                  <RangeControl
                    label="Glow Intensity"
                    min="0"
                    max="2"
                    step="0.1"
                    value={theme.glowIntensity || 1}
                    onChange={(e) => {
                      const val = parseFloat(e.target.value);
                      setTheme({ ...theme, glowIntensity: val });
                      document.documentElement.style.setProperty(
                        "--glow-intensity",
                        val
                      );
                    }}
                  />
                  <ToggleControl
                    label="Space Effects"
                    checked={theme.spaceEffects !== false}
                    onChange={(e) =>
                      setTheme({ ...theme, spaceEffects: e.target.checked })
                    }
                  />
                  <ToggleControl
                    label="Cursor Trail"
                    checked={theme.cursorTrail !== false}
                    onChange={(e) =>
                      setTheme({ ...theme, cursorTrail: e.target.checked })
                    }
                  />
                </div>
              </>
            )}

            {tab === "SATURN" && (
              <div className="space-y-4">
                <div className="p-3 bg-slate-800/50 rounded-lg">
                  <h4 className="text-[10px] font-black text-slate-400 mb-2 uppercase tracking-wider border-b border-slate-700 pb-1">
                    Planet Core
                  </h4>
                  <div className="grid grid-cols-2 gap-2">
                    <ColorControl
                      label="Base"
                      value={theme.pBase}
                      onChange={(v) => setTheme({ ...theme, pBase: v })}
                    />
                    <ColorControl
                      label="Glow"
                      value={theme.pGlow}
                      onChange={(v) => setTheme({ ...theme, pGlow: v })}
                    />
                  </div>
                  <RangeControl
                    label="Roughness"
                    min="0"
                    max="1"
                    step="0.1"
                    value={theme.pRough}
                    onChange={(e) =>
                      setTheme({ ...theme, pRough: parseFloat(e.target.value) })
                    }
                  />
                  <RangeControl
                    label="Metalness"
                    min="0"
                    max="1"
                    step="0.1"
                    value={theme.pMetal}
                    onChange={(e) =>
                      setTheme({ ...theme, pMetal: parseFloat(e.target.value) })
                    }
                  />
                  <RangeControl
                    label="Rotation Speed"
                    min="0"
                    max="5"
                    step="0.1"
                    value={theme.rotSpeed}
                    onChange={(e) =>
                      setTheme({
                        ...theme,
                        rotSpeed: parseFloat(e.target.value),
                      })
                    }
                  />
                </div>

                <div className="p-3 bg-slate-800/50 rounded-lg">
                  <h4 className="text-[10px] font-black text-slate-400 mb-2 uppercase tracking-wider border-b border-slate-700 pb-1">
                    Rings
                  </h4>
                  <ToggleControl
                    label="Gyro Pattern"
                    checked={theme.gyroPattern}
                    onChange={(e) =>
                      setTheme({ ...theme, gyroPattern: e.target.checked })
                    }
                  />
                  <div className="grid grid-cols-3 gap-2 mt-2">
                    <ColorControl
                      label="Inner"
                      value={theme.r1Col}
                      onChange={(v) => setTheme({ ...theme, r1Col: v })}
                    />
                    <ColorControl
                      label="Mid"
                      value={theme.r2Col}
                      onChange={(v) => setTheme({ ...theme, r2Col: v })}
                    />
                    <ColorControl
                      label="Outer"
                      value={theme.r3Col}
                      onChange={(v) => setTheme({ ...theme, r3Col: v })}
                    />
                  </div>
                  <RangeControl
                    label="Thickness"
                    min="0.01"
                    max="0.5"
                    step="0.01"
                    value={theme.rThick}
                    onChange={(e) =>
                      setTheme({ ...theme, rThick: parseFloat(e.target.value) })
                    }
                  />
                  <RangeControl
                    label="Ring Metal"
                    min="0"
                    max="1"
                    step="0.1"
                    value={theme.rMetal}
                    onChange={(e) =>
                      setTheme({ ...theme, rMetal: parseFloat(e.target.value) })
                    }
                  />
                </div>
              </div>
            )}

            {tab === "COSMOS" && (
              <div className="space-y-4">
                <div className="p-3 bg-slate-800/50 rounded-lg">
                  <h4 className="text-[10px] font-black text-slate-400 mb-2 uppercase tracking-wider border-b border-slate-700 pb-1">
                    Environment
                  </h4>
                  <ToggleControl
                    label="Star Field"
                    checked={theme.stars}
                    onChange={(e) =>
                      setTheme({ ...theme, stars: e.target.checked })
                    }
                  />
                  <ToggleControl
                    label="Asteroid Belt"
                    checked={theme.ast}
                    onChange={(e) =>
                      setTheme({ ...theme, ast: e.target.checked })
                    }
                  />
                  <ToggleControl
                    label="Data Streams"
                    checked={theme.shoot}
                    onChange={(e) =>
                      setTheme({ ...theme, shoot: e.target.checked })
                    }
                  />
                  <ToggleControl
                    label="Nebula Clouds"
                    checked={theme.nebula}
                    onChange={(e) =>
                      setTheme({ ...theme, nebula: e.target.checked })
                    }
                  />
                  <ColorControl
                    label="Nebula Tint"
                    value={theme.nebColor}
                    onChange={(v) => setTheme({ ...theme, nebColor: v })}
                  />
                </div>

                <div className="p-3 bg-slate-800/50 rounded-lg">
                  <h4 className="text-[10px] font-black text-slate-400 mb-2 uppercase tracking-wider border-b border-slate-700 pb-1">
                    Core Variants
                  </h4>
                  <ToggleControl
                    label="Neutron Core"
                    checked={theme.neutron}
                    onChange={(e) =>
                      setTheme({ ...theme, neutron: e.target.checked })
                    }
                  />
                  <ToggleControl
                    label="Neptune Core"
                    checked={theme.neptune}
                    onChange={(e) =>
                      setTheme({ ...theme, neptune: e.target.checked })
                    }
                  />
                  {theme.neptune && (
                    <div className="grid grid-cols-2 gap-2 mt-2">
                      <ColorControl
                        label="Core"
                        value={theme.neptuneColA}
                        onChange={(v) => setTheme({ ...theme, neptuneColA: v })}
                      />
                      <ColorControl
                        label="Atmos"
                        value={theme.neptuneColB}
                        onChange={(v) => setTheme({ ...theme, neptuneColB: v })}
                      />
                    </div>
                  )}
                </div>

                <div className="p-3 bg-slate-800/50 rounded-lg">
                  <h4 className="text-[10px] font-black text-slate-400 mb-2 uppercase tracking-wider border-b border-slate-700 pb-1">
                    Lightning
                  </h4>
                  <ToggleControl
                    label="Active"
                    checked={theme.lightning}
                    onChange={(e) =>
                      setTheme({ ...theme, lightning: e.target.checked })
                    }
                  />
                  {theme.lightning && (
                    <div className="mt-2 space-y-2">
                      <div className="grid grid-cols-2 gap-2">
                        <ColorControl
                          label="Bolt A"
                          value={theme.lightningColA}
                          onChange={(v) =>
                            setTheme({ ...theme, lightningColA: v })
                          }
                        />
                        <ColorControl
                          label="Bolt B"
                          value={theme.lightningColB}
                          onChange={(v) =>
                            setTheme({ ...theme, lightningColB: v })
                          }
                        />
                      </div>
                      <RangeControl
                        label="Bolt Intensity"
                        min="0.1"
                        max="3.0"
                        step="0.1"
                        value={theme.lightningIntensity}
                        onChange={(e) =>
                          setTheme({
                            ...theme,
                            lightningIntensity: parseFloat(e.target.value),
                          })
                        }
                      />
                    </div>
                  )}
                </div>
              </div>
            )}

            {tab === "FLUID" && (
              <div className="space-y-4">
                <div className="p-3 bg-slate-800/50 rounded-lg">
                  <h4 className="text-[10px] font-black text-slate-400 mb-2 uppercase tracking-wider border-b border-slate-700 pb-1">
                    Simulation
                  </h4>
                  <ToggleControl
                    label="Active Simulation"
                    checked={theme.fluidEnabled}
                    onChange={(e) =>
                      setTheme({ ...theme, fluidEnabled: e.target.checked })
                    }
                  />
                  <div className="grid grid-cols-2 gap-2 mt-2">
                    <ColorControl
                      label="Grad Start"
                      value={theme.fluidColorA}
                      onChange={(v) => setTheme({ ...theme, fluidColorA: v })}
                    />
                    <ColorControl
                      label="Grad End"
                      value={theme.fluidColorB}
                      onChange={(v) => setTheme({ ...theme, fluidColorB: v })}
                    />
                  </div>
                </div>
                <div className="p-3 bg-slate-800/50 rounded-lg">
                  <h4 className="text-[10px] font-black text-slate-400 mb-2 uppercase tracking-wider border-b border-slate-700 pb-1">
                    Physics
                  </h4>
                  <RangeControl
                    label="Splash Radius"
                    min="0"
                    max="100"
                    step="1"
                    value={theme.fluidRadius}
                    onChange={(e) =>
                      setTheme({
                        ...theme,
                        fluidRadius: parseFloat(e.target.value),
                      })
                    }
                  />
                  <RangeControl
                    label="Splash Speed"
                    min="0.1"
                    max="5.0"
                    step="0.1"
                    value={theme.fluidSpeed}
                    onChange={(e) =>
                      setTheme({
                        ...theme,
                        fluidSpeed: parseFloat(e.target.value),
                      })
                    }
                  />
                  <RangeControl
                    label="Glow Force"
                    min="1000"
                    max="10000"
                    step="100"
                    value={theme.fluidForce}
                    onChange={(e) =>
                      setTheme({
                        ...theme,
                        fluidForce: parseFloat(e.target.value),
                      })
                    }
                  />
                  <RangeControl
                    label="Dissipation"
                    min="0"
                    max="100"
                    step="1"
                    value={theme.fluidDissipation}
                    onChange={(e) =>
                      setTheme({
                        ...theme,
                        fluidDissipation: parseFloat(e.target.value),
                      })
                    }
                  />
                </div>
              </div>
            )}

            <button
              onClick={() => {
                const defaultTheme = {
                  primaryColor: "#06b6d4",
                  secondaryColor: "#a855f7",
                  animationSpeed: 1,
                  glowIntensity: 1,
                  spaceEffects: true,
                  cursorTrail: true,
                  pBase: "#050505",
                  pGlow: "#001133",
                  pRough: 0.2,
                  pMetal: 0.8,
                  r1Col: "#ff0055",
                  r2Col: "#00f0ff",
                  r3Col: "#ccff00",
                  rThick: 0.1,
                  rMetal: 0.9,
                  rRough: 0.1,
                  gyroPattern: true,
                  stars: true,
                  ast: true,
                  shoot: true,
                  nebula: true,
                  nebColor: "#1a0033",
                  neutron: false,
                  neptune: false,
                  neptuneColA: "#0a1a3a",
                  neptuneColB: "#0044aa",
                  lightning: false,
                  lightningColA: "#00f0ff",
                  lightningColB: "#ffffff",
                  lightningIntensity: 1.2,
                  rotSpeed: 1.0,
                  fluidEnabled: true,
                  fluidRes: 128,
                  fluidDissipation: 1.0,
                  fluidForce: 6000,
                  fluidRadius: 40,
                  fluidSpeed: 1.0,
                  fluidColorA: "#00f0ff",
                  fluidColorB: "#ff0055",
                };
                setTheme(defaultTheme);
                Object.entries(defaultTheme).forEach(([k, v]) => {
                  if (k.includes("Color") && !k.includes("fluid")) {
                    document.documentElement.style.setProperty(
                      `--${k.replace("Color", "-color")}`,
                      v
                    );
                    document.documentElement.style.setProperty(
                      `--${k.replace("Color", "-rgb")}`,
                      hexToRgb(v)
                    );
                  }
                });
                document.documentElement.style.setProperty(
                  "--animation-speed",
                  1
                );
                document.documentElement.style.setProperty(
                  "--glow-intensity",
                  1
                );
              }}
              className="w-full py-3 mt-6 text-sm text-slate-400 hover:text-white border border-slate-700 rounded-xl transition-colors hover:border-slate-500"
            >
              Reset to Default
            </button>
          </div>
        );
      };

      // === MAIN APP ===
      const App = () => {
        const menuStructure = [
          { name: "Home", link: "#home" },
          {
            name: "Experience",
            link: "#experience",
            submenu: [
              { name: "Skills", link: "#skills" },
              { name: "Volunteer Work", link: "#volunteer" },
              { name: "Licenses", link: "#info-grid" } // Licenses is in the info-grid section
            ]
          },
          {
            name: "Education",
            link: "#education",
            submenu: [
              { name: "Internships", link: "#internships" },
              { name: "Certifications", link: "#certifications" },
              { name: "Publications", link: "#publications" }
            ]
          },
          { name: "Featured Projects", link: "#projects" },
          { name: "Languages", link: "#info-grid" }, // Languages is also in info-grid
          { name: "Contact", link: "#contact" }
        ];
        const FORMSPREE_ENDPOINT = "https://formspree.io/f/xzzngoqy";
        const [data, setData] = useState(() => {
          try {
            return (
              JSON.parse(localStorage.getItem("portfolioData")) || initialData
            );
          } catch {
            return initialData;
          }
        });

        const DEFAULT_THEME = {
          primaryColor: "#06b6d4",
          secondaryColor: "#a855f7",
          animationSpeed: 1,
          glowIntensity: 1,
          spaceEffects: true,
          cursorTrail: true,
          pBase: "#050505",
          pGlow: "#001133",
          pRough: 0.2,
          pMetal: 0.8,
          r1Col: "#ff0055",
          r2Col: "#00f0ff",
          r3Col: "#ccff00",
          rThick: 0.1,
          rMetal: 0.9,
          rRough: 0.1,
          gyroPattern: true,
          stars: true,
          ast: true,
          shoot: true,
          nebula: true,
          nebColor: "#1a0033",
          neutron: false,
          neptune: false,
          neptuneColA: "#0a1a3a",
          neptuneColB: "#0044aa",
          lightning: false,
          lightningColA: "#00f0ff",
          lightningColB: "#ffffff",
          lightningIntensity: 1.2,
          rotSpeed: 1.0,
          fluidEnabled: true,
          fluidRes: 128,
          fluidDissipation: 1.0,
          fluidForce: 6000,
          fluidRadius: 40,
          fluidSpeed: 1.0,
          fluidColorA: "#00f0ff",
          fluidColorB: "#ff0055",
        };

        const [theme, setTheme] = useState(() => {
          try {
            return {
              ...DEFAULT_THEME,
              ...JSON.parse(localStorage.getItem("portfolioTheme")),
            };
          } catch {
            return DEFAULT_THEME;
          }
        });

        const [isAdmin, setIsAdmin] = useState(false);
        const [viewMode, setViewMode] = useState("visitor");
        const [showLogin, setShowLogin] = useState(false);
        const [loginForm, setLoginForm] = useState({
          email: "",
          pass: "",
          error: "",
        });
        const [settingsOpen, setSettingsOpen] = useState(false);
        const [selectedProject, setSelectedProject] = useState(null);
        const [visibleProjects, setVisibleProjects] = useState(6);
        const [mobileMenu, setMobileMenu] = useState(false);
        const [galleryView, setGalleryView] = useState({
          open: false,
          experienceId: null,
        });

        // This is the new line we needed (Fixed placement)
        const [eduView, setEduView] = useState({
          open: false,
          id: null
        });

        const [internView, setInternView] = useState({
          open: false,
          id: null
        });

        // === FIXED: BODY CLASS HANDLER (Fixes Cursor Lag) ===
        useEffect(() => {
          if (adminMode) {
            document.body.classList.add("admin-mode");
            // Force removal of custom cursor elements to stop lag
            const dots = document.querySelectorAll("#cursor-dot, #cursor-outline");
            dots.forEach(el => el.style.display = 'none');
          } else {
            document.body.classList.remove("admin-mode");
            // Restore custom cursor
            const dots = document.querySelectorAll("#cursor-dot, #cursor-outline");
            dots.forEach(el => el.style.display = 'block');
          }
        }, [adminMode]);

        // === REAL-TIME CLOUD DATA (TRAFFIC + LIKES) ===
        useEffect(() => {
          const initRealTimeData = async () => {
            const DOMAIN = "mjabid.work.gd";
            let updatedStats = { ...data.stats };
            let updatedProjects = [...data.projects];

            // 1. FETCH SITE TRAFFIC (Visitors & Views)
            try {
              const [visitRes, viewRes] = await Promise.all([
                fetch(`https://api.counterapi.dev/v1/${DOMAIN}/visitors/up`),
                fetch(`https://api.counterapi.dev/v1/${DOMAIN}/views/up`)
              ]);
              const visitJson = await visitRes.json();
              const viewJson = await viewRes.json();

              updatedStats.visitors = visitJson.count || 1;
              updatedStats.views = viewJson.count || 1;
              // Simulating 'Active Users' (Since GitHub Pages can't track live sockets)
              updatedStats.active = Math.floor(Math.random() * (15 - 5 + 1) + 5);
            } catch (e) {
              console.warn("Traffic API error (Adblocker?)");
            }

            // 2. FETCH REAL PROJECT LIKES
            // We loop through every project and ask the cloud for its current count
            let totalAppreciations = 0;

            await Promise.all(updatedProjects.map(async (project, index) => {
              try {
                // Determine if THIS user has already liked this project locally
                const hasLikedLocal = localStorage.getItem(`liked_${project.id}`) === "true";

                // Fetch Global Count
                const res = await fetch(`https://api.counterapi.dev/v1/${DOMAIN}/project_${project.id}/`);
                const json = await res.json();

                // If API returns a count, use it. If 404 (new project), use 0.
                const realCount = json.code === 404 ? 0 : (json.count || 0);

                updatedProjects[index] = {
                  ...project,
                  likes: realCount,
                  liked: hasLikedLocal // UI turns red if THEY liked it
                };
                totalAppreciations += realCount;
              } catch (e) {
                // Keep default if offline
              }
            }));

            // 3. UPDATE STATE
            updatedStats.appreciations = totalAppreciations;

            setData(prev => ({
              ...prev,
              stats: updatedStats,
              projects: updatedProjects
            }));
          };

          initRealTimeData();

          // Keep 'Active Users' fluctuating slightly to look alive
          const interval = setInterval(() => {
            setData(prev => ({
              ...prev,
              stats: {
                ...prev.stats,
                active: Math.floor(Math.random() * (18 - 4 + 1) + 4)
              }
            }));
          }, 5000);

          return () => clearInterval(interval);
        }, []);

        // New UI States
        const [showVault, setShowVault] = useState(false);
        const [lightboxSrc, setLightboxSrc] = useState(null);
        const [imageTools, setImageTools] = useState({
          open: false,
          src: null,
        });

        // Modals
        const [editModal, setEditModal] = useState({ open: false });
        const [profileModal, setProfileModal] = useState(false);
        const [cvModal, setCvModal] = useState(false);
        const [addModal, setAddModal] = useState({ open: false, type: null });
        const [addSkillModal, setAddSkillModal] = useState(false);
        const [socialModal, setSocialModal] = useState({
          open: false,
          editItem: null,
        });
        const [newSkill, setNewSkill] = useState("");
        const [mediaManager, setMediaManager] = useState({
          open: false,
          targetId: null,
          targetType: null,
          type: null,
        });

        const adminMode = isAdmin && viewMode === "admin";

        // Save theme
        useEffect(() => {
          localStorage.setItem("portfolioTheme", JSON.stringify(theme));
        }, [theme]);

        // Initialize
        useEffect(() => {
          AOS.init({ duration: 800, once: false, offset: 100 });

          // --- OPTIMIZED CURSOR LOGIC ---
          const dot = document.getElementById("cursor-dot");
          const outline = document.getElementById("cursor-outline");
          let lastX = 0, lastY = 0;

          // 1. MOVEMENT HANDLER
          const moveCursor = (e) => {
            // STOP cursor calculations if in Admin Mode
            if (isAdmin || document.body.classList.contains('admin-mode')) return;

            if (dot && outline) {
              // Only move if we are NOT admin
              dot.style.left = `${e.clientX}px`;
              dot.style.top = `${e.clientY}px`;
              outline.style.left = `${e.clientX}px`;
              outline.style.top = `${e.clientY}px`;
            }

            // Trail Effect (Only for visitors)
            if (
              theme.cursorTrail !== false &&
              !document.body.classList.contains('admin-mode') &&
              (Math.abs(e.clientX - lastX) > 25 || Math.abs(e.clientY - lastY) > 25)
            ) {
              const trail = document.createElement("div");
              trail.className = "cursor-trail";
              trail.style.left = `${e.clientX}px`;
              trail.style.top = `${e.clientY}px`;
              document.body.appendChild(trail);
              setTimeout(() => trail.remove(), 600);
              lastX = e.clientX;
              lastY = e.clientY;
            }
          };

          // 2. HOVER HANDLER
          const handleHover = (e) => {
            if (document.body.classList.contains('admin-mode')) return;

            const isInteractive = e.target.closest('a, button, .editable-highlight, input, textarea');
            const isTextInput = e.target.closest('input[type="text"], textarea');

            if (outline) {
              outline.classList.toggle("hover", !!isInteractive && !isTextInput);
              outline.classList.toggle("text-hover", !!isTextInput);
            }
          };

          // 3. CLICK HANDLER
          const handleClick = (e) => {
            if (document.body.classList.contains('admin-mode')) return;

            if (outline) {
              outline.classList.add("clicking");
              setTimeout(() => outline.classList.remove("clicking"), 150);
            }
            createClickParticles(e.clientX, e.clientY, [
              theme.primaryColor,
              theme.secondaryColor,
              "#10b981",
            ]);
          };

          // Add Listeners
          window.addEventListener("mousemove", moveCursor);
          window.addEventListener("mousemove", handleHover);
          window.addEventListener("click", handleClick);

          // Cleanup Listeners on Unmount
          return () => {
            window.removeEventListener("mousemove", moveCursor);
            window.removeEventListener("mousemove", handleHover);
            window.removeEventListener("click", handleClick);
          };
        }, [theme]);

        // Handlers
        const handleLogin = async (e) => {
          e.preventDefault();

          // 1. Scramble the email and password the user just typed
          const inputEmailHash = await hashInput(loginForm.email);
          const inputPassHash = await hashInput(loginForm.pass);

          // 2. Compare them against the scrambled codes in the config
          if (inputEmailHash !== ADMIN_CONFIG.emailHash) {
            return setLoginForm({ ...loginForm, error: "Invalid email" });
          }
          if (inputPassHash !== ADMIN_CONFIG.passHash) {
            return setLoginForm({ ...loginForm, error: "Wrong password" });
          }

          // 3. Success! Log them in
          setIsAdmin(true);
          setViewMode("admin");
          setShowLogin(false);
          setLoginForm({ email: "", pass: "", error: "" });
          showToast("Welcome back! 🎉");
        };

        const openEdit = (
          path,
          value,
          type = "text",
          label = "",
          isArray = false
        ) => {
          if (!adminMode) return;
          setEditModal({ open: true, path, value, type, label, isArray });
        };
        // --- NEW: REORDER FUNCTION ---
        const moveItem = (key, index, direction) => {
          const arr = [...data[key]];
          if (direction === 'up' && index > 0) {
            [arr[index], arr[index - 1]] = [arr[index - 1], arr[index]];
          } else if (direction === 'down' && index < arr.length - 1) {
            [arr[index], arr[index + 1]] = [arr[index + 1], arr[index]];
          } else {
            return;
          }
          const newData = { ...data, [key]: arr };
          setData(newData);
          localStorage.setItem("portfolioData", JSON.stringify(newData));
        };
        const deleteItem = (type, id) => {
          if (!confirm(`Delete this ${type}?`)) return;
          let key = type;
          if (type === "project") key = "projects";
          const newData = {
            ...data,
            [key]: data[key].filter((x) => x.id !== id),
          };
          setData(newData);
          localStorage.setItem("portfolioData", JSON.stringify(newData));
          showToast("Deleted!", "info");
        };

        const deleteSkill = (idx) => {
          const newData = {
            ...data,
            skills: data.skills.filter((_, i) => i !== idx),
          };
          setData(newData);
          localStorage.setItem("portfolioData", JSON.stringify(newData));
          showToast("Removed!", "info");
        };

        const addSkill = () => {
          if (!newSkill.trim()) return;
          // UPDATED: Push an object instead of a string
          const newData = {
            ...data,
            skills: [...data.skills, { name: newSkill.trim(), back: "Click to edit details" }],
          };
          setData(newData);
          localStorage.setItem("portfolioData", JSON.stringify(newData));
          setNewSkill("");
          setAddSkillModal(false);
          showToast("Skill added!");
        };

        const deleteSocial = (id) => {
          if (!confirm("Delete social link?")) return;
          const newData = {
            ...data,
            socialLinks: data.socialLinks.filter((s) => s.id !== id),
          };
          setData(newData);
          localStorage.setItem("portfolioData", JSON.stringify(newData));
          showToast("Deleted!", "info");
        };

        const updateSocialPosition = (id, x, y, scale) => {
          const newLinks = data.socialLinks.map((l) =>
            l.id === id ? { ...l, x, y, scale } : l
          );
          const newData = { ...data, socialLinks: newLinks };
          setData(newData);
          localStorage.setItem("portfolioData", JSON.stringify(newData));
        };

        const exportData = () => {
          const blob = new Blob([JSON.stringify(data, null, 2)], {
            type: "application/json",
          });
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "portfolio-backup.json";
          a.click();
          showToast("Exported! 📦");
        };

        const importData = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            try {
              const imported = JSON.parse(ev.target.result);
              setData(imported);
              localStorage.setItem("portfolioData", JSON.stringify(imported));
              showToast("Imported! 🎉");
            } catch {
              showToast("Invalid file!", "error");
            }
          };
          reader.readAsText(file);
        };

        const resetAll = () => {
          if (!confirm("Reset everything? This cannot be undone!")) return;
          setData(initialData);
          localStorage.removeItem("portfolioData");
          showToast("Reset complete!", "info");
        };

        // Admin Vault Reset
        const resetVault = () => {
          if (confirm("Are you sure? This deletes all passwords forever!")) {
            localStorage.removeItem("vaultPasswords");
            localStorage.removeItem("vaultMasterHash");
            localStorage.removeItem("vaultSecurityQuestion");
            localStorage.removeItem("vaultSecurityAnswerHash");
            showToast("Vault wiped!");
          }
        };
        
        // === GLOBAL REAL-TIME APPRECIATION HANDLER ===
        const handleLike = async (id) => {
          if (adminMode) {
            showToast("Admin cannot like projects", "info");
            return;
          }

          // 1. Check if user already liked this
          const isLiked = localStorage.getItem(`liked_${id}`) === "true";
          if (isLiked) {
            showToast("You already liked this!", "warning");
            return;
          }

          // 2. OPTIMISTIC UI UPDATE (Update screen immediately for speed)
          const newProjects = data.projects.map(p => {
            if (p.id === id) {
              return { ...p, likes: (p.likes || 0) + 1, liked: true };
            }
            return p;
          });

          setData(prev => ({
            ...prev,
            projects: newProjects,
            stats: { ...prev.stats, appreciations: (prev.stats.appreciations || 0) + 1 }
          }));

          // 3. SEND TO CLOUD (Background)
          try {
            const DOMAIN = "mjabid.work.gd";
            // The 'up' endpoint increments the counter in the cloud database
            await fetch(`https://api.counterapi.dev/v1/${DOMAIN}/project_${id}/up`);

            // Lock this user from clicking again
            localStorage.setItem(`liked_${id}`, "true");
            showToast("Appreciated! ❤️");
          } catch (e) {
            console.error("Like failed to sync");
          }
        };

        // Initial console log validation
        useEffect(() => {
          console.log(
            "App Initialized. Admin:",
            isAdmin,
            "Vault Present:",
            !!localStorage.getItem("vaultMasterHash"),
            "Sections:",
            Object.keys(data).length
          );
        }, []);

        return (
          <ThemeContext.Provider value={{ theme, setTheme }}>
            <div className="min-h-screen relative">
              {!adminMode && <FluidLayer theme={theme} />}
              <StarField theme={theme} />
              <NebulaBackground theme={theme} />

              {/* NAVBAR */}
              <nav className="fixed w-full z-50 glass py-4">
                <div className="container mx-auto px-6 flex justify-between items-center">
                  <div
                    className={`text-2xl font-bold tracking-tight ${
                      adminMode ? "editable-highlight" : ""
                    }`}
                    onClick={() =>
                      openEdit(
                        "navBrand.first",
                        data.navBrand?.first,
                        "text",
                        "Brand First"
                      )
                    }
                  >
                    <span className="text-gradient">
                      {data.navBrand?.first || "Junaid"}
                    </span>
                    <span className="text-white">
                      {data.navBrand?.second || "Abid"}
                    </span>
                  </div>

                  <div className="hidden md:flex items-center gap-6">
                    {menuStructure.map((item) => (
                      <div key={item.name} className="nav-item group h-full">
                        <a
                          href={item.link}
                          className="text-sm font-medium text-slate-300 hover:text-white transition-colors relative py-2"
                        >
                          {item.name}
                          {item.submenu && <span className="ml-1 text-[10px] opacity-50">▼</span>}
                          <span
                            className="absolute -bottom-1 left-0 w-0 h-0.5 group-hover:w-full transition-all"
                            style={{ background: theme.primaryColor }}
                          />
                        </a>

                        {/* Dropdown */}
                        {item.submenu && (
                          <div className="dropdown-menu">
                            {item.submenu.map((sub) => (
                              <a
                                key={sub.name}
                                href={sub.link}
                                className="dropdown-item"
                              >
                                {sub.name}
                              </a>
                            ))}
                          </div>
                        )}
                      </div>
                    ))}

                    {isAdmin && (
                      <div className="flex gap-1 p-1 rounded-full bg-slate-800/80 ml-4">
                        <button
                          onClick={() => setViewMode("visitor")}
                          className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${
                            viewMode === "visitor"
                              ? "bg-blue-600 text-white"
                              : "text-slate-400"
                          }`}
                        >
                          👁️ View
                        </button>
                        <button
                          onClick={() => setViewMode("admin")}
                          className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${
                            viewMode === "admin"
                              ? "text-white"
                              : "text-slate-400"
                          }`}
                          style={
                            viewMode === "admin"
                              ? {
                                  background: `linear-gradient(135deg, ${theme.primaryColor}, ${theme.secondaryColor})`,
                                }
                              : {}
                          }
                        >
                          ✏️ Edit
                        </button>
                      </div>
                    )}

                    {!isAdmin ? (
                      <button
                        onClick={() => setShowLogin(true)}
                        className="px-5 py-2 rounded-full border-2 text-xs font-bold tracking-wider transition-all hover:scale-105"
                        style={{
                          borderColor: theme.primaryColor,
                          color: theme.primaryColor,
                        }}
                      >
                        🔐 Admin
                      </button>
                    ) : (
                      <>
                        <button
                          onClick={() => setShowVault(true)}
                          className="px-4 py-2 rounded-full bg-purple-600 text-white text-xs font-bold hover:bg-purple-500"
                        >
                          🔒 Vault
                        </button>
                        <button
                          onClick={() => {
                            setIsAdmin(false);
                            setViewMode("visitor");
                            setShowVault(false);
                          }}
                          className="px-4 py-2 rounded-full bg-red-600/20 text-red-400 text-xs font-bold hover:bg-red-600/30"
                        >
                          Logout
                        </button>
                      </>
                    )}
                  </div>

                  <button
                    className="md:hidden text-white text-2xl"
                    onClick={() => setMobileMenu(!mobileMenu)}
                  >
                    {mobileMenu ? "✕" : "☰"}
                  </button>
                </div>
              </nav>

              {/* Mobile Menu */}
              {mobileMenu && (
                <div className="mobile-menu">
                  {menuStructure.map((item) => (
                    <React.Fragment key={item.name}>
                      <a
                        href={item.link}
                        className="text-3xl font-bold text-slate-300 hover:text-white"
                        onClick={() => setMobileMenu(false)}
                      >
                        {item.name}
                      </a>
                      {/* Show sub-items in mobile menu too */}
                      {item.submenu && item.submenu.map(sub => (
                        <a
                          key={sub.name}
                          href={sub.link}
                          className="text-lg font-medium text-slate-500 hover:text-white mobile-sub-link"
                          onClick={() => setMobileMenu(false)}
                        >
                          ↳ {sub.name}
                        </a>
                      ))}
                    </React.Fragment>
                  ))}
                  {!isAdmin && (
                    <button
                      onClick={() => {
                        setShowLogin(true);
                        setMobileMenu(false);
                      }}
                      className="text-xl font-bold"
                      style={{ color: theme.primaryColor }}
                    >
                      Admin Login
                    </button>
                  )}
                </div>
              )}

              {/* Floating Admin Panel with Labels */}
              {/* FIXED SIDE PANEL */}
              {adminMode && (
                <div className="floating-admin-panel">

                  <button className="fab-btn" onClick={() => setAddModal({ open: true, type: "experience" })}>
                    <span className="icon">➕</span>
                    <span className="fab-label">Add Experience</span>
                  </button>

                  <button className="fab-btn" onClick={() => setAddModal({ open: true, type: "project" })}>
                    <span className="icon">📁</span>
                    <span className="fab-label">Add Project</span>
                  </button>

                  <button className="fab-btn" onClick={() => setAddSkillModal(true)}>
                    <span className="icon">🏷️</span>
                    <span className="fab-label">Add Skill</span>
                  </button>

                  <button className="fab-btn" onClick={() => setCvModal(true)}>
                    <span className="icon">📄</span>
                    <span className="fab-label">Upload CV</span>
                  </button>

                  <button className="fab-btn" onClick={exportData}>
                    <span className="icon">📥</span>
                    <span className="fab-label">Export JSON</span>
                  </button>

                  <label className="fab-btn cursor-pointer">
                    <span className="icon">📤</span>
                    <span className="fab-label">Import JSON</span>
                    <input type="file" accept=".json" className="hidden" onChange={importData} />
                  </label>

                  <div className="h-[1px] w-full bg-slate-600 my-1 opacity-50"></div>

                  <button className="fab-btn" onClick={resetAll} style={{ borderColor: '#ef4444' }}>
                    <span className="icon">⚠️</span>
                    <span className="fab-label text-red-400">Reset Portfolio</span>
                  </button>

                  <button className="fab-btn" onClick={resetVault} style={{ borderColor: '#ef4444', background: 'rgba(239, 68, 68, 0.1)' }}>
                    <span className="icon">🧨</span>
                    <span className="fab-label text-red-400">Master Reset</span>
                  </button>

                </div>
              )}

              {/* Admin Mode Banner */}
              {adminMode && (
                <div
                  className="fixed top-20 left-1/2 -translate-x-1/2 z-40 px-6 py-3 rounded-full font-bold text-sm shimmer-text glass-strong border"
                  style={{ borderColor: theme.primaryColor }}
                >
                  ✨ ADMIN MODE — Click highlighted elements to edit
                </div>
              )}

              {/* VAULT */}
              {showVault && (
                <VaultWrapper
                  onClose={() => setShowVault(false)}
                  onResetVault={resetVault}
                  isAdmin={isAdmin}
                />
              )}

              {/* MODALS */}
              {showLogin && (
                <div className="modal-overlay">
                  <div className="glass-strong p-10 rounded-3xl w-[420px] relative">
                    <button
                      onClick={() => setShowLogin(false)}
                      className="absolute top-4 right-4 text-slate-400 hover:text-white text-2xl"
                    >
                      ✕
                    </button>
                    <h2 className="text-3xl font-bold mb-8 text-center text-gradient">
                      🔐 Admin Access
                    </h2>
                    <form onSubmit={handleLogin} className="space-y-5">
                      <input
                        type="email"
                        placeholder="Email"
                        className="w-full bg-slate-800 border-2 border-slate-600 rounded-xl p-4 text-white outline-none focus:border-cyan-400"
                        value={loginForm.email}
                        onChange={(e) =>
                          setLoginForm({ ...loginForm, email: e.target.value })
                        }
                      />
                      <input
                        type="password"
                        placeholder="Password"
                        className="w-full bg-slate-800 border-2 border-slate-600 rounded-xl p-4 text-white outline-none focus:border-cyan-400"
                        value={loginForm.pass}
                        onChange={(e) =>
                          setLoginForm({ ...loginForm, pass: e.target.value })
                        }
                      />
                      {loginForm.error && (
                        <p className="text-red-500 text-center text-sm">
                          {loginForm.error}
                        </p>
                      )}
                      <button
                        type="submit"
                        className="w-full py-4 rounded-xl font-bold text-lg transition-all hover:scale-105 shadow-glow"
                        style={{
                          background: `linear-gradient(135deg, ${theme.primaryColor}, ${theme.secondaryColor})`,
                        }}
                      >
                        Login
                      </button>
                    </form>
                    <div className="mt-4 text-center">
                      <button
                        className="text-sm text-slate-400 hover:text-white"
                        onClick={() =>
                          alert(
                            `Security Question: ${data.securityQuestion.question}\n(Contact owner for access)`
                          )
                        }
                      >
                        Forgot Password?
                      </button>
                    </div>
                  </div>
                </div>
              )}

              <EditModal
                editModal={editModal}
                setEditModal={setEditModal}
                data={data}
                setData={setData}
                theme={theme}
              />
              <SocialLinkModal
                isOpen={socialModal.open}
                onClose={() => setSocialModal({ open: false, editItem: null })}
                data={data}
                setData={setData}
                theme={theme}
                editingLink={socialModal.editItem}
              />
              {profileModal && (
                <ProfileImageModal
                  isOpen
                  onClose={() => setProfileModal(false)}
                  data={data}
                  setData={setData}
                  theme={theme}
                />
              )}
              {cvModal && (
                <CVModal
                  isOpen
                  onClose={() => setCvModal(false)}
                  data={data}
                  setData={setData}
                  theme={theme}
                />
              )}
              {addModal.open && (
                <AddItemModal
                  type={addModal.type}
                  isOpen
                  onClose={() => setAddModal({ open: false })}
                  data={data}
                  setData={setData}
                  theme={theme}
                />
              )}
              {selectedProject && (
                <ProjectModal
                  project={selectedProject}
                  onClose={() => setSelectedProject(null)}
                  isAdmin={adminMode}
                  theme={theme}
                  data={data}
                  setData={setData}
                  openEdit={openEdit}
                  onImageClick={setLightboxSrc}
                />
              )}

              {/* Unified Media Manager */}
              {mediaManager.open && (
                <MediaManagerModal
                  isOpen
                  onClose={() => setMediaManager({ open: false })}
                  targetId={mediaManager.targetId}
                  targetType={mediaManager.targetType}
                  mediaType={mediaManager.type}
                  data={data}
                  setData={setData}
                  theme={theme}
                />
              )}

              {/* Lightbox & Tools */}
              <LightboxModal
                isOpen={!!lightboxSrc}
                onClose={() => setLightboxSrc(null)}
                src={lightboxSrc}
              />
              <ImageEditorModal
                isOpen={imageTools.open}
                onClose={() => setImageTools({ open: false, src: null })}
                imageSrc={imageTools.src}
                theme={theme}
                onSave={(newUrl) => {
                  console.log("Saved");
                  showToast("Image Saved & Cropped!");
                }}
              />
              {/* Add Skill Modal */}
              {addSkillModal && (
                <div
                  className="modal-overlay"
                  onClick={() => setAddSkillModal(false)}
                >
                  <div
                    className="glass-strong p-8 rounded-3xl w-full max-w-md"
                    onClick={(e) => e.stopPropagation()}
                  >
                    <h2 className="text-xl font-bold mb-6 text-gradient">
                      🏷️ Add Skill
                    </h2>
                    <input
                      placeholder="Skill name"
                      className="w-full bg-slate-800 border border-slate-600 rounded-xl p-4 text-white outline-none mb-6"
                      value={newSkill}
                      onChange={(e) => setNewSkill(e.target.value)}
                      onKeyDown={(e) => e.key === "Enter" && addSkill()}
                    />
                    <div className="flex gap-4">
                      <button
                        onClick={() => setAddSkillModal(false)}
                        className="flex-1 py-3 bg-slate-700 rounded-xl font-bold"
                      >
                        Cancel
                      </button>
                      <button
                        onClick={addSkill}
                        className="flex-1 py-3 rounded-xl font-bold"
                        style={{
                          background: `linear-gradient(135deg, ${theme.primaryColor}, ${theme.secondaryColor})`,
                        }}
                      >
                        Add
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* MAIN CONTENT */}
              <main className="pt-20 relative z-10">
                {/* Hero */}
                <section
                  id="home"
                  className="min-h-screen flex items-center py-20"
                >
                  <div className="container mx-auto px-6 grid lg:grid-cols-2 gap-16 items-center">
                    <div data-aos="fade-right">
                      <p
                        className={`font-mono text-lg mb-3 ${
                          adminMode ? "editable-highlight" : ""
                        }`}
                        style={{ color: theme.primaryColor }}
                        onClick={() =>
                          openEdit(
                            "heroGreeting",
                            data.heroGreeting,
                            "text",
                            "Greeting"
                          )
                        }
                      >
                        {data.heroGreeting}
                      </p>
                      <h1
                        className={`text-5xl lg:text-7xl font-extrabold text-white mb-4 leading-tight ${
                          adminMode ? "editable-highlight" : ""
                        }`}
                        onClick={() =>
                          openEdit("name", data.name, "text", "Name")
                        }
                      >
                        {data.name}
                      </h1>
                      <h2
                        className={`text-2xl lg:text-3xl font-light text-slate-300 mb-3 ${
                          adminMode ? "editable-highlight" : ""
                        }`}
                        onClick={() =>
                          openEdit("role", data.role, "text", "Role")
                        }
                      >
                        {data.role}
                      </h2>
                      <p
                        className={`shimmer-text text-xl font-semibold mb-6 ${
                          adminMode ? "editable-highlight" : ""
                        }`}
                        onClick={() =>
                          openEdit("tagline", data.tagline, "textarea", "Tagline")
                        }
                      >
                        {data.tagline}
                      </p>
                      <p
                        className={`text-slate-400 max-w-xl mb-10 leading-relaxed text-lg ${
                          adminMode ? "editable-highlight" : ""
                        }`}
                        onClick={() =>
                          openEdit(
                            "summary",
                            data.summary,
                            "textarea",
                            "Summary"
                          )
                        }
                      >
                        <span
                          dangerouslySetInnerHTML={{ __html: data.summary }}
                        ></span>
                      </p>

                      <div className="flex gap-5 flex-wrap mb-8">
                        <a
                          href="#contact"
                          className="magnetic-btn px-10 py-4 text-white rounded-2xl font-bold shadow-glow transition-all hover:scale-105 text-lg"
                          style={{
                            background: `linear-gradient(135deg, ${theme.primaryColor}, ${theme.secondaryColor})`,
                          }}
                        >
                          Contact Me ✨
                        </a>
                        {data.cvUrl ? (
                          <a
                            href={data.cvUrl}
                            download={data.cvFileName}
                            className="magnetic-btn px-10 py-4 glass hover:bg-slate-800 text-white rounded-2xl font-bold transition-all text-lg"
                          >
                            📄 Download CV
                          </a>
                        ) : (
                          <button
                            onClick={() => adminMode && setCvModal(true)}
                            className="magnetic-btn px-10 py-4 glass hover:bg-slate-800 text-white rounded-2xl font-bold transition-all text-lg"
                          >
                            {adminMode ? "📤 Upload CV" : "📄 Download CV"}
                          </button>
                        )}
                      </div>

                      <div className="flex gap-4">
                        {data.socialLinks?.map((link) => (
                          <a
                            key={link.id}
                            href={link.url}
                            target="_blank"
                            className="social-link"
                            title={link.label}
                          >
                            <i
                              className={link.icon}
                              style={{ color: link.color || "white" }}
                            ></i>
                          </a>
                        ))}
                      </div>
                    </div>

                    <div data-aos="zoom-in" className="flex justify-center">
                      <div
                        className="profile-image-container relative w-80 h-80 rounded-full float-animation"
                        style={{
                          boxShadow: `0 0 60px ${theme.primaryColor}40`,
                        }}
                      >
                        <div
                          className="absolute inset-0 rounded-full"
                          style={{
                            background: `linear-gradient(135deg, ${theme.primaryColor}40, ${theme.secondaryColor}40)`,
                            padding: "4px",
                          }}
                        >
                          <img
                            src={
                              data.profileImage ||
                              `https://ui-avatars.com/api/?name=${
                                data.name?.replace(" ", "+") || "User"
                              }&background=0f172a&color=06b6d4&size=500`
                            }
                            alt=""
                            className="w-full h-full object-cover rounded-full hover-pop"
                            onClick={() => setLightboxSrc(data.profileImage)}
                          />
                        </div>
                        {adminMode && (
                          <div className="profile-overlay">
                            <button
                              onClick={() => setProfileModal(true)}
                              className="px-6 py-3 rounded-xl font-bold mb-2"
                              style={{
                                background: `linear-gradient(135deg, ${theme.primaryColor}, ${theme.secondaryColor})`,
                              }}
                            >
                              📷 Change
                            </button>
                            <button
                              onClick={() =>
                                setImageTools({
                                  open: true,
                                  src: data.profileImage,
                                })
                              }
                              className="text-sm hover:underline"
                            >
                              🛠️ Adjust
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </section>

                {/* Experience */}
                <section id="experience" className="py-24">
                  <div className="container mx-auto px-6 max-w-5xl">
                    <h2
                      className={`text-4xl lg:text-5xl font-bold text-center mb-4 text-glow ${
                        adminMode ? "editable-highlight" : ""
                      }`}
                      onClick={() =>
                        openEdit(
                          "sectionHeaders.experience",
                          data.sectionHeaders?.experience,
                          "text",
                          "Header"
                        )
                      }
                    >
                      {data.sectionHeaders?.experience}
                    </h2>
                    <p
                      className={`text-slate-400 text-center mb-16 text-lg ${
                        adminMode ? "editable-highlight" : ""
                      }`}
                      onClick={() =>
                        openEdit(
                          "sectionHeaders.experienceSubtitle",
                          data.sectionHeaders?.experienceSubtitle,
                          "text",
                          "Subtitle"
                        )
                      }
                    >
                      {data.sectionHeaders?.experienceSubtitle}
                    </p>

                    <div className="space-y-8">
                      {data.experience?.map((job, idx) => (
                        <div
                          key={job.id}
                          className={`glass p-8 rounded-3xl transition-all hover:shadow-glow-hover relative group`}
                          data-aos="fade-up"
                          data-aos-delay={idx * 100}
                        >
                          {/* UPDATED: MOVE BUTTONS */}
                          {adminMode && (
                            <div className="absolute top-2 right-2 flex gap-1 z-20">
                               <button onClick={() => moveItem("experience", idx, "up")} className="w-8 h-8 bg-slate-700 text-white rounded-full flex items-center justify-center hover:bg-slate-600 shadow-lg">↑</button>
                               <button onClick={() => moveItem("experience", idx, "down")} className="w-8 h-8 bg-slate-700 text-white rounded-full flex items-center justify-center hover:bg-slate-600 shadow-lg">↓</button>
                               <button className="w-8 h-8 bg-red-600 text-white rounded-full flex items-center justify-center hover:bg-red-700 shadow-lg" onClick={() => deleteItem("experience", job.id)}>×</button>
                            </div>
                          )}

                          <div className="flex flex-col lg:flex-row justify-between gap-4 mb-4">
                            <div>
                              <h3
                                className={`text-2xl font-bold text-white ${
                                  adminMode ? "editable-highlight" : ""
                                }`}
                                onClick={() =>
                                  openEdit(
                                    `experience.${idx}.role`,
                                    job.role,
                                    "text",
                                    "Role"
                                  )
                                }
                              >
                                {job.role}
                              </h3>
                              <p
                                className={`font-medium ${
                                  adminMode ? "editable-highlight" : ""
                                }`}
                                style={{ color: theme.primaryColor }}
                                onClick={() =>
                                  openEdit(
                                    `experience.${idx}.company`,
                                    job.company,
                                    "text",
                                    "Company"
                                  )
                                }
                              >
                                {job.company}{" "}
                                {job.location && `• ${job.location}`}
                              </p>
                            </div>
                            <span
                              className={`text-slate-400 text-sm bg-slate-800/70 px-4 py-2 rounded-full h-fit ${
                                adminMode ? "editable-highlight" : ""
                              }`}
                              onClick={() =>
                                openEdit(
                                  `experience.${idx}.period`,
                                  job.period,
                                  "text",
                                  "Period"
                                )
                              }
                            >
                              {job.period}
                            </span>
                          </div>

                          <p
                            className={`text-slate-300 leading-relaxed mb-4 ${
                              adminMode ? "editable-highlight" : ""
                            }`}
                            onClick={() =>
                              openEdit(
                                `experience.${idx}.desc`,
                                job.desc,
                                "textarea",
                                "Description"
                              )
                            }
                          >
                            <span
                              dangerouslySetInnerHTML={{ __html: job.desc }}
                            ></span>
                          </p>

                          {job.highlights?.length > 0 && (
                            <div
                              className={`flex flex-wrap gap-2 mb-4 ${adminMode ? "editable-highlight" : ""}`}
                              onClick={() => adminMode && openEdit(
                                `experience.${idx}.highlights`,
                                job.highlights?.join(", "),
                                "text",
                                "Highlights (comma separated)",
                                true
                              )}
                            >
                              {job.highlights.map((h, i) => (
                                <span key={i} className="skill-tag text-xs px-3 py-1 rounded-full">{h}</span>
                              ))}
                            </div>
                          )}

                          <div className="mt-6 pt-4 border-t border-slate-700/50">
                            {galleryView.open &&
                            galleryView.experienceId === job.id ? (
                              <div className="animate-fade-in">
                                <div className="flex justify-between items-center mb-4">
                                  <h4 className="font-bold text-sm text-slate-300">
                                    Project Highlights
                                  </h4>
                                  <div className="flex gap-2">
                                    {adminMode && (
                                      <button
                                        onClick={() =>
                                          setMediaManager({
                                            open: true,
                                            targetId: job.id,
                                            targetType: "experience",
                                            type: "images",
                                          })
                                        }
                                        className="text-xs px-3 py-1 rounded bg-blue-600/30 text-blue-300 hover:bg-blue-600/50"
                                      >
                                        + Manage
                                      </button>
                                    )}
                                    <button
                                      onClick={() =>
                                        setGalleryView({
                                          open: false,
                                          experienceId: null,
                                        })
                                      }
                                      className="text-xs text-slate-400 hover:text-white"
                                    >
                                      Close
                                    </button>
                                  </div>
                                </div>

                                {job.gallery && job.gallery.length > 0 ? (
                                  <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                    {job.gallery.map((img, i) => (
                                      <div
                                        key={i}
                                        className="relative aspect-video rounded-lg overflow-hidden border border-slate-700 group/img"
                                      >
                                        <img
                                          src={img}
                                          alt=""
                                          className="w-full h-full object-cover transition-transform duration-500 group-hover/img:scale-110 cursor-pointer"
                                          onClick={() => setLightboxSrc(img)}
                                        />
                                      </div>
                                    ))}
                                  </div>
                                ) : (
                                  <p className="text-sm text-slate-500 italic text-center py-4">
                                    No gallery images added yet.
                                  </p>
                                )}
                              </div>
                            ) : (
                              <button
                                onClick={() =>
                                  setGalleryView({
                                    open: true,
                                    experienceId: job.id,
                                  })
                                }
                                className="text-sm font-semibold flex items-center gap-2 hover:gap-3 transition-all"
                                style={{ color: theme.primaryColor }}
                              >
                                View More{" "}
                                {job.gallery?.length > 0 &&
                                  `(${job.gallery.length})`}{" "}
                                <span>→</span>
                              </button>
                            )}
                          </div>
                        </div>
                      ))}

                      {adminMode && (
                        <button
                          onClick={() =>
                            setAddModal({ open: true, type: "experience" })
                          }
                          className="add-btn w-full"
                        >
                          ➕ Add Experience
                        </button>
                      )}
                    </div>
                  </div>
                </section>

                {/* --- NEW SECTION: EDUCATION (Enhanced) --- */}
                <section id="education" className="py-20 bg-slate-900/30">
                  <div className="container mx-auto px-6 max-w-5xl">
                    <h2
                      className={`text-4xl lg:text-5xl font-bold text-center mb-4 text-glow ${
                        adminMode ? "editable-highlight" : ""
                      }`}
                      onClick={() =>
                        openEdit(
                          "sectionHeaders.education",
                          data.sectionHeaders?.education,
                          "text",
                          "Header"
                        )
                      }
                    >
                      {data.sectionHeaders?.education}
                    </h2>
                    <p
                      className={`text-slate-400 text-center mb-16 text-lg ${
                        adminMode ? "editable-highlight" : ""
                      }`}
                      onClick={() =>
                        openEdit(
                          "sectionHeaders.educationSubtitle",
                          data.sectionHeaders?.educationSubtitle,
                          "text",
                          "Subtitle"
                        )
                      }
                    >
                      {data.sectionHeaders?.educationSubtitle}
                    </p>

                    <div className="space-y-8">
                      {data.education?.map((edu, idx) => (
                        <div
                          key={edu.id}
                          className={`glass p-8 rounded-3xl transition-all hover:shadow-glow-hover relative group`}
                          data-aos="fade-up"
                        >
                          {adminMode && (
                            <div className="absolute top-2 right-2 flex gap-1 z-20">
                               <button onClick={() => moveItem("education", idx, "up")} className="w-8 h-8 bg-slate-700 text-white rounded-full flex items-center justify-center hover:bg-slate-600 shadow-lg">↑</button>
                               <button onClick={() => moveItem("education", idx, "down")} className="w-8 h-8 bg-slate-700 text-white rounded-full flex items-center justify-center hover:bg-slate-600 shadow-lg">↓</button>
                               <button className="w-8 h-8 bg-red-600 text-white rounded-full flex items-center justify-center hover:bg-red-700 shadow-lg" onClick={() => deleteItem("education", edu.id)}>×</button>
                            </div>
                          )}

                          <div className="flex flex-col lg:flex-row justify-between gap-4 mb-4">
                            <div>
                              <div className="flex items-center gap-3">
                                <span className="text-3xl">🎓</span>
                                <h3
                                  className={`text-2xl font-bold text-white ${
                                    adminMode ? "editable-highlight" : ""
                                  }`}
                                  onClick={() =>
                                    openEdit(
                                      `education.${idx}.role`,
                                      edu.role,
                                      "text",
                                      "Degree"
                                    )
                                  }
                                >
                                  {edu.role}
                                </h3>
                              </div>
                              <p
                                className={`font-medium mt-1 ${
                                  adminMode ? "editable-highlight" : ""
                                }`}
                                style={{ color: theme.primaryColor }}
                                onClick={() =>
                                  openEdit(
                                    `education.${idx}.company`,
                                    edu.company,
                                    "text",
                                    "University"
                                  )
                                }
                              >
                                {edu.company}{" "}
                                {edu.location && `• ${edu.location}`}
                              </p>
                            </div>
                            <span
                              className={`text-slate-400 text-sm bg-slate-800/70 px-4 py-2 rounded-full h-fit ${
                                adminMode ? "editable-highlight" : ""
                              }`}
                              onClick={() =>
                                openEdit(
                                  `education.${idx}.period`,
                                  edu.period,
                                  "text",
                                  "Period"
                                )
                              }
                            >
                              {edu.period}
                            </span>
                          </div>

                          <div className="mt-6 pt-4 border-t border-slate-700/50">
                            {eduView.open && eduView.id === edu.id ? (
                              <div className="animate-fade-in">
                                {/* Description with Editor */}
                                <div className="mb-6">
                                  <h4 className="font-bold text-sm text-slate-300 mb-2">Description / Highlights</h4>
                                  <div
                                    className={`text-slate-300 leading-relaxed ${adminMode ? "editable-highlight" : ""}`}
                                    onClick={() => openEdit(`education.${idx}.desc`, edu.desc, "textarea", "Description")}
                                    dangerouslySetInnerHTML={{ __html: edu.desc }}
                                  ></div>
                                </div>

                                {/* Images */}
                                <div className="flex justify-between items-center mb-2">
                                  <h4 className="font-bold text-sm text-slate-300">Images (Thesis/Awards)</h4>
                                  {adminMode && (
                                    <button onClick={() => setMediaManager({ open: true, targetId: edu.id, targetType: "education", type: "images" })} className="text-xs px-3 py-1 rounded bg-blue-600/30 text-blue-300 hover:bg-blue-600/50">
                                      + Add Image
                                    </button>
                                  )}
                                </div>
                                {edu.gallery && edu.gallery.length > 0 ? (
                                  <div className="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6">
                                    {edu.gallery.map((img, i) => (
                                      <img key={i} src={img} alt="" className="w-full h-24 object-cover rounded-lg cursor-pointer hover:opacity-80" onClick={() => setLightboxSrc(img)} />
                                    ))}
                                  </div>
                                ) : (
                                  <p className="text-xs text-slate-500 italic mb-6">No images.</p>
                                )}

                                {/* PDFs */}
                                <div className="flex justify-between items-center mb-2">
                                  <h4 className="font-bold text-sm text-slate-300">Documents (Transcripts/Certs)</h4>
                                  {adminMode && (
                                    <button onClick={() => setMediaManager({ open: true, targetId: edu.id, targetType: "education", type: "pdfs" })} className="text-xs px-3 py-1 rounded bg-green-600/30 text-green-300 hover:bg-green-600/50">
                                      + Add PDF
                                    </button>
                                  )}
                                </div>
                                <div className="flex flex-wrap gap-2 mb-4">
                                  {edu.media?.map((pdf, i) => (
                                    <button key={i} onClick={() => handlePdfAccess(adminMode, pdf.url, pdf.name)} className="flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs">
                                      <span>📄 {pdf.name}</span> {!adminMode && "🔒"}
                                    </button>
                                  ))}
                                </div>

                                <button onClick={() => setEduView({ open: false, id: null })} className="text-xs text-slate-400 hover:text-white mt-2 underline">
                                  Show Less
                                </button>
                              </div>
                            ) : (
                              <button
                                onClick={() => setEduView({ open: true, id: edu.id })}
                                className="text-sm font-semibold flex items-center gap-2 hover:gap-3 transition-all"
                                style={{ color: theme.primaryColor }}
                              >
                                View Details & Media <span>→</span>
                              </button>
                            )}
                          </div>
                        </div>
                      ))}

                      {adminMode && (
                        <button
                          onClick={() =>
                            setAddModal({ open: true, type: "education" })
                          }
                          className="add-btn w-full"
                        >
                          ➕ Add Education
                        </button>
                      )}
                    </div>
                  </div>
                </section>
                
                {/* --- NEW SECTION: INTERNSHIPS --- */}
                <section id="internships" className="py-20">
                  <div className="container mx-auto px-6 max-w-5xl">
                    <h2
                      className={`text-4xl lg:text-5xl font-bold text-center mb-12 text-glow ${adminMode ? "editable-highlight" : ""
                        }`}
                      onClick={() =>
                        openEdit("sectionHeaders.internships", "Internships", "text", "Header")
                      }
                    >
                      Internships
                    </h2>

                    <div className="space-y-8">
                      {data.internships?.map((intern, idx) => (
                        <div
                          key={intern.id}
                          className={`glass p-8 rounded-3xl transition-all hover:shadow-glow-hover relative group`}
                          data-aos="fade-up"
                        >
                          {adminMode && (
                            <div className="absolute top-2 right-2 flex gap-1 z-20">
                              <button onClick={() => moveItem("internships", idx, "up")} className="w-8 h-8 bg-slate-700 text-white rounded-full flex items-center justify-center hover:bg-slate-600 shadow-lg">↑</button>
                              <button onClick={() => moveItem("internships", idx, "down")} className="w-8 h-8 bg-slate-700 text-white rounded-full flex items-center justify-center hover:bg-slate-600 shadow-lg">↓</button>
                              <button className="w-8 h-8 bg-red-600 text-white rounded-full flex items-center justify-center hover:bg-red-700 shadow-lg" onClick={() => deleteItem("internships", intern.id)}>×</button>
                            </div>
                          )}

                          <div className="flex flex-col lg:flex-row justify-between gap-4 mb-4">
                            <div>
                              <h3
                                className={`text-2xl font-bold text-white ${adminMode ? "editable-highlight" : ""
                                  }`}
                                onClick={() =>
                                  openEdit(`internships.${idx}.role`, intern.role, "text", "Role")
                                }
                              >
                                {intern.role}
                              </h3>
                              <p
                                className={`font-medium mt-1 ${adminMode ? "editable-highlight" : ""
                                  }`}
                                style={{ color: theme.primaryColor }}
                                onClick={() =>
                                  openEdit(`internships.${idx}.org`, intern.org, "text", "Organization")
                                }
                              >
                                {intern.org}
                              </p>
                            </div>
                            <span
                              className={`text-slate-400 text-sm bg-slate-800/70 px-4 py-2 rounded-full h-fit ${adminMode ? "editable-highlight" : ""
                                }`}
                              onClick={() =>
                                openEdit(`internships.${idx}.duration`, intern.duration, "text", "Duration")
                              }
                            >
                              {intern.duration}
                            </span>
                          </div>

                          <div className="mt-4 pt-4 border-t border-slate-700/50">
                            {internView.open && internView.id === intern.id ? (
                              <div className="animate-fade-in">
                                {/* Description with Editor */}
                                <div className="mb-6">
                                  <h4 className="font-bold text-sm text-slate-300 mb-2">Work Description</h4>
                                  <div
                                    className={`text-slate-300 leading-relaxed ${adminMode ? "editable-highlight" : ""}`}
                                    onClick={() => openEdit(`internships.${idx}.desc`, intern.desc, "textarea", "Description")}
                                    dangerouslySetInnerHTML={{ __html: intern.desc }}
                                  ></div>
                                </div>

                                {/* Images */}
                                <div className="flex justify-between items-center mb-2">
                                  <h4 className="font-bold text-sm text-slate-300">Images</h4>
                                  {adminMode && (
                                    <button onClick={() => setMediaManager({ open: true, targetId: intern.id, targetType: "internships", type: "images" })} className="text-xs px-3 py-1 rounded bg-blue-600/30 text-blue-300 hover:bg-blue-600/50">
                                      + Add Image
                                    </button>
                                  )}
                                </div>
                                {intern.gallery && intern.gallery.length > 0 ? (
                                  <div className="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6">
                                    {intern.gallery.map((img, i) => (
                                      <img key={i} src={img} alt="" className="w-full h-24 object-cover rounded-lg cursor-pointer hover:opacity-80" onClick={() => setLightboxSrc(img)} />
                                    ))}
                                  </div>
                                ) : (
                                  <p className="text-xs text-slate-500 italic mb-6">No images.</p>
                                )}

                                {/* PDFs (Reports) */}
                                <div className="flex justify-between items-center mb-2">
                                  <h4 className="font-bold text-sm text-slate-300">Reports / Documents</h4>
                                  {adminMode && (
                                    <button onClick={() => setMediaManager({ open: true, targetId: intern.id, targetType: "internships", type: "pdfs" })} className="text-xs px-3 py-1 rounded bg-green-600/30 text-green-300 hover:bg-green-600/50">
                                      + Add Report
                                    </button>
                                  )}
                                </div>
                                <div className="flex flex-wrap gap-2 mb-4">
                                  {intern.media?.map((pdf, i) => (
                                    <button key={i} onClick={() => handlePdfAccess(adminMode, pdf.url, pdf.name)} className="flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs">
                                      <span>📄 {pdf.name}</span> {!adminMode && "🔒"}
                                    </button>
                                  ))}
                                  {(!intern.media || intern.media.length === 0) && <p className="text-xs text-slate-500">No reports attached.</p>}
                                </div>

                                <button onClick={() => setInternView({ open: false, id: null })} className="text-xs text-slate-400 hover:text-white mt-2 underline">
                                  Show Less
                                </button>
                              </div>
                            ) : (
                              <button
                                onClick={() => setInternView({ open: true, id: intern.id })}
                                className="text-sm font-semibold flex items-center gap-2 hover:gap-3 transition-all"
                                style={{ color: theme.primaryColor }}
                              >
                                View Details & Reports <span>→</span>
                              </button>
                            )}
                          </div>
                        </div>
                      ))}

                      {adminMode && (
                        <button
                          onClick={() => setAddModal({ open: true, type: "internships" })}
                          className="add-btn w-full"
                        >
                          ➕ Add Internship
                        </button>
                      )}
                    </div>
                  </div>
                </section>
                
                {/* Skills */}
                {/* Skills Section (Compact Rectangles) */}
                <section id="skills" className="py-24 bg-slate-900/50">
                  <div className="container mx-auto px-6">
                    <h2
                      className={`text-4xl lg:text-5xl font-bold text-center mb-4 text-glow ${adminMode ? "editable-highlight" : ""
                        }`}
                      onClick={() =>
                        openEdit(
                          "sectionHeaders.skills",
                          data.sectionHeaders?.skills,
                          "text",
                          "Header"
                        )
                      }
                    >
                      {data.sectionHeaders?.skills}
                    </h2>
                    <p
                      className={`text-slate-400 text-center mb-16 text-lg ${adminMode ? "editable-highlight" : ""
                        }`}
                      onClick={() =>
                        openEdit(
                          "sectionHeaders.skillsSubtitle",
                          data.sectionHeaders?.skillsSubtitle,
                          "text",
                          "Subtitle"
                        )
                      }
                    >
                      {data.sectionHeaders?.skillsSubtitle}
                    </p>

                    <div className="flex flex-wrap justify-center items-start gap-4 max-w-6xl mx-auto">
                      {data.skills?.map((skill, idx) => (
                        <div
                          key={idx}
                          className="skill-card-3d"
                          data-aos="fade-up"
                          data-aos-delay={idx * 30}
                          onClick={(e) => {
                            // Only flip if NOT clicking an admin button
                            if (!e.target.closest('button')) {
                              e.currentTarget.classList.toggle('flipped');
                            }
                          }}
                        >
                          <div className="skill-inner">
                            {/* --- FRONT FACE --- */}
                            <div className="skill-front">
                              {/* Use px-4 to ensure text doesn't hit edges */}
                              <span className="px-2">{skill.name}</span>

                              {adminMode && (
                                <>
                                  <button
                                    className="delete-btn-card"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      deleteSkill(idx);
                                    }}
                                  >×</button>

                                  <button
                                    className="card-edit-btn"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      openEdit(`skills.${idx}.name`, skill.name, "text", "Skill Name");
                                    }}
                                  >
                                    ✎ Edit
                                  </button>
                                </>
                              )}
                            </div>

                            {/* --- BACK FACE --- */}
                            <div className="skill-back">
                              <div className="" dangerouslySetInnerHTML={{ __html: skill.back || "No description." }} />

                              {adminMode && (
                                <button
                                  className="card-edit-btn"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    openEdit(`skills.${idx}.back`, skill.back, "textarea", "Description");
                                  }}
                                >
                                  ✎ Edit
                                </button>
                              )}
                            </div>
                          </div>
                        </div>
                      ))}

                      {/* Add Skill Button (Rectangular Style) */}
                      {adminMode && (
                        <button
                          onClick={() => setAddSkillModal(true)}
                          className="skill-card-3d border-2 border-dashed border-slate-600 hover:border-cyan-500 text-slate-500 hover:text-cyan-400 transition-colors flex items-center justify-center bg-transparent"
                          style={{ minWidth: '140px', height: '90px' }}
                        >
                          <span className="font-bold text-sm">+ Add Skill</span>
                        </button>
                      )}
                    </div>
                  </div>
                </section>

                {/* Projects */}
                <section id="projects" className="py-24">
                  <div className="container mx-auto px-6">
                    <h2
                      className={`text-4xl lg:text-5xl font-bold text-center mb-4 text-glow ${
                        adminMode ? "editable-highlight" : ""
                      }`}
                      onClick={() =>
                        openEdit(
                          "sectionHeaders.projects",
                          data.sectionHeaders?.projects,
                          "text",
                          "Header"
                        )
                      }
                    >
                      {data.sectionHeaders?.projects}
                    </h2>
                    <p
                      className={`text-slate-400 text-center mb-16 text-lg max-w-2xl mx-auto ${adminMode ? "editable-highlight" : ""
                        }`}
                      onClick={() =>
                        openEdit(
                          "sectionHeaders.projectsSubtitle",
                          data.sectionHeaders?.projectsSubtitle,
                          "textarea",
                          "Subtitle"
                        )
                      }
                      dangerouslySetInnerHTML={{ __html: data.sectionHeaders?.projectsSubtitle }}
                    ></p>

                    <div className="projects-grid max-w-7xl mx-auto">
                      {data.projects
                        ?.slice(0, visibleProjects)
                        .map((project, idx) => (
                          <ProjectCard
                            key={project.id}
                            project={project}
                            onClick={() => setSelectedProject(project)}
                            isAdmin={adminMode}
                            theme={theme}
                            onManageImages={() =>
                              setMediaManager({
                                open: true,
                                targetId: project.id,
                                targetType: "project",
                                type: "images",
                              })
                            }
                            onDelete={() => deleteItem("project", project.id)}
                            onImageClick={setLightboxSrc}
                            onMoveUp={() => moveItem("projects", idx, "up")}
                            onMoveDown={() => moveItem("projects", idx, "down")}
                            onLike={handleLike}  /* <--- MAKE SURE THIS IS HERE */
                          />
                        ))}
                    </div>

                    {adminMode && (
                      <div className="max-w-7xl mx-auto mt-8">
                        <button
                          onClick={() =>
                            setAddModal({ open: true, type: "project" })
                          }
                          className="add-btn w-full"
                        >
                          ➕ Add Project
                        </button>
                      </div>
                    )}

                    {visibleProjects < (data.projects?.length || 0) && (
                      <div className="text-center mt-12">
                        <button
                          onClick={() => setVisibleProjects((p) => p + 6)}
                          className="px-10 py-4 rounded-2xl font-bold transition-all hover:scale-105"
                          style={{
                            background: `${theme.primaryColor}20`,
                            color: theme.primaryColor,
                            border: `2px solid ${theme.primaryColor}50`,
                          }}
                        >
                          Load More (
                          {(data.projects?.length || 0) - visibleProjects} more)
                        </button>
                      </div>
                    )}
                  </div>
                </section>

                {/* --- UPGRADED SECTION: PUBLICATIONS --- */}
                <section id="publications" className="py-20 bg-slate-900/30">
                  <div className="container mx-auto px-6 max-w-6xl">
                    <h2
                      className={`text-3xl font-bold text-center mb-12 text-gradient ${adminMode ? "editable-highlight" : ""}`}
                      onClick={() => openEdit("sectionHeaders.publications", data.sectionHeaders?.publications, "text", "Header")}
                    >
                      {data.sectionHeaders?.publications || "Publications"}
                    </h2>

                    <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                      {data.publications?.map((pub, idx) => (
                        <div key={pub.id} className="glass p-6 rounded-2xl flex flex-col relative group hover:-translate-y-1 transition-transform duration-300">
                          {adminMode && (
                            <button className="delete-btn" onClick={() => deleteItem("publications", pub.id)}>×</button>
                          )}

                          {/* Book/Paper Icon */}
                          <div className="mb-4 text-4xl text-cyan-400">
                            📖
                          </div>

                          <h3
                            className={`text-xl font-bold text-white mb-2 leading-tight ${adminMode ? "editable-highlight" : ""}`}
                            onClick={() => openEdit(`publications.${idx}.title`, pub.title, "text", "Title")}
                          >
                            {pub.title}
                          </h3>

                          <p
                            className={`text-slate-400 text-sm mb-4 italic ${adminMode ? "editable-highlight" : ""}`}
                            onClick={() => openEdit(`publications.${idx}.authors`, pub.authors, "text", "Authors")}
                          >
                            {pub.authors || "Authors..."}
                          </p>
                          {/* Abstract */}
                          <div className={`text-sm text-slate-400 mb-2 italic ${adminMode ? "editable-highlight" : ""}`}
                            onClick={() => adminMode && openEdit(`publications.${idx}.abstract`, pub.abstract, "textarea", "Abstract")}>
                            <span dangerouslySetInnerHTML={{ __html: pub.abstract || (adminMode ? "Add abstract..." : "") }}></span>
                          </div>

                          {/* Description */}
                          <div className={`text-sm text-slate-300 mb-4 ${adminMode ? "editable-highlight" : ""}`}
                            onClick={() => adminMode && openEdit(`publications.${idx}.desc`, pub.desc, "textarea", "Description")}>
                            <span dangerouslySetInnerHTML={{ __html: pub.desc || (adminMode ? "Add description..." : "") }}></span>
                          </div>

                          <div className="mt-auto pt-4 border-t border-slate-700/50">
                            <div className="flex justify-between items-center text-sm mb-3">
                              <span className={adminMode ? "editable-highlight" : ""} onClick={() => openEdit(`publications.${idx}.conference`, pub.conference, "text", "Conference")}>
                                {pub.conference || "Conference/Journal"}
                              </span>
                              <span className={`text-slate-500 ${adminMode ? "editable-highlight" : ""}`} onClick={() => openEdit(`publications.${idx}.year`, pub.year, "text", "Year")}>
                                {pub.year}
                              </span>
                            </div>

                            <div className="flex flex-wrap gap-2">
                              {pub.url && (
                                <a href={pub.url} target="_blank" className="flex-1 text-center py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold transition">
                                  Read Online 🔗
                                </a>
                              )}

                              {/* PDF Attachments */}
                              {pub.media?.map((m, i) => (
                                <button
                                  key={i}
                                  onClick={() => handlePdfAccess(adminMode, m.url, m.name)}
                                  className="flex-1 text-center py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold transition"
                                >
                                  📄 PDF {!adminMode && "🔒"}
                                </button>
                              ))}

                              {adminMode && (
                                <button
                                  onClick={() => setMediaManager({ open: true, targetId: pub.id, targetType: "publications", type: "pdfs" })}
                                  className="px-3 py-2 bg-slate-800 border border-dashed border-slate-600 rounded-lg text-xs text-green-400 hover:text-green-300"
                                >
                                  + Attach
                                </button>
                              )}
                            </div>
                          </div>
                        </div>
                      ))}

                      {adminMode && (
                        <button onClick={() => setAddModal({ open: true, type: "publications" })} className="add-btn flex-col items-center justify-center min-h-[200px]">
                          <span className="text-3xl mb-2">➕</span>
                          <span>Add Publication</span>
                        </button>
                      )}
                    </div>
                  </div>
                </section>
                
                {/* --- UPGRADED SECTION: CERTIFICATIONS --- */}
                <section id="certifications" className="py-20">
                  <div className="container mx-auto px-6 max-w-6xl">
                    <h2
                      className={`text-3xl font-bold text-center mb-12 text-gradient ${adminMode ? "editable-highlight" : ""}`}
                      onClick={() => openEdit("sectionHeaders.certifications", data.sectionHeaders?.certifications, "text", "Header")}
                    >
                      {data.sectionHeaders?.certifications || "Certifications & Trainings"}
                    </h2>

                    <div className="grid md:grid-cols-2 gap-6">
                      {data.certifications?.map((cert, idx) => (
                        <div key={cert.id} className="glass p-6 rounded-2xl relative group hover:border-cyan-500/30 transition-all">
                          {adminMode && (
                            <div className="absolute top-2 right-2 flex gap-1 z-20">
                               <button onClick={() => moveItem("certifications", idx, "up")} className="w-8 h-8 bg-slate-700 text-white rounded-md hover:bg-slate-600 flex items-center justify-center">↑</button>
                               <button onClick={() => moveItem("certifications", idx, "down")} className="w-8 h-8 bg-slate-700 text-white rounded-md hover:bg-slate-600 flex items-center justify-center">↓</button>
                               <button className="w-8 h-8 bg-red-600 text-white rounded-md hover:bg-red-700 flex items-center justify-center" onClick={() => deleteItem("certifications", cert.id)}>×</button>
                            </div>
                          )}

                          <div className="flex items-start gap-4">
                            {/* Icon Placeholder */}
                            <div className="w-16 h-16 rounded-lg bg-slate-800 flex-shrink-0 flex items-center justify-center text-3xl overflow-hidden">
                              {cert.media && cert.media[0] && cert.media[0].url.includes('image') ? (
                                <img src={cert.media[0].url} className="w-full h-full object-cover" />
                              ) : "📜"}
                            </div>

                            <div className="flex-1 min-w-0">
                              <h3
                                className={`text-lg font-bold text-white truncate ${adminMode ? "editable-highlight" : ""}`}
                                onClick={() => openEdit(`certifications.${idx}.name`, cert.name, "text", "Name")}
                              >
                                {cert.name}
                              </h3>
                              <p
                                className={`text-cyan-400 text-sm mb-1 ${adminMode ? "editable-highlight" : ""}`}
                                onClick={() => openEdit(`certifications.${idx}.org`, cert.org, "text", "Organization")}
                              >
                                {cert.org}
                              </p>
                              <div className="flex justify-between items-center mb-3">
                                <span
                                  className={`text-slate-500 text-xs ${adminMode ? "editable-highlight" : ""}`}
                                  onClick={() => openEdit(`certifications.${idx}.year`, cert.year, "text", "Year")}
                                >
                                  {cert.year}
                                </span>
                                {/* Verification Link */}
                                {cert.url ? (
                                  <a href={cert.url} target="_blank" className="text-xs border border-cyan-500/30 text-cyan-400 px-2 py-1 rounded hover:bg-cyan-500/10">
                                    Verify Credential ↗
                                  </a>
                                ) : adminMode ? (
                                  <span className="text-xs text-slate-600 cursor-pointer" onClick={() => openEdit(`certifications.${idx}.url`, "", "text", "Add Verification URL")}>+ Add Link</span>
                                ) : null}
                              </div>

                              {/* Description with Editor enabled */}
                              <div
                                className={`text-slate-300 text-sm mb-4 line-clamp-3 ${adminMode ? "editable-highlight" : ""}`}
                                onClick={() => openEdit(`certifications.${idx}.desc`, cert.desc, "textarea", "Description")}
                                dangerouslySetInnerHTML={{ __html: cert.desc || "Add description..." }}
                              ></div>

                              {/* Attachments */}
                              <div className="flex flex-wrap gap-2 mt-auto">
                                {cert.media?.map((m, i) => (
                                  <button
                                    key={i}
                                    onClick={() => handlePdfAccess(adminMode, m.url, m.name)}
                                    className="px-3 py-1 bg-slate-800 rounded-md text-xs hover:bg-slate-700 flex items-center gap-1 border border-slate-700"
                                  >
                                    {m.url.includes('pdf') ? '📄' : '🖼️'} {m.name} {!adminMode && "🔒"}
                                  </button>
                                ))}
                                {adminMode && (
                                  <button
                                    onClick={() => setMediaManager({ open: true, targetId: cert.id, targetType: "certifications", type: "pdfs" })}
                                    className="px-2 py-1 bg-slate-800 rounded text-xs text-green-400"
                                  >
                                    + Attach PDF/Img
                                  </button>
                                )}
                              </div>
                            </div>
                          </div>
                        </div>
                      ))}

                      {adminMode && (
                        <button onClick={() => setAddModal({ open: true, type: "certifications" })} className="add-btn min-h-[150px]">
                          ➕ Add Certification
                        </button>
                      )}
                    </div>
                  </div>
                </section>

                {/* --- NEW SECTION: VOLUNTEER WORK (Updated) --- */}
                <section id="volunteer" className="py-20 bg-slate-900/30">
                  <div className="container mx-auto px-6 max-w-5xl">
                    <h2
                      className={`text-3xl font-bold text-center mb-12 text-gradient ${
                        adminMode ? "editable-highlight" : ""
                      }`}
                      onClick={() =>
                        openEdit(
                          "sectionHeaders.volunteer",
                          data.sectionHeaders?.volunteer,
                          "text",
                          "Header"
                        )
                      }
                    >
                      {data.sectionHeaders?.volunteer || "Volunteer Work"}
                    </h2>
                    <div className="relative border-l-2 border-slate-700 ml-4 md:ml-10 space-y-12 pl-8 md:pl-12">
                      {data.volunteer?.map((vol, idx) => (
                        <div key={vol.id} className="relative group">
                          <span
                            className="absolute -left-[41px] md:-left-[57px] top-0 w-5 h-5 rounded-full border-4 border-slate-900"
                            style={{ background: theme.primaryColor }}
                          ></span>
                          <div className="glass p-6 rounded-2xl relative">
                            {adminMode && (
                              <div className="absolute top-2 right-2 flex gap-1 z-20">
                                 <button onClick={() => moveItem("volunteer", idx, "up")} className="w-8 h-8 bg-slate-700 text-white rounded-md hover:bg-slate-600 flex items-center justify-center">↑</button>
                                 <button onClick={() => moveItem("volunteer", idx, "down")} className="w-8 h-8 bg-slate-700 text-white rounded-md hover:bg-slate-600 flex items-center justify-center">↓</button>
                                 <button className="w-8 h-8 bg-red-600 text-white rounded-md hover:bg-red-700 flex items-center justify-center" onClick={() => deleteItem("volunteer", vol.id)}>×</button>
                              </div>
                            )}
                            <div className="flex flex-col md:flex-row justify-between mb-2">
                              <h3
                                className={`text-xl font-bold text-white ${
                                  adminMode ? "editable-highlight" : ""
                                }`}
                                onClick={() =>
                                  openEdit(
                                    `volunteer.${idx}.event`,
                                    vol.event,
                                    "text",
                                    "Event"
                                  )
                                }
                              >
                                {vol.event}
                              </h3>
                              <span
                                className={`text-slate-400 text-sm font-mono ${
                                  adminMode ? "editable-highlight" : ""
                                }`}
                                onClick={() =>
                                  openEdit(
                                    `volunteer.${idx}.year`,
                                    vol.year,
                                    "text",
                                    "Year"
                                  )
                                }
                              >
                                {vol.year}
                              </span>
                            </div>
                            <p
                              className={`text-cyan-400 font-medium mb-3 ${
                                adminMode ? "editable-highlight" : ""
                              }`}
                              onClick={() =>
                                openEdit(
                                  `volunteer.${idx}.org`,
                                  vol.org,
                                  "text",
                                  "Organization"
                                )
                              }
                            >
                              {vol.org}
                            </p>
                            
                            {/* Description with Editor */}
                            <div
                              className={`text-slate-300 text-sm leading-relaxed mb-4 ${adminMode ? "editable-highlight" : ""}`}
                              onClick={() =>
                                openEdit(
                                  `volunteer.${idx}.desc`,
                                  vol.desc,
                                  "textarea", 
                                  "Description"
                                )
                              }
                              dangerouslySetInnerHTML={{ __html: vol.desc }}
                            ></div>

                            {/* Media */}
                            <div className="mt-4 flex flex-wrap gap-2">
                              {vol.media?.map((m, i) => (
                                <button
                                  key={i}
                                  onClick={() =>
                                    handlePdfAccess(adminMode, m.url, m.name)
                                  }
                                  className="text-xs px-3 py-1 bg-slate-800 rounded-full hover:bg-slate-700 border border-slate-600 flex items-center gap-1"
                                >
                                  🎗️ {m.name} {!adminMode && "🔒"}
                                </button>
                              ))}
                              {adminMode && (
                                <button
                                  onClick={() =>
                                    setMediaManager({
                                      open: true,
                                      targetId: vol.id,
                                      targetType: "volunteer",
                                      type: "pdfs",
                                    })
                                  }
                                  className="text-xs px-2 py-1 bg-slate-800 rounded-full text-green-400"
                                >
                                  +
                                </button>
                              )}
                            </div>
                          </div>
                        </div>
                      ))}
                      {adminMode && (
                        <button
                          onClick={() =>
                            setAddModal({ open: true, type: "volunteer" })
                          }
                          className="add-btn w-full"
                        >
                          ➕ Add Volunteer Work
                        </button>
                      )}
                    </div>
                  </div>
                </section>

                {/* --- NEW SECTION: LICENSES & LANGUAGES --- */}
                <section id="info-grid" className="py-24">
                  <div className="container mx-auto px-6 max-w-7xl grid md:grid-cols-2 gap-12">
                    {/* LICENSES */}
                    <div>
                      <h2
                        className={`text-2xl font-bold mb-8 flex items-center gap-3 ${
                          adminMode ? "editable-highlight" : ""
                        }`}
                        onClick={() =>
                          openEdit(
                            "sectionHeaders.licenses",
                            data.sectionHeaders?.licenses,
                            "text",
                            "Header"
                          )
                        }
                      >
                        <span className="text-3xl">🪪</span>{" "}
                        {data.sectionHeaders?.licenses || "Licenses"}
                      </h2>
                      <div className="space-y-4">
                        {data.licenses?.map((lic, idx) => (
                          <div
                            key={lic.id}
                            className="glass p-4 rounded-xl flex items-center justify-between group relative"
                          >
                            {adminMode && (
                              <div className="absolute top-2 right-2 flex gap-1 z-20">
                                 <button onClick={() => moveItem("licenses", idx, "up")} className="w-5 h-5 bg-slate-700 text-white rounded text-xs flex items-center justify-center">↑</button>
                                 <button onClick={() => moveItem("licenses", idx, "down")} className="w-5 h-5 bg-slate-700 text-white rounded text-xs flex items-center justify-center">↓</button>
                                 <button className="w-5 h-5 bg-red-600 text-white rounded text-xs flex items-center justify-center" onClick={() => deleteItem("licenses", lic.id)}>×</button>
                              </div>
                            )}
                            <div>
                              <h3
                                className={`font-bold text-white ${
                                  adminMode ? "editable-highlight" : ""
                                }`}
                                onClick={() =>
                                  openEdit(
                                    `licenses.${idx}.name`,
                                    lic.name,
                                    "text",
                                    "Name"
                                  )
                                }
                              >
                                {lic.name}
                              </h3>
                              <p
                                className={`text-slate-400 text-sm ${
                                  adminMode ? "editable-highlight" : ""
                                }`}
                                onClick={() =>
                                  openEdit(
                                    `licenses.${idx}.authority`,
                                    lic.authority,
                                    "text",
                                    "Authority"
                                  )
                                }
                              >
                                {lic.authority}
                              </p>
                            </div>
                            <div className="text-right">
                              <p
                                className={`text-cyan-400 font-mono text-sm mb-1 ${
                                  adminMode ? "editable-highlight" : ""
                                }`}
                                onClick={() =>
                                  openEdit(
                                    `licenses.${idx}.year`,
                                    lic.year,
                                    "text",
                                    "Year"
                                  )
                                }
                              >
                                {lic.year}
                              </p>
                              <div className="flex gap-1 justify-end">
                                {lic.media?.map((m, i) => (
                                  <button
                                    key={i}
                                    onClick={() =>
                                      handlePdfAccess(adminMode, m.url, m.name)
                                    }
                                    className="w-6 h-6 bg-slate-800 rounded flex items-center justify-center text-xs hover:bg-cyan-900"
                                    title={m.name}
                                  >
                                    📄
                                  </button>
                                ))}
                                {adminMode && (
                                  <button
                                    onClick={() =>
                                      setMediaManager({
                                        open: true,
                                        targetId: lic.id,
                                        targetType: "licenses",
                                        type: "pdfs",
                                      })
                                    }
                                    className="w-6 h-6 bg-slate-800 rounded text-xs text-green-400"
                                  >
                                    +
                                  </button>
                                )}
                              </div>
                            </div>
                          </div>
                        ))}
                        {adminMode && (
                          <button
                            onClick={() =>
                              setAddModal({ open: true, type: "licenses" })
                            }
                            className="add-btn w-full"
                          >
                            ➕ Add License
                          </button>
                        )}
                      </div>
                    </div>

                    {/* LANGUAGES (Animated Bar) */}
                    <div>
                      <h2
                        className={`text-2xl font-bold mb-8 flex items-center gap-3 ${
                          adminMode ? "editable-highlight" : ""
                        }`}
                        onClick={() =>
                          openEdit(
                            "sectionHeaders.languages",
                            data.sectionHeaders?.languages,
                            "text",
                            "Header"
                          )
                        }
                      >
                        <span className="text-3xl">🗣️</span>{" "}
                        {data.sectionHeaders?.languages || "Languages"}
                      </h2>
                      <div className="space-y-6">
                        {data.languages?.map((lang, idx) => (
                          <div
                            key={lang.id}
                            className="glass p-5 rounded-xl group relative hover:bg-slate-800/80 transition-colors lang-bar-container"
                          >
                            {adminMode && (
                              <div className="absolute top-2 right-2 flex gap-1 z-20">
                                 <button onClick={() => moveItem("languages", idx, "up")} className="w-5 h-5 bg-slate-700 text-white rounded text-xs flex items-center justify-center">↑</button>
                                 <button onClick={() => moveItem("languages", idx, "down")} className="w-5 h-5 bg-slate-700 text-white rounded text-xs flex items-center justify-center">↓</button>
                                 <button className="w-5 h-5 bg-red-600 text-white rounded text-xs flex items-center justify-center" onClick={() => deleteItem("languages", lang.id)}>×</button>
                              </div>
                            )}
                            <div className="flex justify-between items-end mb-2">
                              <div>
                                <h3
                                  className={`font-bold text-lg ${
                                    adminMode ? "editable-highlight" : ""
                                  }`}
                                  onClick={() =>
                                    openEdit(
                                      `languages.${idx}.name`,
                                      lang.name,
                                      "text",
                                      "Language"
                                    )
                                  }
                                >
                                  {lang.name}
                                </h3>
                                <div className="flex gap-2 mt-1">
                                  {lang.media?.map((m, i) => (
                                    <button
                                      key={i}
                                      onClick={() =>
                                        handlePdfAccess(
                                          adminMode,
                                          m.url,
                                          m.name
                                        )
                                      }
                                      className="text-[10px] px-2 py-0.5 bg-slate-700 rounded text-cyan-300 hover:bg-slate-600"
                                    >
                                      Cert: {m.name}
                                    </button>
                                  ))}
                                  {adminMode && (
                                    <button
                                      onClick={() =>
                                        setMediaManager({
                                          open: true,
                                          targetId: lang.id,
                                          targetType: "languages",
                                          type: "pdfs",
                                        })
                                      }
                                      className="text-[10px] px-1 bg-slate-700 rounded text-green-400"
                                    >
                                      +
                                    </button>
                                  )}
                                </div>
                              </div>
                              <div className="text-right">
                                <span
                                  className={`text-cyan-400 font-bold ${
                                    adminMode ? "editable-highlight" : ""
                                  }`}
                                  onClick={() =>
                                    openEdit(
                                      `languages.${idx}.level`,
                                      lang.level,
                                      "text",
                                      "Level"
                                    )
                                  }
                                >
                                  {lang.level}
                                </span>
                                {/* Click to edit the percentage number */}
                                <span
                                  className={`text-xs text-slate-500 block ${
                                    adminMode ? "editable-highlight cursor-pointer" : ""
                                  }`}
                                  onClick={() => adminMode &&
                                    openEdit(
                                      `languages.${idx}.percentage`,
                                      lang.percentage,
                                      "text",
                                      "%"
                                    )
                                  }
                                >
                                  ({lang.percentage}%)
                                </span>
                              </div>
                            </div>
                            <div className="proficiency-bar w-full bg-slate-700 rounded-full h-2 overflow-hidden">
                              <div
                                className="proficiency-fill h-full rounded-full transition-all duration-1000 ease-out"
                                style={{
                                  width: '0%', // Forces animation to start from 0
                                  '--percent': `${lang.percentage}%`, // Passes the value to CSS
                                  background: `linear-gradient(90deg, ${theme.primaryColor}, ${theme.secondaryColor})`,
                                }}
                              ></div>
                            </div>
                          </div>
                        ))}
                        {adminMode && (
                          <button
                            onClick={() =>
                              setAddModal({ open: true, type: "languages" })
                            }
                            className="add-btn w-full"
                          >
                            ➕ Add Language
                          </button>
                        )}
                      </div>
                    </div>
                  </div>
                </section>

                {/* Contact with Planet Effect & Social Canvas */}
                <section
                  id="contact"
                  className="py-24 relative flex items-center justify-center"
                >
                  <div className="container mx-auto px-6 max-w-7xl">
                    <div className="grid lg:grid-cols-2 gap-16 items-center">
                      {/* LEFT: ADVANCED PLANET + TITLES */}
                      <div
                        className="h-[600px] relative flex flex-col justify-center"
                        data-aos="fade-right"
                      >
                        <div className="absolute top-0 w-full text-center lg:text-left z-10 pointer-events-none">
                          <h2
                            className={`text-5xl font-extrabold text-white mb-2 pointer-events-auto ${
                              adminMode ? "editable-highlight" : ""
                            }`}
                            onClick={() =>
                              openEdit(
                                "sectionHeaders.contactTitle",
                                data.sectionHeaders?.contactTitle,
                                "text",
                                "Title"
                              )
                            }
                          >
                            {data.sectionHeaders?.contactTitle}
                          </h2>
                          <p
                            className={`text-xl text-slate-400 pointer-events-auto ${
                              adminMode ? "editable-highlight" : ""
                            }`}
                            onClick={() =>
                              openEdit(
                                "sectionHeaders.contactSubtitle",
                                data.sectionHeaders?.contactSubtitle,
                                "text",
                                "Subtitle"
                              )
                            }
                          >
                            {data.sectionHeaders?.contactSubtitle}
                          </p>
                        </div>
                        {/* Advanced Saturn Scene from Asset */}
                        <AdvancedSaturn theme={theme} />
                      </div>

                      {/* RIGHT: CONTACT FORM */}
                      <div
                        className="glass p-8 lg:p-12 rounded-3xl shadow-2xl relative z-10"
                        data-aos="fade-left"
                      >
                        <div className="mb-8">
                          <div className="flex items-center gap-4 mb-4">
                            <div className="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center text-2xl text-cyan-400">
                              📍
                            </div>
                            <div>
                              <p className="text-sm text-slate-400">Location</p>
                              <p
                                className={`font-medium text-white text-lg ${
                                  adminMode ? "editable-highlight" : ""
                                }`}
                                onClick={() =>
                                  openEdit(
                                    "location",
                                    data.location,
                                    "text",
                                    "Location"
                                  )
                                }
                              >
                                {data.location}
                              </p>
                            </div>
                          </div>
                          <div className="flex items-center gap-4">
                            <div className="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center text-2xl text-cyan-400">
                              📧
                            </div>
                            <div>
                              <p className="text-sm text-slate-400">Email</p>
                              <p
                                className={`font-medium text-white text-lg ${
                                  adminMode ? "editable-highlight" : ""
                                }`}
                                onClick={() =>
                                  openEdit("email", data.email, "text", "Email")
                                }
                              >
                                {data.email}
                              </p>
                            </div>
                          </div>
                        </div>

                        <form
                          action={CONTACT_FORM_URL}
                          method="POST"
                          className="space-y-6"
                        >
                          <div>
                            <label className="text-sm font-bold text-slate-400 mb-2 block">
                              Name
                            </label>
                            <input
                              type="text"
                              name="name"
                              required
                              className="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-4 text-white focus:border-cyan-500 outline-none transition-all"
                              placeholder="Your Name"
                            />
                          </div>
                          <div>
                            <label className="text-sm font-bold text-slate-400 mb-2 block">
                              Email
                            </label>
                            <input
                              type="email"
                              name="email"
                              required
                              className="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-4 text-white focus:border-cyan-500 outline-none transition-all"
                              placeholder="your.email@example.com"
                            />
                          </div>
                          <div>
                            <label className="text-sm font-bold text-slate-400 mb-2 block">
                              Message
                            </label>
                            <textarea
                              name="message"
                              rows="4"
                              required
                              className="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-4 text-white focus:border-cyan-500 outline-none transition-all resize-none"
                              placeholder="Hello..."
                            ></textarea>
                          </div>
                          <button
                            type="submit"
                            className="btn-electric w-full py-4 rounded-xl font-bold text-white text-lg shadow-lg"
                          >
                            Send Message 🚀
                          </button>
                        </form>

                        {/* FREE CANVAS SOCIAL MEDIA MANAGER */}
                        <div className="mt-8 pt-8 border-t border-slate-700">
                          <div className="flex justify-between items-center mb-4">
                            <h4 className="text-sm text-slate-400 uppercase font-bold tracking-wider">
                              Connect with me
                            </h4>
                            {adminMode && (
                              <button
                                onClick={() =>
                                  setSocialModal({ open: true, editItem: null })
                                }
                                className="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded-full transition-colors"
                              >
                                + Add Icon
                              </button>
                            )}
                          </div>

                          <div
                            className={`draggable-canvas-container ${
                              adminMode
                                ? "border-dashed border-2 border-slate-600"
                                : "border-none bg-transparent"
                            }`}
                          >
                            {data.socialLinks?.map((link) => (
                              <DraggableItem
                                key={link.id}
                                x={link.x}
                                y={link.y}
                                s={link.scale || 1}
                                onUpdate={(x, y, s) =>
                                  updateSocialPosition(link.id, x, y, s)
                                }
                                isAdmin={adminMode}
                                tooltip={link.label}
                              >
                                <div className="relative group/icon">
                                  <a
                                    href={link.url}
                                    target="_blank"
                                    className={`social-icon-btn w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center text-xl transition-all shadow-lg border border-slate-700`}
                                    style={{
                                      color: link.color || theme.primaryColor,
                                    }}
                                  >
                                    {link.imageSrc ? (
                                      <img
                                        src={link.imageSrc}
                                        alt={link.label}
                                        className="w-full h-full object-cover rounded-full"
                                      />
                                    ) : (
                                      <i className={link.icon}></i>
                                    )}
                                  </a>
                                  {adminMode && (
                                    <>
                                      <div
                                        className="icon-edit-overlay bg-blue-500"
                                        style={{ right: 35 }}
                                        onClick={(e) => {
                                          e.preventDefault();
                                          e.stopPropagation();
                                          setSocialModal({
                                            open: true,
                                            editItem: link,
                                          });
                                        }}
                                      >
                                        ✎
                                      </div>
                                      <div
                                        className="icon-edit-overlay bg-red-500"
                                        onClick={(e) => {
                                          e.preventDefault();
                                          e.stopPropagation();
                                          deleteSocial(link.id);
                                        }}
                                      >
                                        ×
                                      </div>
                                    </>
                                  )}
                                </div>
                              </DraggableItem>
                            ))}
                            {adminMode && data.socialLinks?.length === 0 && (
                              <div className="absolute inset-0 flex items-center justify-center text-slate-500 pointer-events-none">
                                Drag & Drop Canvas Area (Empty)
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </section>
              </main>
              
              {/* === NEW: VISITOR STATS COUNTER (3D Dashboard) === */}
              <section className="py-24 relative z-20 overflow-hidden">
                {/* 1. Background Glow Effect behind the dashboard */}
                <div 
                  className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[80%] h-[300px] opacity-20 blur-[120px] rounded-full pointer-events-none"
                  style={{ background: 'var(--primary-color)' }}
                ></div>
                
                {/* 2. The Dashboard Component */}
                <div className="container mx-auto px-6 relative">
                  <StatsDisplay 
                     visitors={data.stats.visitors} 
                     views={data.stats.views} 
                     active={data.stats.active} 
                     appreciations={data.stats.appreciations} 
                  />
                </div>
              </section>

              {/* Footer */}
              <footer className="py-12 text-center glass mt-16 relative z-10">
                <p className="text-slate-400 mb-2">
                  © {new Date().getFullYear()} {data.name}. All rights reserved.
                </p>
                <p
                  className={`text-slate-500 text-sm ${
                    adminMode ? "editable-highlight" : ""
                  }`}
                  onClick={() =>
                    openEdit("footerText", data.footerText, "text", "Footer")
                  }
                >
                  {data.footerText}
                </p>
              </footer>

              {/* Settings */}
              <div className="settings-wheel">
                <SettingsPanel
                  isOpen={settingsOpen}
                  theme={theme}
                  setTheme={setTheme}
                />
                <button
                  className="settings-btn"
                  onClick={() => setSettingsOpen(!settingsOpen)}
                  style={{ color: theme.primaryColor }}
                >
                  {settingsOpen ? "✕" : "⚙️"}
                </button>
              </div>
            </div>
          </ThemeContext.Provider>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
